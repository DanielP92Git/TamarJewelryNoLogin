---
phase: 23-foundation-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - backend/middleware/language.js
  - backend/index.js
autonomous: true

must_haves:
  truths:
    - "URL prefix /en/ or /he/ determines page language and direction"
    - "Root URL / redirects to /en or /he based on language detection"
    - "Invalid language prefix (e.g., /fr/about) redirects to /en equivalent"
    - "Language preference cookie stores both lang and currency"
    - "Cookie preference is set on first visit and language switch"
    - "Hebrew defaults to ILS, English defaults to USD"
    - "Trailing slashes are normalized (redirect /about/ to /about)"
  artifacts:
    - path: "backend/middleware/language.js"
      provides: "Language detection, URL prefix extraction, cookie persistence, trailing slash normalization"
      exports: ["languageMiddleware", "detectLanguage", "trailingSlashRedirect"]
  key_links:
    - from: "backend/middleware/language.js"
      to: "backend/config/locale.js"
      via: "resolveRequestLocale for GeoIP/header detection"
      pattern: "require.*config/locale"
    - from: "backend/index.js"
      to: "backend/middleware/language.js"
      via: "app.use() registration"
      pattern: "require.*middleware/language"
---

<objective>
Create bilingual URL routing middleware that extracts language from URL prefix, detects language for root redirects, persists preferences in cookies, and normalizes trailing slashes.

Purpose: This is the core routing infrastructure for bilingual SEO. Every SSR page in Phases 24-26 depends on req.lang and req.dir being set by this middleware. The cookie system enables returning visitors to go straight to their preferred language/currency combination.
Output: Language middleware module + root redirect handler + cookie persistence + trailing slash normalization, all wired into Express.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-foundation-infrastructure/23-RESEARCH.md
@.planning/phases/23-foundation-infrastructure/23-01-SUMMARY.md
@backend/config/locale.js
@backend/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create language middleware module</name>
  <files>backend/middleware/language.js</files>
  <action>
  Create `backend/middleware/language.js` with three exports:

  **1. detectLanguage(req)** — Multi-tier language detection:
  Priority order (per research): cookie > CDN headers > GeoIP > Accept-Language > default (en)
  - Check `req.cookies.locale_pref` for a JSON object with `lang` field. Parse safely with try/catch. Only accept 'en' or 'he'.
  - If no valid cookie, use existing `resolveRequestLocale(req)` from `../config/locale.js`. Map the returned `lang` field ('en' or 'he') directly.
  - Default: 'en'

  **2. trailingSlashRedirect(req, res, next)** — Middleware:
  - If `req.path !== '/'` and `req.path.endsWith('/')`: redirect 301 to path without trailing slash (preserve query string via `req.url.slice(req.path.length)`)
  - Otherwise: `next()`

  **3. languageMiddleware(req, res, next)** — Middleware for /:lang/* routes:
  - Extract language from URL: `req.path.match(/^\/(en|he)(?:\/|$)/)`
  - If no match and path starts with a 2-letter prefix like /fr/, /de/: redirect 301 to `/en` + rest of path (per locked decision: invalid prefix redirects to /en equivalent)
  - If valid match: set `req.lang = urlLang`, `req.dir = urlLang === 'he' ? 'rtl' : 'ltr'`
  - Update cookie preference when user navigates to a language URL (implicit preference change): set `locale_pref` cookie with `{ lang: urlLang, currency: urlLang === 'he' ? 'ILS' : 'USD' }` BUT only if no existing cookie or if existing cookie has different lang. Do NOT overwrite currency if cookie already exists with same lang (respects manual currency override per locked decision).
  - Cookie settings: `maxAge: 30 * 24 * 60 * 60 * 1000`, `httpOnly: false` (client JS needs access for currency switching), `sameSite: 'lax'`
  - Call `next()`

  The middleware should NOT apply to /api/*, /health, /uploads, /images, /public, /admin paths — only to routes that will be SSR pages. Export functions individually so they can be selectively applied.

  Use `const { resolveRequestLocale } = require('../config/locale');` for the GeoIP/header fallback.
  </action>
  <verify>`cd backend && node -e "const m = require('./middleware/language'); console.log(typeof m.detectLanguage, typeof m.languageMiddleware, typeof m.trailingSlashRedirect)"` should print "function function function".</verify>
  <done>Language middleware module exports detectLanguage, languageMiddleware, and trailingSlashRedirect — all three functions work correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Wire language middleware and root redirect into Express</name>
  <files>backend/index.js</files>
  <action>
  In backend/index.js:

  1. Add require at top: `const { detectLanguage, languageMiddleware, trailingSlashRedirect } = require('./middleware/language');`

  2. Add trailing slash normalization EARLY in the middleware chain (before any route handlers, after helmet/cors/cookieParser):
     ```javascript
     app.use(trailingSlashRedirect);
     ```

  3. Add root URL redirect handler (BEFORE the /:lang/test route from Plan 01):
     ```javascript
     // Root redirect: detect language and redirect to /en or /he
     app.get('/', (req, res) => {
       const lang = detectLanguage(req);
       const currency = lang === 'he' ? 'ILS' : 'USD';

       // Set cookie for future visits (per locked decision: stores both lang and currency)
       if (!req.cookies.locale_pref) {
         res.cookie('locale_pref', JSON.stringify({ lang, currency }), {
           maxAge: 30 * 24 * 60 * 60 * 1000,
           httpOnly: false,
           sameSite: 'lax'
         });
       }

       // 302 temporary redirect (user preference may change)
       res.redirect(302, `/${lang}`);
     });
     ```

  4. Apply language middleware to all /:lang/* routes. Update the existing test route from Plan 01 to use the middleware:
     ```javascript
     // Apply language middleware to all bilingual routes
     app.use('/:lang(en|he)', languageMiddleware);
     ```
     Then simplify the test route to use req.lang/req.dir instead of parsing params:
     ```javascript
     app.get('/:lang(en|he)/test', (req, res) => {
       res.render('pages/test', {
         lang: req.lang,
         dir: req.dir,
         title: req.lang === 'en' ? 'Test Page' : 'עמוד בדיקה',
         path: '/test'
       });
     });
     ```

  5. Add catch-all for invalid language prefixes (AFTER all valid routes, BEFORE 404 handler):
     ```javascript
     // Invalid language prefix redirect (e.g., /fr/about -> /en/about)
     app.get('/:lang([a-z]{2})/*', (req, res) => {
       const restOfPath = req.params[0] || '';
       res.redirect(301, `/en/${restOfPath}`);
     });
     app.get('/:lang([a-z]{2})', (req, res) => {
       res.redirect(301, '/en');
     });
     ```

  IMPORTANT: Place these new routes BEFORE any existing catch-all or 404 handlers, but AFTER all /api/* routes. The language routes must not interfere with existing API endpoints.
  </action>
  <verify>
  Start the dev server. Test with curl:
  - `curl -s -o /dev/null -w "%{http_code} %{redirect_url}" http://localhost:PORT/` — should return 302 to /en or /he
  - `curl -s -o /dev/null -w "%{http_code} %{redirect_url}" http://localhost:PORT/fr/about` — should return 301 to /en/about
  - `curl -s -o /dev/null -w "%{http_code} %{redirect_url}" http://localhost:PORT/en/test/` — should return 301 to /en/test (trailing slash removed)
  - `curl -s http://localhost:PORT/en/test` — should return HTML with lang="en"
  - Existing tests pass: `cd backend && npm test`
  </verify>
  <done>Root / redirects to detected language. Language middleware sets req.lang and req.dir on all /:lang/* routes. Invalid prefixes redirect to /en. Trailing slashes are normalized. Cookie is set with lang+currency on first visit. All existing tests pass.</done>
</task>

</tasks>

<verification>
1. `curl localhost:PORT/` redirects to `/en` or `/he` (302)
2. `curl localhost:PORT/en/test` returns HTML with `lang="en" dir="ltr"`
3. `curl localhost:PORT/he/test` returns HTML with `lang="he" dir="rtl"`
4. `curl localhost:PORT/fr/about` redirects to `/en/about` (301)
5. `curl localhost:PORT/en/test/` redirects to `/en/test` (301, trailing slash removed)
6. Response headers include `Set-Cookie: locale_pref` with lang and currency
7. `cd backend && npm test` — all existing tests pass
</verification>

<success_criteria>
- / redirects to /en or /he based on cookie > CDN > GeoIP > Accept-Language > default
- /:lang/* routes have req.lang and req.dir set correctly
- Invalid language prefix /fr/* redirects to /en/* with 301
- Trailing slashes redirect to non-trailing with 301
- Cookie locale_pref stores {lang, currency} with 30-day expiry
- Hebrew defaults to ILS, English defaults to USD
- Manual currency override is preserved (cookie not overwritten if same lang)
- All 419 existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-foundation-infrastructure/23-03-SUMMARY.md`
</output>
