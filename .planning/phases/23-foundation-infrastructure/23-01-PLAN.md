---
phase: 23-foundation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/views/layouts/main.ejs
  - backend/views/partials/header.ejs
  - backend/views/partials/footer.ejs
  - backend/views/pages/test.ejs
  - backend/index.js
autonomous: true

must_haves:
  truths:
    - "EJS view engine is configured and rendering templates"
    - "Visiting /en/test or /he/test renders a page with correct lang and dir attributes"
    - "Layout template wraps page content with shared header/footer"
  artifacts:
    - path: "backend/views/layouts/main.ejs"
      provides: "Base HTML layout with lang/dir attributes"
      contains: "lang=\"<%= lang %>\""
    - path: "backend/views/partials/header.ejs"
      provides: "Shared site header partial"
    - path: "backend/views/partials/footer.ejs"
      provides: "Shared site footer partial"
    - path: "backend/views/pages/test.ejs"
      provides: "Test page for verifying SSR pipeline"
  key_links:
    - from: "backend/index.js"
      to: "backend/views/"
      via: "app.set('view engine', 'ejs')"
      pattern: "set\\('view engine'"
    - from: "backend/index.js"
      to: "backend/views/pages/test.ejs"
      via: "res.render('pages/test')"
      pattern: "res\\.render\\('pages/test'"
---

<objective>
Configure Express with EJS view engine, create the layout/partial template structure, and wire up a bilingual test route that proves SSR rendering works with correct lang and dir attributes.

Purpose: Establishes the template rendering foundation that all SSR pages in Phases 23-26 build on. Without this, no server-rendered page can be served.
Output: Working EJS configuration, layout template with lang/dir, header/footer partials, test page at /en/test and /he/test.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-foundation-infrastructure/23-RESEARCH.md
@backend/index.js
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install EJS and configure view engine in Express</name>
  <files>backend/package.json, backend/index.js</files>
  <action>
  1. Install EJS: `cd backend && npm install ejs`
  2. In backend/index.js, near the top after existing requires, add:
     ```
     app.set('view engine', 'ejs');
     app.set('views', path.join(__dirname, 'views'));
     ```
  3. Enable view caching in production:
     ```
     if (process.env.NODE_ENV === 'production') {
       app.set('view cache', true);
     }
     ```
  4. Add a test route BEFORE the existing API routes but AFTER middleware setup (after the cors/cookieParser/helmet section around line 687):
     ```
     // SSR test route — validates EJS rendering pipeline
     app.get('/:lang/test', (req, res) => {
       const lang = req.params.lang;
       if (!['en', 'he'].includes(lang)) {
         return res.redirect(301, '/en/test');
       }
       const dir = lang === 'he' ? 'rtl' : 'ltr';
       res.render('pages/test', {
         lang,
         dir,
         title: lang === 'en' ? 'Test Page' : 'עמוד בדיקה',
         path: '/test'
       });
     });
     ```

  Place the view engine config lines right after the existing `const app = express();` line (or wherever the app is created). The path module is already imported.

  Do NOT move or restructure any existing routes or middleware — only add new lines.
  </action>
  <verify>Run `cd backend && node -e "require('./index.js')"` with NODE_ENV=test to confirm no syntax errors. Check that 'ejs' appears in package.json dependencies.</verify>
  <done>EJS is installed, view engine is configured, and a test route exists at /:lang/test that renders an EJS template.</done>
</task>

<task type="auto">
  <name>Task 2: Create EJS layout, partials, and test page templates</name>
  <files>backend/views/layouts/main.ejs, backend/views/partials/header.ejs, backend/views/partials/footer.ejs, backend/views/pages/test.ejs</files>
  <action>
  1. Create directory structure: `backend/views/layouts/`, `backend/views/partials/`, `backend/views/pages/`, `backend/views/errors/`

  2. Create `backend/views/layouts/main.ejs` — the base HTML layout:
     ```ejs
     <!DOCTYPE html>
     <html lang="<%= lang %>" dir="<%= dir %>">
     <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title><%= title %> | Tamar Kfir Jewelry</title>
     </head>
     <body>
       <%- include('../partials/header', { lang, dir }) %>
       <main>
         <%- body %>
       </main>
       <%- include('../partials/footer', { lang }) %>
     </body>
     </html>
     ```
     Note: This layout is included manually by page templates (no express-ejs-layouts dependency). Page templates will use `<%- include('../layouts/main', { ...locals, body: bodyContent }) %>` pattern OR we use a simpler approach: the test route renders `pages/test.ejs` which includes layout components directly.

     REVISED APPROACH (simpler, no layout middleware needed): Each page template is self-contained, including header/footer partials. The main.ejs layout file serves as documentation/reference for Phase 24 when express-ejs-layouts may be added. For now, pages directly include partials.

  3. Create `backend/views/partials/header.ejs`:
     ```ejs
     <header>
       <nav>
         <a href="/<%= lang %>/">Tamar Kfir Jewelry</a>
       </nav>
     </header>
     ```
     Minimal placeholder — Phase 24 will build the full header with navigation, language switcher, cart icon.

  4. Create `backend/views/partials/footer.ejs`:
     ```ejs
     <footer>
       <p>&copy; <%= new Date().getFullYear() %> Tamar Kfir Jewelry</p>
     </footer>
     ```

  5. Create `backend/views/pages/test.ejs` — the SSR verification page:
     ```ejs
     <!DOCTYPE html>
     <html lang="<%= lang %>" dir="<%= dir %>">
     <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title><%= title %> | Tamar Kfir Jewelry</title>
     </head>
     <body>
       <%- include('../partials/header', { lang, dir }) %>
       <main>
         <h1><%= title %></h1>
         <p data-testid="lang-check">Language: <%= lang %></p>
         <p data-testid="dir-check">Direction: <%= dir %></p>
         <p>This page verifies the EJS rendering pipeline is working correctly.</p>
       </main>
       <%- include('../partials/footer', { lang }) %>
     </body>
     </html>
     ```

  This test page satisfies Success Criteria #1: "Visiting /en/test or /he/test serves an EJS-rendered page with correct lang and dir HTML attributes."
  </action>
  <verify>
  Start the server with `cd backend && NODE_ENV=test node -e "const app = require('./index.js'); // verify no template errors"`.
  Then use curl or supertest to verify: `curl http://localhost:PORT/en/test` should return HTML with `lang="en" dir="ltr"` and `curl http://localhost:PORT/he/test` should return HTML with `lang="he" dir="rtl"`.
  </verify>
  <done>Layout structure exists under backend/views/ with header/footer partials. Test page at /en/test renders with lang="en" dir="ltr" and /he/test renders with lang="he" dir="rtl".</done>
</task>

</tasks>

<verification>
1. `ls backend/views/layouts/main.ejs backend/views/partials/header.ejs backend/views/partials/footer.ejs backend/views/pages/test.ejs` — all files exist
2. `grep "view engine" backend/index.js` — EJS configured
3. `grep "ejs" backend/package.json` — dependency installed
4. Start server, visit /en/test — HTML contains `lang="en" dir="ltr"`
5. Start server, visit /he/test — HTML contains `lang="he" dir="rtl"`
6. Existing tests still pass: `cd backend && npm test`
</verification>

<success_criteria>
- EJS is installed and configured as Express view engine
- views/ directory has layouts/, partials/, pages/, errors/ subdirectories
- /en/test returns HTML with lang="en" dir="ltr" in the html tag
- /he/test returns HTML with lang="he" dir="rtl" in the html tag
- All 419 existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-foundation-infrastructure/23-01-SUMMARY.md`
</output>
