---
phase: 23-foundation-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["23-03"]
files_modified:
  - backend/middleware/legacy.js
  - backend/index.js
autonomous: true

must_haves:
  truths:
    - "Visiting any old .html path returns a 301 redirect to the corresponding new clean URL"
    - "Legacy redirects include language prefix based on visitor's language detection"
    - "Unmatched .html paths return 404 (not infinite redirect loops)"
  artifacts:
    - path: "backend/middleware/legacy.js"
      provides: "Legacy URL mapping and redirect middleware"
      exports: ["legacyRedirectMiddleware"]
  key_links:
    - from: "backend/middleware/legacy.js"
      to: "backend/middleware/language.js"
      via: "detectLanguage for redirect target"
      pattern: "require.*middleware/language"
    - from: "backend/index.js"
      to: "backend/middleware/legacy.js"
      via: "app.use() early in chain"
      pattern: "require.*middleware/legacy"
---

<objective>
Create legacy URL redirect middleware that maps all old .html paths to new clean bilingual URLs with 301 permanent redirects.

Purpose: Preserves SEO authority from existing indexed pages and prevents broken bookmarks when the site transitions from .html paths to clean URLs. 301 redirects pass ~95% of link equity to the new URLs.
Output: Legacy redirect middleware with complete URL mapping for all 13 known routes (5 pages + 7 categories + home).
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-foundation-infrastructure/23-RESEARCH.md
@.planning/phases/23-foundation-infrastructure/23-03-SUMMARY.md
@backend/middleware/language.js
@backend/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create legacy URL redirect middleware</name>
  <files>backend/middleware/legacy.js</files>
  <action>
  Create `backend/middleware/legacy.js`:

  1. Import detectLanguage from `./language.js`

  2. Define the complete legacy URL map based on the codebase analysis. The old paths come from frontend/html/ directory structure:

     ```javascript
     const legacyUrlMap = {
       // Home page (index.html at root or /html/)
       '/index.html': '/',
       '/html/index.html': '/',

       // Static pages
       '/html/about.html': '/about',
       '/html/cart.html': '/cart',
       '/html/contact-me.html': '/contact',
       '/html/policies.html': '/policies',
       '/html/jewelry-workshop.html': '/workshop',

       // Category pages
       '/html/categories/necklaces.html': '/necklaces',
       '/html/categories/crochetNecklaces.html': '/crochet-necklaces',
       '/html/categories/hoops.html': '/hoops',
       '/html/categories/dangle.html': '/dangle',
       '/html/categories/bracelets.html': '/bracelets',
       '/html/categories/unisex.html': '/unisex',
       '/html/categories/shalom-club.html': '/shalom-club',
     };
     ```

     Note: Category URLs are top-level (not /categories/necklaces) for cleaner, shorter URLs. Per research, English slugs for both languages.

  3. Export `legacyRedirectMiddleware(req, res, next)`:
     - Check `req.path` against `legacyUrlMap` (case-insensitive match — normalize to lowercase)
     - If match found:
       - Detect language via `detectLanguage(req)`
       - For home page redirect ('/' target): redirect to `/${lang}`
       - For other pages: redirect to `/${lang}${cleanPath}`
       - Use 301 status (permanent redirect)
     - If path ends in `.html` but NOT in the map: return 404 (not a redirect loop). Use `next()` to fall through to the eventual 404 handler.
     - If no `.html` extension: call `next()` immediately (not a legacy path)

  4. Also handle case-insensitive matching: lowercase req.path before map lookup, since some old URLs may have mixed case.
  </action>
  <verify>`cd backend && node -e "const m = require('./middleware/legacy'); console.log(typeof m.legacyRedirectMiddleware === 'function' ? 'OK' : 'FAIL')"` should print "OK".</verify>
  <done>Legacy redirect middleware maps all 13 known .html paths to clean URLs with language prefix. Unknown .html paths fall through to 404.</done>
</task>

<task type="auto">
  <name>Task 2: Wire legacy redirect middleware into Express</name>
  <files>backend/index.js</files>
  <action>
  In backend/index.js:

  1. Add require: `const { legacyRedirectMiddleware } = require('./middleware/legacy');`

  2. Register the middleware EARLY in the chain — AFTER cookieParser (needed for detectLanguage cookie check) but BEFORE the language middleware and SSR routes. Specifically, place it after the trailing slash redirect and before the root redirect handler:

     ```javascript
     // Legacy .html redirects (must be before SSR routes)
     app.use(legacyRedirectMiddleware);
     ```

  The order should be:
  1. cors, cookieParser, helmet, etc. (existing)
  2. trailingSlashRedirect (from Plan 03)
  3. legacyRedirectMiddleware (this plan)
  4. Root redirect / (from Plan 03)
  5. Language middleware /:lang/* (from Plan 03)
  6. SSR routes (future phases)
  7. API routes (existing)

  This placement ensures:
  - Cookies are parsed before legacy middleware runs (for language detection)
  - Legacy paths are caught before falling through to SSR or API routes
  - The middleware does NOT interfere with /api/*, /health, /uploads, etc. because those paths don't end in .html
  </action>
  <verify>
  Start the dev server. Test with curl:
  - `curl -s -o /dev/null -w "%{http_code} %{redirect_url}" http://localhost:PORT/html/about.html` — should return 301 to /en/about (or /he/about)
  - `curl -s -o /dev/null -w "%{http_code} %{redirect_url}" http://localhost:PORT/html/categories/necklaces.html` — should return 301 to /en/necklaces
  - `curl -s -o /dev/null -w "%{http_code}" http://localhost:PORT/html/nonexistent.html` — should NOT redirect (falls through)
  - `curl -s -o /dev/null -w "%{http_code}" http://localhost:PORT/api/locale` — should still work (200)
  - Existing tests pass: `cd backend && npm test`
  </verify>
  <done>Legacy redirect middleware is wired into Express, /html/about.html returns 301 to /en/about, /html/categories/necklaces.html returns 301 to /en/necklaces, and all existing API routes and tests continue working.</done>
</task>

</tasks>

<verification>
1. `curl -v http://localhost:PORT/html/about.html` — 301 redirect to `/en/about`
2. `curl -v http://localhost:PORT/html/categories/necklaces.html` — 301 redirect to `/en/necklaces`
3. `curl -v http://localhost:PORT/html/categories/crochetNecklaces.html` — 301 redirect to `/en/crochet-necklaces`
4. `curl -v http://localhost:PORT/index.html` — 301 redirect to `/en`
5. `curl -v http://localhost:PORT/html/nonexistent.html` — no redirect (falls through)
6. `curl -v http://localhost:PORT/api/locale` — still works (200)
7. `cd backend && npm test` — all tests pass
</verification>

<success_criteria>
- All 13 known legacy .html paths redirect with 301 to corresponding clean URLs with language prefix
- Language prefix is determined by cookie > CDN > GeoIP > Accept-Language > default (en)
- Unknown .html paths fall through (no infinite redirects)
- Non-.html paths (API, static assets) are unaffected
- All 419 existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-foundation-infrastructure/23-04-SUMMARY.md`
</output>
