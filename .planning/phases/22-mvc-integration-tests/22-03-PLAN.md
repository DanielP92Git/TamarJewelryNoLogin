---
phase: 22-mvc-integration-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tests/integration/lifecycle.test.js
autonomous: true

must_haves:
  truths:
    - "View.setLanguage() re-renders menu without accumulating duplicate event listeners"
    - "Rapid language switching (5-10 times) does not cause duplicate handlers"
    - "Flag click handlers fire exactly once per click after multiple re-renders"
    - "Currency event delegation fires exactly once per change after multiple setLanguage calls"
    - "View correctly initializes DOM elements on mount"
    - "Async operations (handleLoadStorage) complete before view renders"
  artifacts:
    - path: "frontend/tests/integration/lifecycle.test.js"
      provides: "View lifecycle and cleanup integration tests"
      min_lines: 150
  key_links:
    - from: "view.setLanguage()"
      to: "menu.innerHTML = this.handleMenuLanguage(lng)"
      via: "innerHTML replacement destroys old listeners"
      pattern: "menu\\.innerHTML"
    - from: "view.setLanguage()"
      to: "flag-icon click handlers"
      via: "addEventListener after innerHTML replacement"
      pattern: "flag\\.addEventListener"
    - from: "categoriesTab cloneNode(true)"
      to: "old element replaced, old listeners removed"
      via: "parentNode.replaceChild pattern"
      pattern: "cloneNode\\(true\\)"
---

<objective>
Test that view lifecycle methods (mount, update, unmount-equivalent) execute correctly, and that event listeners are properly cleaned up during navigation and re-renders to prevent memory leaks.

Purpose: Validates the lifecycle management of the MVC architecture. Views re-render frequently (language switches, currency changes) and must not accumulate duplicate event listeners or leave stale DOM elements.

Output: frontend/tests/integration/lifecycle.test.js with lifecycle and cleanup tests.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@frontend/js/View.js (setLanguage, handleMenuLanguage, svgHandler, cloneNode patterns)
@frontend/js/controller.js (init, controlXxxPage functions)
@frontend/js/model.js (handleLoadStorage, checkCartNumber)
@frontend/tests/setup.js
@frontend/tests/helpers/dom.js

Critical prior work:
@frontend/tests/view/cleanup.test.js (behavioral verification patterns for listener cleanup)

Key decisions from Phase 19-04:
- Use behavioral verification (spy on methods, count events) since Happy-DOM lacks getEventListeners API
- Spy on view.changeToHeb/changeToEng methods to detect handler accumulation
- Test observable outcomes (single action per user interaction) to prove cleanup works correctly
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lifecycle and cleanup integration tests</name>
  <files>frontend/tests/integration/lifecycle.test.js</files>
  <action>
Create integration tests verifying view lifecycle correctness. These tests go BEYOND the unit-level cleanup tests in 19-04 by testing cleanup behavior in realistic multi-view, multi-operation scenarios.

**IMPORTANT PATTERNS from Phase 19-04:**
- Happy-DOM lacks `getEventListeners()` -- use behavioral verification
- Spy on `view.changeToHeb`/`view.changeToEng` to detect handler accumulation
- Test observable outcomes (single action per click) rather than internal state
- `view.setLanguage()` replaces menu innerHTML (destroys old DOM nodes and their listeners)
- CategoriesTab uses `cloneNode(true)` + `replaceChild` to remove old listeners

**Test structure:**

1. `describe('MVC Integration: Lifecycle and Cleanup')` - Top-level

2. `describe('View mount initialization')` -- MVC-06
   - beforeEach: render base fixture (header, menu, header-utilities, footer, go-to-top), mock IntersectionObserver, mock matchMedia, mock process.env
   - `it('should initialize menu with correct language on first mount')`:
     - Import a view (e.g., homePageView), call setLanguage('eng', 0)
     - Verify menu element has child `ul.ul-eng`
     - Verify header-utilities has content (language flags, currency selector, cart icon)
   - `it('should initialize footer with correct language on first mount')`:
     - Call setLanguage('eng', 0)
     - Verify footer has English content ('Home', 'About', 'Contact Me')
   - `it('should initialize flag click handlers on mount')`:
     - Call setLanguage('eng', 0)
     - Click the Hebrew flag (.flag-heb inside .desktop-lang-selector)
     - Spy on view's changeToHeb method BEFORE setLanguage
     - Verify spy was called once
   - `it('should initialize currency selector on mount')`:
     - Call setLanguage('eng', 0)
     - Verify currency selector exists with USD/ILS options

3. `describe('View update lifecycle')` -- MVC-07
   - `it('should replace menu content entirely on language switch')`:
     - Call setLanguage('eng', 0), verify .ul-eng exists
     - Call setLanguage('heb', 0), verify .ul-eng is gone and .ul-heb exists
   - `it('should replace footer content on language switch')`:
     - setLanguage('eng', 0), verify English footer
     - setLanguage('heb', 0), verify Hebrew footer, old English content gone
   - `it('should update cart number on re-render')`:
     - setLanguage('eng', 0), verify cart badge shows 0
     - setLanguage('eng', 5), verify cart badge shows 5
   - `it('should re-create header utilities with correct content after update')`:
     - setLanguage('eng', 0), verify utilities exist
     - setLanguage('heb', 0), verify utilities still exist with updated content

4. `describe('Event listener cleanup on re-render')` -- MVC-08
   CRITICAL: These tests verify NO DUPLICATE HANDLERS accumulate across multiple re-renders.

   - `it('should not accumulate flag click handlers after 5 language switches')`:
     - Create spy on view.changeToHeb before any setLanguage call
     - Call setLanguage('eng', 0) five times (simulating 5 re-renders)
     - Find the Hebrew flag element in desktop-lang-selector
     - Click it once
     - Verify spy was called exactly once (not 5 times)

   - `it('should not accumulate flag click handlers after alternating eng/heb 5 times')`:
     - Spy on view.changeToHeb
     - Alternate: setLanguage('eng',0), setLanguage('heb',0) x 5
     - Click Hebrew flag once
     - Verify spy called exactly once

   - `it('should fire currency change event exactly once after multiple re-renders')`:
     - Call setLanguage('eng', 0) three times
     - Track CustomEvent 'currency-changed' fires with a spy on window.dispatchEvent or addEventListener
     - Change currency selector value and dispatch 'change' event
     - Verify currency-changed CustomEvent fires exactly once (event delegation pattern)

   - `it('should replace categories tab element via cloneNode on each re-render')`:
     - Render fixture with categories-tab element
     - Call setLanguage('eng', 0) twice
     - Get the current categories-tab element
     - Verify it is in the document (document.contains returns true)
     - The key insight: innerHTML replacement creates new .categories-tab, so old one is gone

   - `it('should handle 10 rapid language switches without degradation')`:
     - Loop: setLanguage('eng', 0), setLanguage('heb', 0) x 5
     - After all 10 switches, verify:
       a. Menu renders correctly (has either .ul-eng or .ul-heb, not both)
       b. Footer renders correctly
       c. Cart badge still shows correct number
       d. No console errors (spy on console.error)

5. `describe('Async lifecycle')` -- Async operations during init
   - `it('should complete handleLoadStorage before view renders in controller sequence')`:
     - Mock model.handleLoadStorage to track call order
     - Mock model.checkCartNumber to track call order
     - Execute the controller sequence manually: await handleLoadStorage, await checkCartNumber, then setLanguage
     - Verify handleLoadStorage called before checkCartNumber, checkCartNumber called before setLanguage

   - `it('should handle handleLoadStorage failure gracefully')`:
     - Mock model.handleLoadStorage to reject with error
     - Wrap in try-catch (as controller does), verify no crash
     - Verify view can still be initialized after storage failure

   - `it('should handle checkCartNumber failure gracefully')`:
     - Mock model.checkCartNumber to reject
     - Verify view initializes with default cart number (0)

**Target: ~15-18 tests total**

Use the same view instance for all tests (any View subclass works since lifecycle methods are on the base View class). homePageView or AboutView are good choices since they have minimal page-specific DOM requirements.

Mock IntersectionObserver as:
```javascript
global.IntersectionObserver = vi.fn(() => ({
  observe: vi.fn(),
  unobserve: vi.fn(),
  disconnect: vi.fn()
}));
```

Mock window.matchMedia as:
```javascript
window.matchMedia = vi.fn(() => ({
  matches: true, // desktop mode
  addListener: vi.fn(),
  removeListener: vi.fn(),
  addEventListener: vi.fn(),
  removeEventListener: vi.fn()
}));
```
  </action>
  <verify>`cd frontend && npx vitest run tests/integration/lifecycle.test.js --reporter=verbose` -- all tests pass with 0 failures AND output includes at least one test name containing "accumulate" or "duplicate" (proving behavioral cleanup tests are present and passing)</verify>
  <done>lifecycle.test.js has 15+ passing tests. Mount initialization verified for menu, footer, flags, currency. Update lifecycle verified for content replacement. Cleanup verified: no duplicate handlers after rapid switching (behavioral verification via spy call counts). Async lifecycle verified. Requirements MVC-06, MVC-07, MVC-08 verified.</done>
</task>

</tasks>

<verification>
```bash
cd frontend && npx vitest run tests/integration/lifecycle.test.js --reporter=verbose
```
- All tests pass
- Rapid switching tests (5-10 iterations) prove no handler accumulation
- Behavioral cleanup tests confirm spy called exactly once (not N times) after N re-renders
- Async lifecycle tests prove correct initialization order
- No regressions: `cd frontend && npx vitest run --reporter=verbose`
</verification>

<success_criteria>
- MVC-06: View mount lifecycle initializes event listeners (verified by flag clicks working after mount)
- MVC-07: View update lifecycle refreshes DOM with new data (verified by menu/footer content replacement)
- MVC-08: View cleanup prevents duplicate listeners (verified by behavioral testing -- single action per click after N re-renders)
- Rapid navigation (5-10 switches) tested and proven safe
- All existing 315+ tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-mvc-integration-tests/22-03-SUMMARY.md`
</output>
