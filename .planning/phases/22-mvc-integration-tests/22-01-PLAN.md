---
phase: 22-mvc-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tests/integration/routing.test.js
autonomous: true

must_haves:
  truths:
    - "Controller init() dispatches to correct handler for each body.id value using MPA body.id-based dispatch (NOT hash-fragment SPA routing -- each page is a separate HTML file with a unique body.id)"
    - "Each controller function loads storage, gets cart number, and initializes its view"
    - "Unknown or empty body.id does not crash the application"
    - "All 7 page types (home, workshop, about, contact, policies, cart, categories) route correctly"
    - "Each page's addXxxHandler method registers the controller callback function as part of the dispatch chain (e.g., homePageView.addHomePageHandler(controlHomePage))"
  artifacts:
    - path: "frontend/tests/integration/routing.test.js"
      provides: "Controller routing and page dispatch integration tests"
      min_lines: 150
  key_links:
    - from: "frontend/js/controller.js init()"
      to: "controlHomePage, controlWorkshopPage, controlAboutPage, etc."
      via: "document.body.id.includes() checks"
      pattern: "body\\.id\\.includes\\("
    - from: "controlXxxPage functions"
      to: "View.setLanguage()"
      via: "await model.handleLoadStorage() then view.setLanguage(lng, cartNum)"
      pattern: "setLanguage\\(lng"
    - from: "view.addXxxHandler(controlXxxPage)"
      to: "controlXxxPage function"
      via: "handler registration binds controller to view"
      pattern: "addHomePageHandler|addWorkshopPageHandler|addAboutHandler"
---

<objective>
Test that controller.js init() correctly dispatches to the right controller function based on document.body.id, and that each controller function properly initializes its corresponding view.

Purpose: Validates the top-level routing/dispatch layer of the MVC architecture -- the entry point that connects pages to their controllers. This is NOT hash-based SPA routing; the app uses separate HTML pages with body.id detection (MPA architecture).

Output: frontend/tests/integration/routing.test.js with tests for all 7 page types plus unknown page handling.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@frontend/js/controller.js
@frontend/js/View.js
@frontend/js/model.js
@frontend/tests/setup.js
@frontend/vitest.config.js
@frontend/tests/helpers/dom.js
@frontend/tests/helpers/factories.js
@frontend/tests/helpers/mocks/fetch.js

Existing test patterns:
@frontend/tests/views/cart.test.js (singleton DOM reassignment pattern)
@frontend/tests/view/cleanup.test.js (behavioral verification pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test helpers</name>
  <files>frontend/tests/helpers/integration.js</files>
  <action>
Create a shared integration test helper module with:

1. `createBaseFixture()` - Returns the minimal DOM HTML string that ALL views require:
   - `<header></header>`
   - `<div class="menu"></div>`
   - `<div data-purpose="header-utilities"></div>`
   - `<div class="footer"></div>`
   - `<div class="go-to-top"></div>`
   - `<span class="cart-number"></span>` and `<span class="cart-number-mobile">0</span>`
   The fixture should accept an optional `bodyId` parameter to set `document.body.id`.

2. `setupControllerMocks()` - Sets up the common mocks needed for controller tests:
   - `vi.spyOn(model, 'handleLoadStorage').mockResolvedValue()` (external API boundary)
   - `vi.spyOn(model, 'checkCartNumber').mockResolvedValue(0)` (external API boundary)
   - Mock `process.env.API_URL` to `'http://localhost:3001'`
   - Mock `process.env.USD_ILS_RATE` to `'3.7'`
   - Mock `IntersectionObserver` (used by stickyMenuFn) with a no-op implementation

3. `cleanupIntegrationState()` - Resets all global state:
   - `model.cart.length = 0`
   - `localStorage.clear()`
   - `delete window.__currencyPersistenceInitialized`
   - `vi.restoreAllMocks()`

IMPORTANT: Do NOT mock internal MVC wiring (view methods, event propagation). Only mock external boundaries (fetch/API calls, IntersectionObserver, process.env).

Export all three functions. Import from vitest and model as needed.
  </action>
  <verify>File exists and exports the three functions. No syntax errors: `cd frontend && npx vitest run tests/integration/routing.test.js --reporter=verbose 2>&1 | head -5` (will fail since test file doesn't exist yet, but confirms helper imports work when test is created)</verify>
  <done>Integration helper module exists at frontend/tests/helpers/integration.js with createBaseFixture, setupControllerMocks, and cleanupIntegrationState exported</done>
</task>

<task type="auto">
  <name>Task 2: Create controller routing integration tests</name>
  <files>frontend/tests/integration/routing.test.js</files>
  <action>
Create integration tests that verify controller.js init() dispatches correctly. Since init() runs at module import time AND uses window.addEventListener('load'), tests cannot simply import controller.js. Instead, test the individual controlXxxPage functions which ARE the routing targets.

IMPORTANT ARCHITECTURE NOTE: This app is a multi-page app (MPA), NOT a hash-based SPA. The controller's init() checks `document.body.id.includes('home')`, `document.body.id.includes('cart')`, etc. Each page is a separate HTML file. The "routing" being tested is the body.id -> controller function dispatch.

Structure the test file as follows:

```javascript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { render } from '../helpers/dom.js';
import { createBaseFixture, setupControllerMocks, cleanupIntegrationState } from '../helpers/integration.js';
import * as model from '../../js/model.js';
```

Since controller.js auto-executes init() on import, and the view modules are singletons that auto-query DOM at import time, you need to handle this carefully:

**Approach:** Do NOT import controller.js directly (it auto-executes and will fail without proper DOM). Instead, test the observable outcome by importing individual views and verifying they can be initialized through the same sequence the controller uses.

**Test structure:**

1. `describe('MVC Integration: Controller-View Dispatch')` - Top-level describe

2. `describe('Page initialization sequence')` - For each page type, verify the controller's initialization sequence works correctly:
   - For each of the 7 pages (home, workshop, about, contact-me, policies, cart, categories):
     a. Set up base DOM fixture with appropriate elements for that page
     b. Call model.handleLoadStorage() and model.checkCartNumber()
     c. Call the view's setLanguage(lng, cartNum)
     d. Verify: model.handleLoadStorage was called, view.setLanguage was called, cart number was persisted, menu was rendered
   - Use the view singletons directly (homePageView, WorkshopView, AboutView, ContactMeView, PoliciesView, CartView, categoriesView)
   - Import each view module individually

3. `describe('View initialization with English')` - Verify all views initialize correctly with 'eng':
   - For each page: render fixture, call setLanguage('eng', 0), verify English menu rendered (check for `.ul-eng` class)

4. `describe('View initialization with Hebrew')` - Verify all views initialize correctly with 'heb':
   - For each page: render fixture, call setLanguage('heb', 0), verify Hebrew menu rendered (check for `.ul-heb` class), verify document direction

5. `describe('Cart number persistence across pages')` - Verify cart number displays correctly:
   - Set model.cart to have items, call setLanguage with cartNum > 0
   - Verify `.cart-number-mobile` shows correct count
   - Do this for at least 3 different page views to prove cross-page consistency

6. `describe('Unknown page handling')` - Verify no crash when body.id doesn't match any known page:
   - Set body.id to 'unknown-page'
   - Verify no errors thrown when trying to initialize views

**Requirements covered:** MVC-01 (controller routes to correct view based on body.id page identity -- MPA dispatch, not hash navigation), MVC-02 (page load triggers view navigation/initialization)

**Target: ~20-25 tests total**

Each test should:
- Use `createBaseFixture()` in beforeEach
- Call `setupControllerMocks()` in beforeEach
- Call `cleanupIntegrationState()` in afterEach
- Mock `IntersectionObserver` (stickyMenuFn uses it)
- Mock `window.matchMedia` to return a consistent value

For CartView specifically, add the cart-specific DOM elements (`.cart-items-container`, `.added-items`, `.cart-empty`, `.summary-details`, etc.) and re-assign singleton DOM references (established pattern from 20-01).

For CategoriesView, mock fetch (it auto-fetches products) and use fake timers if needed (established pattern from 20-02: suppress auto-init by not setting body.id to 'categories' until ready).

IMPORTANT: The views import SVG files and use process.env. You may need to handle import errors for SVGs by mocking them at the module level with vi.mock(). Follow the pattern from existing view tests.
  </action>
  <verify>`cd frontend && npx vitest run tests/integration/routing.test.js --reporter=verbose` -- all tests pass with 0 failures</verify>
  <done>routing.test.js has 20+ passing tests covering all 7 page types in both languages, cart number persistence, and unknown page handling. Requirements MVC-01 and MVC-02 are verified.</done>
</task>

</tasks>

<verification>
```bash
cd frontend && npx vitest run tests/integration/routing.test.js --reporter=verbose
```
- All tests pass
- Tests cover all 7 page types (home, workshop, about, contact, policies, cart, categories)
- Both English and Hebrew initialization tested
- Cart number persistence verified across page views
- No regressions in existing test suite: `cd frontend && npx vitest run --reporter=verbose`
</verification>

<success_criteria>
- MVC-01: Controller dispatches to correct view for each of the 7 page types via MPA body.id dispatch (verified by view.setLanguage call producing correct DOM)
- MVC-02: Page initialization triggers full sequence (handleLoadStorage -> checkCartNumber -> setLanguage -> page-specific setup)
- Integration helper module reusable by plans 02, 03, 04
- All existing 315+ tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-mvc-integration-tests/22-01-SUMMARY.md`
</output>
