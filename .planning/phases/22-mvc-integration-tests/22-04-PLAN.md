---
phase: 22-mvc-integration-tests
plan: 04
type: execute
wave: 2
depends_on: ["22-01", "22-02", "22-03"]
files_modified:
  - frontend/tests/integration/user-journeys.test.js
autonomous: true

must_haves:
  truths:
    - "Guest user can add item, view cart with correct price, switch currency mid-checkout, and see prices recalculate while quantities are preserved"
    - "Logged-in user can add item via API, view cart, and maintain state across page simulations"
    - "Cart state persists in localStorage when guest navigates between page simulations"
    - "Currency preference persists in localStorage across page simulations"
    - "Language preference persists in localStorage across page simulations"
    - "Cart is not corrupted by currency change mid-checkout"
  artifacts:
    - path: "frontend/tests/integration/user-journeys.test.js"
      provides: "End-to-end user journey integration tests"
      min_lines: 200
  key_links:
    - from: "model.handleAddToCart(element)"
      to: "model.cart array updated + localStorage.setItem('cart', ...)"
      via: "addToLocalStorage -> addToLocalCart -> createLocalStorage"
      pattern: "addToLocalCart|createLocalStorage"
    - from: "CartView.render(cartNum)"
      to: "DOM shows items with correct currency prices"
      via: "_getCurrentCurrency() reads localStorage, _getItemPrice() selects usd/ils"
      pattern: "_getCurrentCurrency|_getItemPrice"
    - from: "localStorage.setItem('currency', 'ils')"
      to: "CartView re-render shows ILS prices"
      via: "manual render() call (currency-changed event has known _render bug)"
      pattern: "localStorage\\.setItem.*currency"
---

<objective>
Test complete user shopping journeys through the MVC stack, verifying state consistency across page simulations, currency changes mid-checkout, and both guest and logged-in user paths.

Purpose: Validates the full MVC architecture works as a system for real user scenarios. These are the highest-value tests -- they catch integration bugs that unit tests miss because they exercise the full model->controller->view chain.

Output: frontend/tests/integration/user-journeys.test.js with end-to-end scenario tests.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@frontend/js/controller.js
@frontend/js/View.js
@frontend/js/model.js
@frontend/js/Views/cartView.js
@frontend/tests/setup.js
@frontend/tests/helpers/dom.js
@frontend/tests/helpers/factories.js
@frontend/tests/helpers/mocks/fetch.js
@frontend/tests/helpers/mocks/dom-elements.js

Prior plan helpers (created by 22-01):
@frontend/tests/helpers/integration.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create guest user journey integration tests</name>
  <files>frontend/tests/integration/user-journeys.test.js</files>
  <action>
Create the test file with guest user journey tests that exercise the full MVC stack. These tests simulate complete shopping flows through multiple "pages" (re-rendering DOM fixtures to simulate page navigation in this MPA architecture).

**ARCHITECTURE NOTE:** This is an MPA, not an SPA. "Navigation" between pages means re-rendering the DOM fixture with different page-specific elements and re-initializing the view. State persists via localStorage (guest) or API (logged-in). Each "page navigation" in tests should:
1. Clear document.body.innerHTML
2. Render the new page's DOM fixture
3. Re-assign singleton view DOM references
4. Call setLanguage with current stored language and cart number

**CRITICAL PATTERNS:**
- CartView currency switching: use manual `render()` calls, NOT currency-changed event (known _render bug from D20-01-02)
- Cart items must have both `usdPrice` and `ilsPrice` fields
- Re-assign singleton DOM references after each "page navigation"
- Mock process.env, IntersectionObserver, matchMedia
- Use `createMockProductElement()` from helpers/mocks/dom-elements.js for add-to-cart
- Use `createProduct()` from helpers/factories.js for product data

**Test structure (guest journey tests only):**

1. `describe('MVC Integration: User Journeys')` - Top-level

2. `describe('Guest User Shopping Flow')` -- MVC-09, MVC-10

   SINGLE comprehensive journey test:

   `it('should complete full journey: browse -> add to cart -> view cart -> switch currency -> verify persistence')`:

   Step-by-step:
   a. **Start on "home page"**: render base fixture, set body.id = 'home', call homePageView.setLanguage('eng', 0). Verify menu renders with English content.

   b. **Add product to cart**: Create a product with createProduct({ usd_price: 50, ils_price: 185 }). Create mock product element with createMockProductElement(product). Call model.handleAddToCart(element). Verify: model.cart has 1 item, localStorage 'cart' is set, fetch was NOT called (guest user).

   c. **Verify cart badge updated**: Call homePageView.persistCartNumber(1). Verify .cart-number-mobile shows '1'.

   d. **Simulate navigation to cart page**: Clear body innerHTML, render cart page fixture (with .cart-items-container, .added-items, .cart-empty, .summary-details, etc.), re-assign CartView singleton DOM references. Set localStorage currency='usd'. Call cartView.render(1).

   e. **Verify cart displays item in USD**: Find .item-title element, verify it shows product name. Find price element, verify it contains '$' and '50'. Verify quantity input shows 1.

   f. **Switch currency to ILS mid-checkout**: Set localStorage currency='ils'. Clear .added-items innerHTML. Call cartView.render(1) again.

   g. **Verify ALL prices updated to ILS**: Item price shows ILS currency symbol and '185'. Cart total recalculated to ILS. Quantity PRESERVED at 1 (not reset).

   h. **Verify model.cart not corrupted**: model.cart[0].amount === 1. model.cart[0].usdPrice === 50. model.cart[0].ilsPrice === 185. All fields intact.

   i. **Simulate navigation back to home**: Clear body, render home fixture. Get cart from localStorage, parse it. Verify it still has 1 item with correct data.

   j. **Simulate navigation back to cart**: Clear body, render cart fixture, re-assign. Call cartView.render(1). Verify item still displayed correctly with ILS prices (currency persisted).

   Additional guest journey tests:

   `it('should preserve cart across multiple page navigations')`:
   - Add 2 items on "home", navigate to "cart", verify 2 items. Navigate to "about" (re-render). Navigate back to "cart", verify still 2 items via localStorage.

   `it('should preserve language preference across page navigations')`:
   - Set language to Hebrew on "home" (localStorage.setItem('language', 'heb')). Navigate to "cart" (re-render). Read language from localStorage. Call setLanguage with stored value. Verify Hebrew menu.

   `it('should preserve currency preference across page navigations')`:
   - Set currency to ILS on "home". Navigate to "cart". Verify currency selector shows ILS. Render cart with ILS prices.

   `it('should handle adding multiple items and viewing correct totals')`:
   - Add 3 items with different prices. Navigate to cart. Render. Verify 3 items displayed. Verify total is sum of all 3 prices. Switch currency. Verify new total is sum of all 3 ILS prices.

3. `describe('Currency change mid-checkout consistency')` -- MVC-09

   `it('should not lose cart items when currency switches during checkout')`:
   - Add 3 items as guest with distinct prices
   - Navigate to cart, render in USD
   - Switch to ILS (re-render)
   - Verify: same 3 items present, all have ILS prices, total recalculated
   - Switch BACK to USD (re-render)
   - Verify: same 3 items present, all have USD prices, total recalculated
   - Verify model.cart unchanged (all 3 items with original data)

   `it('should preserve discount prices during currency switch')`:
   - Add item with discountedPrice set
   - Render in USD, verify discounted price shown
   - Switch to ILS, verify ILS discounted price shown
   - Verify original prices also available

4. `describe('Navigation with unsaved cart changes')` -- MVC-10

   `it('should persist cart to localStorage immediately on add')`:
   - Add item via handleAddToCart
   - Immediately check localStorage (before any navigation)
   - Verify cart item is persisted

   `it('should not lose items added just before navigation')`:
   - Add item, immediately "navigate" (clear DOM, re-render different page)
   - Navigate back to cart, load from localStorage
   - Verify item present

**beforeEach pattern:**
```javascript
beforeEach(() => {
  resetFactoryCounter();
  model.cart.length = 0;
  localStorage.clear();
  delete window.__currencyPersistenceInitialized;
  process.env.API_URL = 'http://localhost:3001';
  process.env.USD_ILS_RATE = '3.7';

  // Mock IntersectionObserver
  global.IntersectionObserver = vi.fn(() => ({
    observe: vi.fn(), unobserve: vi.fn(), disconnect: vi.fn()
  }));

  // Mock matchMedia
  window.matchMedia = vi.fn(() => ({
    matches: true, addListener: vi.fn(), removeListener: vi.fn(),
    addEventListener: vi.fn(), removeEventListener: vi.fn()
  }));
});
```

**Helper function within file (or import from integration.js):**
```javascript
function renderCartPageFixture() {
  render(`
    <header></header>
    <div class="menu"></div>
    <div data-purpose="header-utilities"></div>
    <div class="footer"></div>
    <div class="go-to-top"></div>
    <div class="cart-items-container">
      <div class="added-items"></div>
      <div class="cart-empty">Your Cart Is Empty</div>
      <h2 class="cart-title">Your Cart</h2>
      <h3 class="summary-title">Order Summary</h3>
      <div class="summary-details"></div>
      <button id="stripe-checkout-btn">Checkout</button>
      <button class="delete-all">Delete All</button>
      <div class="check-me-out">Check Me Out With:</div>
      <div class="summary"></div>
    </div>
  `);

  // Re-assign CartView singleton DOM refs
  cartView._parentElement = document.querySelector('.cart-items-container');
  cartView._cartEmpty = document.querySelector('.cart-empty');
  cartView._cartTitle = document.querySelector('.cart-title');
  cartView._summaryTitle = document.querySelector('.summary-title');
  cartView._itemsBox = document.querySelector('.added-items');
  cartView._summaryDetails = document.querySelector('.summary-details');
  cartView._checkoutBtn = document.querySelector('#stripe-checkout-btn');
  cartView._deleteAllBtn = document.querySelector('.delete-all');
  cartView._checkMeOut = document.querySelector('.check-me-out');
  cartView._orderSummaryContainer = document.querySelector('.summary');
}
```

**Target for this task: ~9 guest journey tests**
  </action>
  <verify>`cd frontend && npx vitest run tests/integration/user-journeys.test.js --reporter=verbose` -- guest journey tests pass (logged-in tests not yet added)</verify>
  <done>user-journeys.test.js exists with ~9 passing guest journey tests. Complete guest shopping journey verified end-to-end. Currency mid-checkout consistency verified with round-trip (USD->ILS->USD). Cart persistence across page navigations verified.</done>
</task>

<task type="auto">
  <name>Task 2: Add logged-in user journey and edge case tests</name>
  <files>frontend/tests/integration/user-journeys.test.js</files>
  <action>
Add the logged-in user journey tests and any remaining edge case tests to the existing user-journeys.test.js file created in Task 1.

**Add the following describe blocks to the existing file:**

1. `describe('Logged-In User Shopping Flow')` -- MVC-09, MVC-10

   `it('should add item via API and maintain cart state')`:
   - Set localStorage auth-token
   - Setup fetch mock
   - Create product element, call model.handleAddToCart(element)
   - Verify fetch was called with auth-token header and /addtocart endpoint
   - Mock subsequent /getcart response
   - Simulate cart page: render fixture, mock checkCartNumber to return 1
   - Call cartView.setLanguage and render
   - Verify cart displays correctly

   `it('should maintain auth token across page simulations')`:
   - Set auth-token, navigate to "home" (render home fixture), navigate to "cart" (render cart fixture)
   - Verify auth-token still in localStorage after both page simulations

   `it('should handle API error gracefully during cart sync')`:
   - Set auth-token, mock fetch to return error
   - Call model.handleLoadStorage in try-catch
   - Verify no crash, view still renders (with empty or stale cart)

**Target for this task: ~3-4 logged-in tests, bringing total to ~12-13 tests**
  </action>
  <verify>`cd frontend && npx vitest run tests/integration/user-journeys.test.js --reporter=verbose` -- all tests pass including both guest and logged-in journey tests, 0 failures</verify>
  <done>user-journeys.test.js has 12+ passing tests covering both guest and logged-in user journeys. All guest tests from Task 1 still pass. Logged-in API path verified. API error handling verified.</done>
</task>

<task type="auto">
  <name>Task 3: Final verification and test count</name>
  <files></files>
  <action>
Run the complete test suite to verify all integration tests pass alongside existing tests.

1. Run ONLY the integration tests: `cd frontend && npx vitest run tests/integration/ --reporter=verbose`
   - Verify all 4 test files pass (routing, model-view-sync, lifecycle, user-journeys)
   - Count total integration tests

2. Run the FULL test suite: `cd frontend && npx vitest run --reporter=verbose`
   - Verify zero regressions in existing tests
   - Note total test count (should be 315+ existing + new integration tests)

3. Verify requirement coverage by checking test descriptions against MVC-01 through MVC-10:
   - MVC-01: routing.test.js - controller dispatches to correct view
   - MVC-02: routing.test.js - page load triggers view initialization
   - MVC-03: model-view-sync.test.js - cart changes update view
   - MVC-04: model-view-sync.test.js - currency change updates all prices
   - MVC-05: model-view-sync.test.js - language change updates all text
   - MVC-06: lifecycle.test.js - mount initializes listeners
   - MVC-07: lifecycle.test.js - update refreshes DOM
   - MVC-08: lifecycle.test.js - cleanup prevents duplicates
   - MVC-09: user-journeys.test.js - currency mid-checkout consistency
   - MVC-10: user-journeys.test.js - navigation preserves cart data

If any test fails, debug and fix. Do NOT skip or mark as pending.
  </action>
  <verify>`cd frontend && npx vitest run --reporter=verbose` -- ALL tests pass (0 failures), total count includes both existing and new integration tests</verify>
  <done>Complete test suite passes with 0 failures. All 10 MVC requirements have corresponding passing tests. Total test count documented.</done>
</task>

</tasks>

<verification>
```bash
# Integration tests only
cd frontend && npx vitest run tests/integration/ --reporter=verbose

# Full suite (no regressions)
cd frontend && npx vitest run --reporter=verbose
```
- All integration tests pass
- All existing tests pass (zero regressions)
- All 10 MVC requirements covered
</verification>

<success_criteria>
- MVC-09: Currency change mid-checkout maintains cart state (items, quantities, both price currencies intact)
- MVC-10: Navigation with cart data preserves all items via localStorage (guest) and API (logged-in)
- Complete guest shopping journey passes as single test
- Complete logged-in user API flow passes
- Round-trip currency switching (USD->ILS->USD) preserves all data
- Total phase test count: 60+ new integration tests across 4 files
- Zero regressions in existing 315+ tests
</success_criteria>

<output>
After completion, create `.planning/phases/22-mvc-integration-tests/22-04-SUMMARY.md`
</output>
