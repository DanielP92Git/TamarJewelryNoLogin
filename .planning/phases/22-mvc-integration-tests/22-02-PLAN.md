---
phase: 22-mvc-integration-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tests/integration/model-view-sync.test.js
autonomous: true

must_haves:
  truths:
    - "Currency switch from USD to ILS updates ALL visible price elements on cart view"
    - "Currency switch from ILS to USD updates ALL visible price elements on cart view"
    - "Currency switching tested via manual render() calls due to known CartView._render() method bug (D20-01-02) -- event propagation from currency-changed CustomEvent to CartView is NOT tested because _render() does not exist on the instance"
    - "Language switch from English to Hebrew updates menu, footer, and page-specific text"
    - "Language switch from Hebrew to English updates menu, footer, and page-specific text"
    - "Cart model changes (add item) update cart badge number in header"
    - "Both guest and logged-in user paths are tested"
  artifacts:
    - path: "frontend/tests/integration/model-view-sync.test.js"
      provides: "Model-to-view synchronization integration tests"
      min_lines: 200
  key_links:
    - from: "localStorage.setItem('currency', 'ils')"
      to: "CartView renders ILS prices"
      via: "CartView.render() reads _getCurrentCurrency() from localStorage"
      pattern: "_getCurrentCurrency"
    - from: "view.setLanguage('heb')"
      to: "DOM shows Hebrew menu and footer"
      via: "View.setLanguage() calls handleMenuLanguage() and handleFooterMarkup()"
      pattern: "handleMenuLanguage|handleFooterMarkup"
    - from: "model.cart.push(item)"
      to: "cart-number-mobile element shows count"
      via: "view.persistCartNumber(cartNum)"
      pattern: "persistCartNumber"
---

<objective>
Test that model state changes (currency, language, cart) correctly propagate to view re-renders, verifying BOTH the mechanism (method called) AND the final DOM state.

Purpose: Validates the synchronization layer between Model and View -- the core data flow of the MVC architecture. When model state changes, every affected DOM element must update.

Output: frontend/tests/integration/model-view-sync.test.js with comprehensive sync tests.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@frontend/js/controller.js
@frontend/js/View.js
@frontend/js/model.js
@frontend/js/Views/cartView.js
@frontend/tests/setup.js
@frontend/tests/helpers/dom.js
@frontend/tests/helpers/factories.js
@frontend/tests/helpers/mocks/fetch.js
@frontend/tests/helpers/mocks/dom-elements.js

Prior work patterns:
@frontend/tests/views/cart.test.js (cart rendering, currency switching via manual render)
@frontend/tests/view/currency.test.js (currency selector sync tests)
@frontend/tests/view/language.test.js (language switching tests)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create model-view synchronization integration tests</name>
  <files>frontend/tests/integration/model-view-sync.test.js</files>
  <action>
Create integration tests that verify model state changes propagate correctly to view DOM updates. This tests the WIRING between model and view layers.

**File structure:**

```javascript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { render } from '../helpers/dom.js';
import { createProduct, resetFactoryCounter } from '../helpers/factories.js';
import { setupFetchMock, teardownFetchMock, mockFetchSuccess } from '../helpers/mocks/fetch.js';
import * as model from '../../js/model.js';
import cartView from '../../js/Views/cartView.js';
import homePageView from '../../js/Views/homePageView.js';
```

**IMPORTANT PATTERN NOTES (from Phase 20 decisions):**
- CartView is a singleton -- re-assign DOM element properties in beforeEach (pattern from 20-01)
- CartView's currency-changed event handler calls `this._render()` which doesn't exist (known bug from D20-01-02). Test currency switching via manual `render()` calls with different localStorage currency values. This is an architectural limitation: the actual event propagation wiring from currency-changed CustomEvent to CartView re-render is NOT tested here because the bug makes it untestable without fixing production code.
- Cart items MUST include both `usdPrice` and `ilsPrice` fields for dual-currency verification
- Mock `process.env.API_URL` and `process.env.USD_ILS_RATE`
- Mock `IntersectionObserver` as no-op
- Mock `window.matchMedia` to return consistent value

**Test structure:**

1. `describe('MVC Integration: Model-View Synchronization')` - Top-level

2. `describe('Currency change propagation - Cart View')` -- MVC-04
   - beforeEach: render cart DOM fixture (from 20-01 pattern), re-assign CartView singleton props, clear model.cart, mock model.getGlobalDiscount, mock model.checkCartNumber
   - `it('should update ALL price elements when switching from USD to ILS with 3 cart items')`:
     - Push 3 items to model.cart with distinct usdPrice/ilsPrice values (e.g., 50/185, 40/148, 60/222)
     - Set localStorage currency='usd', call cartView.render(3)
     - Verify ALL 3 item prices show $ and correct USD values
     - Verify total shows correct USD sum
     - Switch: set localStorage currency='ils', clear added-items innerHTML, call cartView.render(3)
     - Verify ALL 3 item prices now show ₪ and correct ILS values
     - Verify total shows correct ILS sum (185+148+222=555)
   - `it('should update ALL price elements when switching from ILS to USD')`:
     - Same as above but start ILS, switch to USD
   - `it('should preserve cart item quantities during currency switch')`:
     - Push item with amount > 1
     - Switch currency
     - Verify quantity input still shows correct amount
   - `it('should update order summary total when currency switches')`:
     - Push 2 items, verify summary total in USD, switch to ILS, verify summary total recalculated
   - `it('should handle empty cart during currency switch without errors')`:
     - Empty cart, switch currency, no crash

3. `describe('Language change propagation')` -- MVC-05
   - `it('should update menu to English when setLanguage called with eng')`:
     - Render base fixture, call view.setLanguage('eng', 0)
     - Verify menu has `.ul-eng` class
     - Verify menu contains English nav items: 'Home', 'Shop', 'Jewelry Workshop', 'About', 'Contact Me'
   - `it('should update menu to Hebrew when setLanguage called with heb')`:
     - Call view.setLanguage('heb', 0)
     - Verify menu has `.ul-heb` class
     - Verify menu contains Hebrew nav items
   - `it('should update footer text when language switches to Hebrew')`:
     - Call view.setLanguage('eng', 0), verify English footer links
     - Call view.setLanguage('heb', 0), verify Hebrew footer text
   - `it('should update ALL currency selector text when language switches')`:
     - setLanguage('eng'), verify currency options show 'USD'/'ILS'
     - setLanguage('heb'), verify currency options show Hebrew equivalents
   - `it('should set document direction to RTL for Hebrew')`:
     - Call view.changeToHeb()
     - Verify document.documentElement.dir === 'rtl'
     - Call view.changeToEng()
     - Verify document.documentElement.dir === 'ltr'

4. `describe('Cart model changes propagate to view')` -- MVC-03
   - `describe('Guest User')`:
     - `it('should update cart badge when item added to cart')`:
       - Render fixture, call view.setLanguage('eng', 0) to render header
       - Push item to model.cart, call view.persistCartNumber(1)
       - Verify `.cart-number-mobile` shows '1'
     - `it('should update cart badge when item removed from cart')`:
       - Start with 2 items, persist 2, then remove and persist 1
       - Verify badge updates from '2' to '1'
     - `it('should update cart badge to 0 when cart cleared')`:
       - Start with items, clear, persist 0
       - Verify badge shows '0'
   - `describe('Logged-In User')`:
     - `it('should update cart badge after API cart sync')`:
       - Set auth-token in localStorage
       - Mock fetch for /getcart response
       - Call model.checkCartNumber (mocked to return 3)
       - Call view.persistCartNumber(3)
       - Verify badge shows '3'
     - `it('should call API with auth-token when adding to cart while logged in')`:
       - Set auth-token, setup fetch mock
       - Call model.handleAddToCart with mock product element
       - Verify fetch was called with correct auth-token header

5. `describe('Cross-source model changes')` -- Tests model changes from different sources
   - `it('should handle currency set from localStorage on page load')`:
     - Set localStorage currency='ils' before view init
     - Render and init view
     - Verify currency selector reflects ILS
   - `it('should handle language set from localStorage on page load')`:
     - Set localStorage language='heb' before view init
     - Call setLanguage with stored value
     - Verify Hebrew menu rendered

**Target: ~20 tests total**

Cart item test data structure (from 20-01 summary):
```javascript
{
  id: 'product-123',
  title: 'Gold Necklace',
  image: 'https://example.com/img.jpg',
  price: 185,
  usdPrice: 50,
  ilsPrice: 185,
  originalPrice: 185,
  originalUsdPrice: 50,
  originalIlsPrice: 185,
  discountedPrice: null,
  amount: 1,
  quantity: 10,
  currency: '₪'
}
```
  </action>
  <verify>`cd frontend && npx vitest run tests/integration/model-view-sync.test.js --reporter=verbose` -- all tests pass with 0 failures</verify>
  <done>model-view-sync.test.js has 20+ passing tests. Currency switching verified for ALL price elements via manual render() calls (documented workaround for D20-01-02 bug). Language switching verified for menu, footer, currency selectors. Cart badge updates verified for guest and logged-in paths. Requirements MVC-03, MVC-04, MVC-05 verified.</done>
</task>

</tasks>

<verification>
```bash
cd frontend && npx vitest run tests/integration/model-view-sync.test.js --reporter=verbose
```
- All tests pass
- Currency tests verify EVERY price element (not subsets)
- Language tests verify menu, footer, and selectors
- Cart badge tests cover both guest and logged-in paths
- No regressions: `cd frontend && npx vitest run --reporter=verbose`
</verification>

<success_criteria>
- MVC-03: Cart model changes (add/remove/clear) update cart view badge
- MVC-04: Currency model change updates ALL visible price elements (tested via manual render() due to known _render bug D20-01-02)
- MVC-05: Language model change updates ALL translatable text (menu, footer, selectors)
- Both guest and logged-in user paths tested
- All existing 315+ tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-mvc-integration-tests/22-02-SUMMARY.md`
</output>
