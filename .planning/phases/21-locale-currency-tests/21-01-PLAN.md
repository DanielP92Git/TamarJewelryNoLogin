---
phase: 21-locale-currency-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tests/locale/helpers.test.js
  - frontend/tests/locale/bootstrap.test.js
autonomous: true

must_haves:
  truths:
    - "normalizeAppLanguage returns 'eng' or 'heb' for valid inputs, null for invalid"
    - "normalizeAppCurrency returns 'usd' or 'ils' for valid inputs, null for invalid"
    - "mapIsoToApp prefers appLang/appCurrency when present, falls back to ISO codes"
    - "guessLocaleFromBrowser returns Hebrew/ILS for Hebrew navigator.language or Asia/Jerusalem timezone"
    - "guessLocaleFromBrowser returns English/USD as default fallback"
    - "setDocumentLanguage sets dir='rtl' and lang='he' for Hebrew, dir='ltr' and lang='en' for English"
    - "bootstrapLocaleSync preserves existing localStorage language and currency values"
    - "bootstrapLocaleSync sets browser-guessed defaults when localStorage is empty"
    - "bootstrapLocaleSync sets __localeAuto flags tracking which values were auto-filled"
    - "bootstrapLocaleSync applies document language attributes from localStorage"
    - "applyDocumentLanguageFromStorage reads localStorage and sets document attributes"
  artifacts:
    - path: "frontend/tests/locale/helpers.test.js"
      provides: "Unit tests for locale.js internal helper functions"
      min_lines: 100
    - path: "frontend/tests/locale/bootstrap.test.js"
      provides: "Tests for bootstrapLocaleSync and applyDocumentLanguageFromStorage"
      min_lines: 80
  key_links:
    - from: "frontend/tests/locale/helpers.test.js"
      to: "frontend/js/locale.js"
      via: "Direct import of locale.js (helpers are non-exported, test via exported functions)"
      pattern: "import.*from.*locale"
    - from: "frontend/tests/locale/bootstrap.test.js"
      to: "frontend/js/locale.js"
      via: "import { bootstrapLocaleSync, applyDocumentLanguageFromStorage }"
      pattern: "bootstrapLocaleSync|applyDocumentLanguageFromStorage"
---

<objective>
Test locale.js helper functions and bootstrapLocaleSync() for locale initialization and persistence.

Purpose: Verify LOCALE-03 (RTL dir attribute as proxy for flex-direction, with CSS limitation documented), LOCALE-06 (document integer pricing as actual behavior), LOCALE-13 (locale persists to localStorage via bootstrap), and LOCALE-14 (locale loads from localStorage on page reload and is preserved). These are the synchronous locale functions that run on every page load.

Output: `frontend/tests/locale/helpers.test.js` and `frontend/tests/locale/bootstrap.test.js`
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-locale-currency-tests/21-RESEARCH.md
@.planning/phases/21-locale-currency-tests/21-CONTEXT.md
@frontend/js/locale.js
@frontend/tests/setup.js
@frontend/tests/helpers/dom.js
@frontend/vitest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create locale helper function unit tests</name>
  <files>frontend/tests/locale/helpers.test.js</files>
  <action>
Create `frontend/tests/locale/` directory and `helpers.test.js` test file.

Since the helper functions (normalizeAppLanguage, normalizeAppCurrency, mapIsoToApp, guessLocaleFromBrowser, setDocumentLanguage, getApiBase) are NOT exported from locale.js, test them indirectly through the exported functions OR test them by importing the module and exercising the exported functions that call them. Alternatively, since locale.js is a small module (~199 lines), consider refactoring approach: the helpers are exercised through bootstrapLocaleSync() and hydrateLocaleFromBackend(). However, the research shows these are key functions worth direct testing.

**Approach:** Since the functions are internal, test them via their effects on the exported functions. For example:
- `normalizeAppLanguage/Currency` - Test via bootstrapLocaleSync() behavior with different localStorage values
- `mapIsoToApp` - Test via hydrateLocaleFromBackend() with different backend responses
- `guessLocaleFromBrowser` - Test via bootstrapLocaleSync() with empty localStorage + mocked navigator
- `setDocumentLanguage` - Test via bootstrapLocaleSync() or applyDocumentLanguageFromStorage()
- `getApiBase` - Test via hydrateLocaleFromBackend() fetch URL

**Better approach:** Create a separate test file that imports locale.js and tests the internal functions by calling the exported functions with controlled inputs and checking side effects.

Test cases for helpers.test.js (~15-18 tests):

**normalizeAppLanguage (via bootstrapLocaleSync side effects):**
- Valid 'eng' preserved in localStorage after bootstrap
- Valid 'heb' preserved in localStorage after bootstrap
- Invalid value (e.g., 'french') treated as missing, gets browser guess
- Empty string treated as missing
- null treated as missing
- Case insensitive ('ENG' -> 'eng', 'HEB' -> 'heb')

**normalizeAppCurrency (via bootstrapLocaleSync side effects):**
- Valid 'usd' preserved
- Valid 'ils' preserved
- Invalid value treated as missing, gets browser guess
- Case insensitive ('USD' -> 'usd')

**mapIsoToApp (test via hydrateLocaleFromBackend with mocked fetch):**
- { appLang: 'heb', appCurrency: 'ils' } maps directly (prefers app keys)
- { lang: 'he', currency: 'ILS' } maps to { appLang: 'heb', appCurrency: 'ils' }
- { lang: 'en', currency: 'USD' } maps to { appLang: 'eng', appCurrency: 'usd' }
- Mixed: { appLang: 'heb', currency: 'USD' } prefers appLang, falls back on currency

**guessLocaleFromBrowser (test via bootstrapLocaleSync with empty localStorage):**
- navigator.language = 'he' -> Hebrew/ILS stored
- navigator.language = 'he-IL' -> Hebrew/ILS stored
- Intl.DateTimeFormat timezone = 'Asia/Jerusalem' -> Hebrew/ILS stored
- navigator.language = 'en-US' -> English/USD stored (default)
- navigator.language = 'fr' -> English/USD stored (non-Hebrew default)

Mock navigator.language using Object.defineProperty or vi.stubGlobal.
Mock Intl.DateTimeFormat by replacing the global.

**setDocumentLanguage (test via applyDocumentLanguageFromStorage):**
- After setting localStorage language='heb' and calling applyDocumentLanguageFromStorage: document.documentElement.lang='he', dir='rtl'
- After setting localStorage language='eng' and calling applyDocumentLanguageFromStorage: document.documentElement.lang='en', dir='ltr'
- LOCALE-03: Document in test comment that dir='rtl' is the trigger for CSS flex-direction changes, but Happy-DOM cannot verify computed CSS styles

**Comment at top of file:**
```javascript
/**
 * Locale helper function tests.
 *
 * Tests internal locale.js functions (normalizeAppLanguage, normalizeAppCurrency,
 * mapIsoToApp, guessLocaleFromBrowser, setDocumentLanguage) via their effects on
 * exported functions.
 *
 * LOCALE-03 note: Happy-DOM does not apply CSS, so flex-direction cannot be verified
 * in unit tests. We test dir="rtl" attribute as the trigger. Visual RTL verification
 * requires Playwright or manual testing.
 *
 * LOCALE-06 note: The app uses Math.round() for all prices - integers only, no decimal
 * places. This is a known deviation from the "2 decimal places" requirement.
 * Tests verify integer behavior as the actual implementation.
 *
 * Requirements: LOCALE-03 (partial), LOCALE-06 (deviation documented)
 */
```

Use beforeEach to clear localStorage (setup.js handles this, but be explicit).
Use afterEach to clean up window.__localeAuto and restore mocked globals.

Mock fetch globally with vi.fn() returning a rejected promise (prevent actual network calls in helper tests; hydration tested in Plan 21-02).
  </action>
  <verify>Run `npx vitest run frontend/tests/locale/helpers.test.js` from the frontend directory. All tests pass.</verify>
  <done>15-18 tests covering normalizeAppLanguage, normalizeAppCurrency, mapIsoToApp, guessLocaleFromBrowser, setDocumentLanguage, and getApiBase via their effects on exported locale.js functions. LOCALE-03 and LOCALE-06 documented in test file comments.</done>
</task>

<task type="auto">
  <name>Task 2: Create bootstrapLocaleSync and persistence tests</name>
  <files>frontend/tests/locale/bootstrap.test.js</files>
  <action>
Create `frontend/tests/locale/bootstrap.test.js` test file.

This file tests bootstrapLocaleSync() and applyDocumentLanguageFromStorage() directly. Focus on LOCALE-13 (persistence to localStorage) and LOCALE-14 (loading from localStorage on reload).

Test cases for bootstrap.test.js (~12-15 tests):

**bootstrapLocaleSync() - Fresh visit (no localStorage):**
- Sets language in localStorage (browser guess default)
- Sets currency in localStorage (browser guess default)
- Sets window.__localeAuto.langWasMissing = true
- Sets window.__localeAuto.currencyWasMissing = true
- Sets document.documentElement.lang and dir based on guessed language

**bootstrapLocaleSync() - Returning visitor (localStorage has values):**
- LOCALE-14: Existing language='heb' is NOT overwritten
- LOCALE-14: Existing currency='ils' is NOT overwritten
- __localeAuto flags are NOT set (or not set to true) when both values exist
- document.documentElement.lang/dir matches existing localStorage language

**bootstrapLocaleSync() - Partial state (only one value missing):**
- Only language missing: sets language from guess, preserves existing currency
- Only currency missing: sets currency from guess, preserves existing language
- __localeAuto flags reflect which was missing and which wasn't

**applyDocumentLanguageFromStorage():**
- With language='heb' in localStorage: sets lang='he', dir='rtl'
- With language='eng' in localStorage: sets lang='en', dir='ltr'
- With no language in localStorage: defaults to 'eng' -> lang='en', dir='ltr'

**LOCALE-13 verification:**
- After bootstrapLocaleSync(), localStorage.getItem('language') returns a valid value
- After bootstrapLocaleSync(), localStorage.getItem('currency') returns a valid value
- Values are one of the valid pairs ('eng'/'heb' for language, 'usd'/'ils' for currency)

Mock navigator.language = 'en-US' by default (so guesses default to English/USD).
Mock fetch globally to prevent real calls.
Use afterEach to clean up window.__localeAuto.

**Comment at top of file:**
```javascript
/**
 * bootstrapLocaleSync() and applyDocumentLanguageFromStorage() tests.
 *
 * Verifies locale initialization on page load:
 * - Fresh visit: browser-guessed defaults are persisted to localStorage
 * - Returning visit: existing localStorage prefs are preserved (not overwritten)
 * - Partial state: only missing values are filled in
 * - __localeAuto flags track what was auto-filled for backend hydration
 *
 * Requirements: LOCALE-13, LOCALE-14
 */
```
  </action>
  <verify>Run `npx vitest run frontend/tests/locale/bootstrap.test.js` from the frontend directory. All tests pass.</verify>
  <done>12-15 tests verifying bootstrapLocaleSync() persistence (LOCALE-13) and reload behavior (LOCALE-14). Fresh visit sets defaults, returning visit preserves existing, partial state fills gaps only.</done>
</task>

</tasks>

<verification>
Run all locale tests together:
```bash
cd frontend && npx vitest run tests/locale/
```
All tests pass. No tests from other phases break (run `npx vitest run` for full suite).

Requirements coverage after this plan:
- LOCALE-03: Documented as Happy-DOM limitation, dir="rtl" attribute tested as proxy
- LOCALE-06: Documented as deviation (app uses integers), actual behavior tested
- LOCALE-13: bootstrapLocaleSync() writes to localStorage on fresh visit
- LOCALE-14: bootstrapLocaleSync() preserves existing localStorage on reload
</verification>

<success_criteria>
1. helpers.test.js has 15+ tests covering normalize, map, guess, and document functions
2. bootstrap.test.js has 12+ tests covering fresh/returning/partial scenarios
3. All tests pass with `npx vitest run tests/locale/`
4. LOCALE-03 and LOCALE-06 limitations documented in test file comments
5. No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/21-locale-currency-tests/21-01-SUMMARY.md`
</output>
