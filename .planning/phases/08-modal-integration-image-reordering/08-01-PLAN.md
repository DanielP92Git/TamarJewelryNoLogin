---
phase: 08-modal-integration-image-reordering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - admin/BisliView.js
  - admin/bambaYafa-desktop.css
autonomous: true

must_haves:
  truths:
    - "Admin can click product row to open preview modal"
    - "Modal displays product exactly as customers see it (images, description, price, SKU)"
    - "Modal closes via X button"
    - "Modal closes when pressing ESC key"
    - "Modal closes when clicking backdrop"
    - "Modal has focus trap (Tab cycles within modal)"
    - "Modal has ARIA labels for screen readers"
  artifacts:
    - path: "admin/BisliView.js"
      provides: "createProductPreviewModal, openProductPreview functions"
      contains: "dialog.showModal"
    - path: "admin/bambaYafa-desktop.css"
      provides: "Modal styling with RTL support"
      contains: "admin-preview-modal"
  key_links:
    - from: "admin/BisliView.js"
      to: "product row click"
      via: "event delegation on listproduct-row"
      pattern: "openProductPreview"
    - from: "dialog element"
      to: "showModal()"
      via: "native dialog API"
      pattern: "showModal\\(\\)"
---

<objective>
Create the product preview modal infrastructure using native HTML `<dialog>` element.

Purpose: Enable admin to click any product row and see exactly what customers see - the full product presentation with images, description, price, and SKU. This provides quick preview without navigating away from the product list.

Output: Functional modal that opens on product row click, displays customer-facing view, and closes via X/ESC/backdrop with proper accessibility.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-modal-integration-image-reordering/08-RESEARCH.md

# Existing patterns to follow
@admin/BisliView.js (editProduct function for product data handling, enterReorderMode for SortableJS patterns)
@frontend/js/Views/categoriesView.js (showProductModal for customer-facing product display)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add modal CSS styles to admin stylesheet</name>
  <files>admin/bambaYafa-desktop.css</files>
  <action>
Add CSS for the preview modal at the end of bambaYafa-desktop.css:

1. Dialog element base styles:
   - `dialog.admin-preview-modal` - fixed positioning, max-width 900px, max-height 80vh
   - `dialog::backdrop` - semi-transparent black with blur
   - Border-radius: var(--radius), no border, box-shadow: var(--shadow)
   - z-index: 1500 (above sticky header 1000, below toasts 2000)

2. Modal structure:
   - `.modal-header` - flex row with title and close button, border-bottom
   - `.modal-close` - positioned at inline-end (RTL-safe), large click target, hover state
   - `.modal-body` - flex: 1, overflow-y: auto, padding 20px
   - `.modal-footer` - flex row, gap 12px, justify-content: flex-end, border-top

3. Preview layout (match customer view):
   - `.preview-layout` - grid layout (images left, details right on desktop, stacked on mobile)
   - `.preview-images` - main image + thumbnail strip
   - `.preview-main-image img` - max-width 100%, object-fit contain
   - `.preview-thumbnails` - flex row with gap, horizontal scroll if many images
   - `.preview-thumb` - 60px thumbnails, border highlight on active/hover
   - `.preview-details` - product info section (title, description, SKU, price)

4. RTL support:
   - Use logical properties (inset-inline-start/end, margin-inline)
   - [dir="rtl"] .modal-footer - justify-content: flex-start

5. Mobile responsive (max-width 800px):
   - Modal: max-width 100vw, max-height 90vh, border-radius 0 on top
   - Preview layout: single column (stack images above details)
  </action>
  <verify>
Check CSS syntax by searching for unclosed braces:
```bash
grep -c "{" admin/bambaYafa-desktop.css
grep -c "}" admin/bambaYafa-desktop.css
```
Both counts should match.
  </verify>
  <done>
CSS file contains `.admin-preview-modal` styles with backdrop, modal structure, preview layout, RTL support, and mobile responsive rules. Brace counts match.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement modal JavaScript functions in BisliView.js</name>
  <files>admin/BisliView.js</files>
  <action>
Add the modal implementation after the existing editProduct function (around line 2540):

1. Create `initProductPreviewModal()` function:
   - Remove existing modal if present: `document.getElementById('productPreviewModal')?.remove()`
   - Create `<dialog>` element with id 'productPreviewModal', class 'admin-preview-modal'
   - Set ARIA attributes: role="dialog", aria-modal="true", aria-labelledby="preview-modal-title"
   - Append to document.body
   - Return the dialog element

2. Create `renderProductPreview(product)` function:
   - Get images using unified images array pattern (Phase 7):
     - If product.images array exists and has items, use it
     - Otherwise fall back to mainImage + smallImages (legacy)
   - Use helper functions from editProduct (getAllMainImageUrls, getAllSmallImageUrls patterns)
   - Return HTML string with:
     - Main image display (first image from array)
     - Thumbnail strip (all images, first marked active)
     - Product title (h3)
     - Description with line breaks preserved
     - SKU display (if present)
     - Price in ILS format

3. Create `openProductPreview(product, triggerElement)` function:
   - Call initProductPreviewModal() to get dialog
   - Set innerHTML with modal structure:
     - Header with product name and close button (X)
     - Body with renderProductPreview(product) content
     - Footer with action buttons (Edit, Delete, Duplicate) - buttons wired in Plan 02
   - Call dialog.showModal() - this automatically enables:
     - ESC key to close (MODAL-05)
     - Focus trap within dialog (MODAL-07)
   - Add close button click handler -> dialog.close()
   - Add backdrop click handler:
     ```javascript
     dialog.addEventListener('click', (e) => {
       if (e.target === dialog) dialog.close();
     });
     ```
   - Add 'close' event listener to:
     - Restore focus to triggerElement if provided
     - Remove dialog from DOM
   - Add thumbnail click handlers to switch main image (preview gallery interaction)

4. Add product row click handler in loadProducts function (around line 2170):
   - After the productElement is created and before appending to container
   - Add click handler on the entire product row (productElement)
   - Exclude clicks on: .edit-btn, .delete-btn, .duplicate-btn, .product-checkbox, .sku-cell, .drag-handle
   - On valid click: find product from data array, call openProductPreview(product, productElement)
   - Use event delegation pattern:
     ```javascript
     productElement.addEventListener('click', (e) => {
       // Don't open modal if clicking on action buttons or interactive elements
       if (e.target.closest('.edit-btn, .delete-btn, .duplicate-btn, .product-checkbox, .sku-cell, .drag-handle')) {
         return;
       }
       const product = data.find(p => p._id == item._id);
       if (product) {
         openProductPreview(product, productElement);
       }
     });
     ```

5. Add cursor style to product rows in the CSS (or inline):
   - `.listproduct-row` should have `cursor: pointer` to indicate clickability
   - Action buttons should have their own cursor styles to override
  </action>
  <verify>
1. Check function exists:
```bash
grep -n "function openProductPreview" admin/BisliView.js
grep -n "function initProductPreviewModal" admin/BisliView.js
grep -n "function renderProductPreview" admin/BisliView.js
```

2. Check dialog usage:
```bash
grep -n "showModal" admin/BisliView.js
grep -n "dialog.close" admin/BisliView.js
```

3. Check click handler wiring:
```bash
grep -n "openProductPreview" admin/BisliView.js | wc -l
```
Should show at least 2 occurrences (definition + call).
  </verify>
  <done>
- initProductPreviewModal creates native dialog element with ARIA attributes
- renderProductPreview renders customer-facing product view with images array support
- openProductPreview opens modal with showModal(), handles all close methods (X, ESC, backdrop)
- Product row click handler calls openProductPreview (excluding action buttons)
- All MODAL-01, MODAL-04, MODAL-05, MODAL-06, MODAL-07, MODAL-08 requirements addressed
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cursor styles and test modal opens</name>
  <files>admin/bambaYafa-desktop.css</files>
  <action>
Add cursor styles for product rows to indicate clickability:

1. In the existing `.listproduct-row` rule (or add new if not exists):
   ```css
   .listproduct-row {
     cursor: pointer;
   }
   ```

2. Override cursor for interactive elements within row:
   ```css
   .listproduct-row .edit-btn,
   .listproduct-row .delete-btn,
   .listproduct-row .duplicate-btn,
   .listproduct-row .product-checkbox,
   .listproduct-row .sku-cell,
   .listproduct-row .drag-handle {
     cursor: pointer; /* or specific cursor like grab for drag-handle */
   }

   .listproduct-row .drag-handle {
     cursor: grab;
   }

   .listproduct-row .drag-handle:active {
     cursor: grabbing;
   }
   ```

3. Add hover state for product rows to reinforce clickability:
   ```css
   .listproduct-row:hover {
     background: var(--surface-2);
   }
   ```

Note: These styles may already exist partially - check and add only what's missing.
  </action>
  <verify>
```bash
grep -n "listproduct-row" admin/bambaYafa-desktop.css | head -20
grep -n "cursor" admin/bambaYafa-desktop.css | tail -10
```
  </verify>
  <done>
Product rows have pointer cursor indicating clickability, hover state provides visual feedback, action buttons have appropriate cursor overrides.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. CSS validation:
   - Brace counts match in bambaYafa-desktop.css
   - `.admin-preview-modal` class exists with dialog styles

2. JavaScript validation:
   - `openProductPreview` function exists and uses `showModal()`
   - `renderProductPreview` function exists and returns HTML
   - Product row click handler is wired

3. Functional test (manual):
   - Navigate to admin product list
   - Click on a product row (not on action buttons)
   - Modal should open showing product preview
   - Press ESC - modal should close
   - Reopen modal, click X button - modal should close
   - Reopen modal, click outside modal (backdrop) - modal should close
   - Tab key should cycle within modal (focus trap)
</verification>

<success_criteria>
- [ ] Native `<dialog>` element used (not custom modal div)
- [ ] Modal opens on product row click (MODAL-01)
- [ ] Modal displays customer-facing view: images, title, description, SKU, price (MODAL-02)
- [ ] Close button (X) works (MODAL-04)
- [ ] ESC key closes modal (MODAL-05)
- [ ] Backdrop click closes modal (MODAL-06)
- [ ] Focus trap works (Tab cycles within modal) (MODAL-07)
- [ ] ARIA labels present (MODAL-08)
- [ ] RTL support via CSS logical properties
- [ ] Mobile responsive layout
</success_criteria>

<output>
After completion, create `.planning/phases/08-modal-integration-image-reordering/08-01-SUMMARY.md`
</output>
