---
phase: 08-modal-integration-image-reordering
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - admin/BisliView.js
  - admin/bambaYafa-desktop.css
autonomous: true

must_haves:
  truths:
    - "Admin can drag image thumbnails to reorder gallery in edit form"
    - "Image thumbnails show visual feedback during drag (ghost, chosen states)"
    - "Drop indicator shows where image will land"
    - "First image in gallery is visually indicated as main product image"
  artifacts:
    - path: "admin/BisliView.js"
      provides: "setupEditFormImageGallery function with SortableJS"
      contains: "Sortable.create"
    - path: "admin/bambaYafa-desktop.css"
      provides: "Gallery sortable styles, main badge"
      contains: "gallery-sortable-ghost"
  key_links:
    - from: "admin/BisliView.js"
      to: "SortableJS"
      via: "Sortable.create with handle option"
      pattern: "Sortable\\.create.*handle"
    - from: "editProduct function"
      to: "setupEditFormImageGallery"
      via: "function call after rendering gallery"
      pattern: "setupEditFormImageGallery"
---

<objective>
Add drag-and-drop image reordering to the product edit form using SortableJS.

Purpose: Allow admin to change the order of product gallery images by dragging thumbnails. First image automatically becomes the main/featured image, matching the unified images array schema from Phase 7.

Output: Image gallery in edit form is draggable with visual feedback, first position marked as main image, order changes tracked for form submission.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-modal-integration-image-reordering/08-RESEARCH.md
@.planning/phases/07-image-array-migration/07-05-SUMMARY.md

# Existing SortableJS patterns to follow
@admin/BisliView.js (enterReorderMode at ~line 1351 for SortableJS config, editProduct at ~line 2543 for image rendering)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gallery sortable CSS styles</name>
  <files>admin/bambaYafa-desktop.css</files>
  <action>
Add CSS for the image gallery sortable at the end of bambaYafa-desktop.css (after the modal styles added in 08-01):

```css
/* =========================
   Image Gallery Sortable (Edit Form)
   ========================= */

.edit-gallery-container {
  margin-top: 16px;
}

.edit-gallery-thumbs {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.gallery-thumb {
  position: relative;
  width: 100px;
  height: 100px;
  border: 2px solid var(--border);
  border-radius: var(--radius-xs);
  overflow: hidden;
  background: var(--surface);
  transition: border-color 0.15s, box-shadow 0.15s;
}

.gallery-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.gallery-thumb.is-main-image {
  border-color: var(--success);
}

.gallery-thumb:hover {
  border-color: var(--primary);
}

/* Main image badge */
.main-badge {
  position: absolute;
  bottom: 4px;
  inset-inline-start: 4px;
  padding: 2px 8px;
  background: var(--success);
  color: white;
  font-size: 10px;
  font-weight: 600;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Drag handle */
.image-drag-handle {
  position: absolute;
  top: 4px;
  inset-inline-start: 4px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 4px;
  cursor: grab;
  opacity: 0;
  transition: opacity 0.15s;
  color: var(--muted);
}

.gallery-thumb:hover .image-drag-handle {
  opacity: 1;
}

.image-drag-handle:active {
  cursor: grabbing;
}

/* Delete button */
.delete-image-btn {
  position: absolute;
  top: 4px;
  inset-inline-end: 4px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--danger);
  color: white;
  border: none;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.15s, background 0.15s;
}

.gallery-thumb:hover .delete-image-btn {
  opacity: 1;
}

.delete-image-btn:hover {
  background: #dc2626;
}

/* SortableJS states */
.gallery-sortable-ghost {
  opacity: 0.4;
  border-color: var(--primary) !important;
}

.gallery-sortable-chosen {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transform: scale(1.02);
}

.gallery-sortable-drag {
  opacity: 0.9;
}

/* Gallery section header */
.gallery-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.gallery-section-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.gallery-help-text {
  font-size: 12px;
  color: var(--muted);
}
```
  </action>
  <verify>
```bash
grep -n "gallery-sortable-ghost" admin/bambaYafa-desktop.css
grep -n "is-main-image" admin/bambaYafa-desktop.css
grep -n "main-badge" admin/bambaYafa-desktop.css
```
  </verify>
  <done>
CSS file contains gallery thumbnail styles, main badge, drag handle, delete button, and SortableJS state classes (ghost, chosen, drag).
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract helper functions and create setupEditFormImageGallery</name>
  <files>admin/BisliView.js</files>
  <action>
**IMPORTANT:** The helper functions `getAllMainImageUrls` and `getAllSmallImageUrls` currently exist as nested functions inside `editProduct` (around lines 2548 and 2614). They must be moved to module scope BEFORE creating `setupEditFormImageGallery`.

**Step 1: Move helper functions to module scope**

1. Find `getAllMainImageUrls` (line ~2548) and `getAllSmallImageUrls` (line ~2614) inside `editProduct`
2. Cut both functions (including their nested `getFilename` and `ensureProductionUrl` helpers)
3. Paste them BEFORE the `editProduct` function definition (around line 2540)
4. Leave a comment in editProduct where they were: `// getAllMainImageUrls and getAllSmallImageUrls moved to module scope for reuse`

**Step 2: Add the gallery sortable functions after the moved helpers**

```javascript
// Store sortable instance for cleanup
let _galleryInstanceSortable = null;

/**
 * Setup image gallery with drag-and-drop reordering in edit form
 * @param {Object} product - Product object with images array
 * @param {HTMLElement} container - Container element for thumbnails
 */
function setupEditFormImageGallery(product, container) {
  if (!container) return;

  // Destroy previous instance if exists (prevents multiple bindings)
  if (_galleryInstanceSortable) {
    _galleryInstanceSortable.destroy();
    _galleryInstanceSortable = null;
  }

  // Get images using unified array (Phase 7) with fallback to legacy
  let currentImages = [];

  if (Array.isArray(product.images) && product.images.length > 0) {
    // New unified images array format
    currentImages = product.images.map((img, idx) => ({
      url: img.desktop || img.publicDesktop || img.desktopLocal || '',
      index: idx,
      original: img
    })).filter(img => img.url); // Filter out empty images
  } else {
    // Fallback to legacy format using module-scope helpers
    const mainUrls = getAllMainImageUrls(product);
    const smallUrls = getAllSmallImageUrls(product);

    // Main image first
    if (mainUrls.length > 0) {
      currentImages.push({ url: mainUrls[0], index: 0, original: null });
    }

    // Then gallery images
    smallUrls.forEach((url, idx) => {
      if (url && !currentImages.some(img => img.url === url)) {
        currentImages.push({ url, index: currentImages.length, original: null });
      }
    });
  }

  if (currentImages.length === 0) {
    container.innerHTML = '<p class="gallery-help-text">No images uploaded yet</p>';
    return;
  }

  // Store original order for potential cancel/restore
  const originalOrder = currentImages.map(img => img.url);
  container.dataset.originalOrder = JSON.stringify(originalOrder);

  // Render thumbnails with drag handles and delete buttons
  container.innerHTML = currentImages.map((img, idx) => `
    <div class="gallery-thumb ${idx === 0 ? 'is-main-image' : ''}"
         data-index="${idx}"
         data-url="${encodeURIComponent(img.url)}">
      <div class="image-drag-handle" aria-label="Drag to reorder">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <circle cx="4" cy="4" r="1.5"/>
          <circle cx="4" cy="8" r="1.5"/>
          <circle cx="4" cy="12" r="1.5"/>
          <circle cx="12" cy="4" r="1.5"/>
          <circle cx="12" cy="8" r="1.5"/>
          <circle cx="12" cy="12" r="1.5"/>
        </svg>
      </div>
      <img src="${img.url}" alt="Gallery image ${idx + 1}" loading="lazy" />
      <button type="button" class="delete-image-btn"
              data-index="${idx}"
              data-url="${encodeURIComponent(img.url)}"
              aria-label="Delete image">&times;</button>
      ${idx === 0 ? '<span class="main-badge">Main</span>' : ''}
    </div>
  `).join('');

  // Initialize SortableJS with handle pattern (matches Phase 6 product reordering)
  _galleryInstanceSortable = Sortable.create(container, {
    handle: '.image-drag-handle',
    animation: 150,
    delay: 50,
    delayOnTouchOnly: true,
    ghostClass: 'gallery-sortable-ghost',
    chosenClass: 'gallery-sortable-chosen',
    dragClass: 'gallery-sortable-drag',
    onEnd: function(evt) {
      if (evt.oldIndex === evt.newIndex) return;

      // Update main badge position
      updateMainImageBadge(container);

      // Update hidden form field with new order
      updateImageOrderField(container);

      // Mark form as having unsaved changes
      if (typeof window.formHasUnsavedChanges !== 'undefined') {
        window.formHasUnsavedChanges = true;
      }

      console.log('[Gallery] Image reordered:', {
        from: evt.oldIndex,
        to: evt.newIndex,
        newOrder: getImageOrder(container)
      });
    }
  });

  // Setup delete button handlers (will be implemented in Plan 04)
  // setupImageDeleteButtons(container, product._id);
}

/**
 * Update main image badge after reorder
 */
function updateMainImageBadge(container) {
  const thumbs = container.querySelectorAll('.gallery-thumb');
  thumbs.forEach((thumb, idx) => {
    // Update is-main-image class
    thumb.classList.toggle('is-main-image', idx === 0);

    // Update badge
    const existingBadge = thumb.querySelector('.main-badge');
    if (idx === 0 && !existingBadge) {
      thumb.insertAdjacentHTML('beforeend', '<span class="main-badge">Main</span>');
    } else if (idx !== 0 && existingBadge) {
      existingBadge.remove();
    }
  });
}

/**
 * Get current image order from DOM
 */
function getImageOrder(container) {
  return Array.from(container.querySelectorAll('.gallery-thumb'))
    .map(thumb => decodeURIComponent(thumb.dataset.url));
}

/**
 * Update hidden form field with current image order
 */
function updateImageOrderField(container) {
  const orderInput = document.getElementById('imageOrderInput');
  if (orderInput) {
    orderInput.value = JSON.stringify(getImageOrder(container));
  }
}
```
  </action>
  <verify>
```bash
# Verify helpers are now at module scope (before editProduct)
grep -n "function getAllMainImageUrls" admin/BisliView.js
grep -n "function getAllSmallImageUrls" admin/BisliView.js

# Verify setupEditFormImageGallery was added
grep -n "function setupEditFormImageGallery" admin/BisliView.js

# Verify there are now 2 Sortable.create calls
grep -n "Sortable.create" admin/BisliView.js | wc -l
```

The helper functions should now appear BEFORE editProduct (lower line numbers than ~2540).
  </verify>
  <done>
- getAllMainImageUrls and getAllSmallImageUrls moved from inside editProduct to module scope
- setupEditFormImageGallery function created using the module-scope helpers
- SortableJS configured with drag handles, visual feedback classes, and order tracking
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate gallery sortable into editProduct form</name>
  <files>admin/BisliView.js</files>
  <action>
Modify the editProduct function to include the sortable gallery and hidden order field:

1. Find the editProduct function and locate where images are currently displayed. Look for the small images gallery rendering section.

2. Add a gallery container section in the form HTML. Find where the existing image display is and add alongside or replace with:

```html
<!-- Add to form HTML, in the images section -->
<div class="form-section">
  <div class="gallery-section-header">
    <span class="gallery-section-title">Product Gallery</span>
    <span class="gallery-help-text">Drag to reorder. First image is main.</span>
  </div>
  <div class="edit-gallery-thumbs" id="editGalleryThumbs"></div>
  <input type="hidden" id="imageOrderInput" name="imageOrder" value="">
</div>
```

3. After the form HTML is rendered (after setting innerHTML), call the setup function:

```javascript
// After pageContent.innerHTML = ... in editProduct
// Find or add this after the form is rendered:
const galleryContainer = document.getElementById('editGalleryThumbs');
if (galleryContainer) {
  setupEditFormImageGallery(product, galleryContainer);
}

// Initialize the hidden input with current order
const orderInput = document.getElementById('imageOrderInput');
if (orderInput && galleryContainer) {
  orderInput.value = JSON.stringify(getImageOrder(galleryContainer));
}
```

4. **Note:** The helper functions were moved to module scope in Task 2, so editProduct should still work for its existing image display code. If editProduct still has local references to getAllMainImageUrls/getAllSmallImageUrls, they will now call the module-scope versions (JavaScript hoisting).
  </action>
  <verify>
```bash
grep -n "editGalleryThumbs" admin/BisliView.js
grep -n "imageOrderInput" admin/BisliView.js
grep -n "setupEditFormImageGallery" admin/BisliView.js | wc -l
```
Should show at least 2 occurrences of setupEditFormImageGallery (definition + call).
  </verify>
  <done>
editProduct form includes gallery container, hidden order input, and calls setupEditFormImageGallery after rendering. Gallery is draggable with first image marked as main.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. CSS validation:
```bash
grep -c "gallery-sortable" admin/bambaYafa-desktop.css
# Should show multiple matches for ghost, chosen, drag classes
```

2. JavaScript validation:
```bash
# Helpers at module scope
grep -n "function getAllMainImageUrls" admin/BisliView.js
grep -n "function getAllSmallImageUrls" admin/BisliView.js
# These should appear BEFORE editProduct function

# Sortable.create calls
grep -n "Sortable.create" admin/BisliView.js
# Should show 2 calls (product list + image gallery)
```

3. Functional test (manual):
   - Navigate to admin, click Edit on a product with multiple images
   - Gallery section should show thumbnails with drag handles
   - First image should have "Main" badge and green border
   - Hover over image: drag handle and delete button should appear
   - Drag an image to new position: ghost/chosen states should be visible
   - After drop: "Main" badge moves to first position
   - Check browser console for reorder log messages
</verification>

<success_criteria>
- [ ] getAllMainImageUrls and getAllSmallImageUrls moved to module scope
- [ ] Gallery thumbnails display in edit form (IMAGE-03 setup)
- [ ] Drag handles visible on hover
- [ ] SortableJS dragging works with visual feedback (IMAGE-04)
- [ ] Drop zones/positions indicated during drag (IMAGE-05)
- [ ] First image marked as main with badge and border (IMAGE-07)
- [ ] Main badge moves when first position changes
- [ ] Hidden form field tracks image order
- [ ] Gallery sortable instance properly cleaned up on navigation
</success_criteria>

<output>
After completion, create `.planning/phases/08-modal-integration-image-reordering/08-03-SUMMARY.md`
</output>
