---
phase: 12-payment-processing
plan: 03
type: execute
wave: 2
depends_on: ["12-01", "12-02"]
files_modified:
  - backend/tests/integration/payment.validation.test.js
autonomous: true

must_haves:
  truths:
    - "Payment endpoints reject negative amounts"
    - "Payment endpoints reject invalid currency codes"
    - "Payment endpoints validate all required fields"
    - "Validation errors return 400 with descriptive messages"
  artifacts:
    - path: "backend/tests/integration/payment.validation.test.js"
      provides: "Cross-provider payment validation tests"
      min_lines: 150
  key_links:
    - from: "backend/tests/integration/payment.validation.test.js"
      to: "backend/index.js"
      via: "supertest HTTP boundary testing"
      pattern: "request\\(app\\).*post.*/orders|create-checkout-session"
---

<objective>
Create comprehensive payment validation tests covering both PayPal and Stripe endpoints

Purpose: Verify payment endpoints properly validate input data and reject invalid amounts, currencies, and missing fields. Covers requirements PAY-11, PAY-12, PAY-13.

Output: Dedicated validation test file ensuring robust input handling
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-payment-processing/12-CONTEXT.md

# Reference the completed plan summaries
@.planning/phases/12-payment-processing/12-01-SUMMARY.md
@.planning/phases/12-payment-processing/12-02-SUMMARY.md

# Existing test infrastructure
@backend/tests/setup.js
@backend/tests/helpers/mocks/paypal.js
@backend/tests/helpers/mocks/stripe.js
@backend/tests/helpers/factories.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payment validation tests for both providers</name>
  <files>backend/tests/integration/payment.validation.test.js</files>
  <action>
Create comprehensive validation test file covering edge cases for both PayPal (/orders) and Stripe (/create-checkout-session) endpoints.

**Test Structure:**
```javascript
import { describe, it, expect, beforeAll, afterAll, beforeEach } from 'vitest';
import request from 'supertest';
import mongoose from 'mongoose';
import nock from 'nock';
import { validateTestEnvironment } from '../helpers/envGuard.js';
import { disableNetConnect, cleanAllMocks, mockPayPalAuth, mockPayPalCreateOrder } from '../helpers/mocks/index.js';
import { createProduct } from '../helpers/factories.js';
```

**Test Groups:**

1. **PayPal /orders - Amount Validation (PAY-11, PAY-12)**
   - `should return 400 for negative unit_amount.value` - cart item with "-10.00"
   - `should return 400 for zero unit_amount.value` - cart item with "0.00"
   - `should return 400 for non-numeric unit_amount.value` - cart item with "invalid"
   - `should return 400 for extremely large amount` - cart item with "9999999999.99"
   - `should return 400 for missing unit_amount.value` - cart item without value field
   - `should return 400 for negative quantity` - quantity: "-1"
   - `should return 400 for zero quantity` - quantity: "0"
   - `should return 400 for non-integer quantity` - quantity: "1.5"

2. **PayPal /orders - Currency Validation (PAY-13)**
   - `should return 400 for invalid currency code` - currency_code: "INVALID"
   - `should return 400 for missing currency_code` - no currency_code field
   - `should return 400 for mixed currencies in cart` - one item USD, one ILS
   - `should accept valid USD currency` - mock success for USD cart
   - `should accept valid ILS currency` - mock success for ILS cart

3. **PayPal /orders - Required Fields (PAY-11)**
   - `should return 400 for cart item missing name` - item without name field
   - `should return 400 for cart item with empty name` - name: ""
   - `should return 400 for cart item missing quantity` - no quantity field
   - `should return 400 for malformed cart item` - wrong structure

4. **Stripe /create-checkout-session - Amount Validation (PAY-11, PAY-12)**
   - `should return 400/500 for product with zero usd_price` - DB product with usd_price: 0
   - `should return 400/500 for product with negative usd_price` - DB product with usd_price: -50
   - `should return 400/500 for product with NaN usd_price` - DB product with usd_price: NaN
   - `should return 400/500 for product with excessive price` - usd_price: 10000000

5. **Stripe /create-checkout-session - Item Validation (PAY-11)**
   - `should return 400 for item with zero amount (quantity)` - amount: 0
   - `should return 400 for item with negative amount` - amount: -1
   - `should return 400 for item with missing id` - no id field
   - `should return 400 for item with non-numeric id` - id: "invalid"

6. **Stripe /create-checkout-session - Currency Handling**
   - `should use stored USD price regardless of requested currency` - verify usd_price used from DB
   - `should always charge in USD via Stripe` - verify cents calculation based on usd_price

**Test Data Patterns:**
```javascript
// Invalid PayPal cart data
const cartWithNegativeAmount = [{
  name: 'Test Product',
  unit_amount: { value: '-50.00', currency_code: 'USD' },
  quantity: '1'
}];

const cartWithMixedCurrency = [
  { name: 'Product 1', unit_amount: { value: '50.00', currency_code: 'USD' }, quantity: '1' },
  { name: 'Product 2', unit_amount: { value: '150.00', currency_code: 'ILS' }, quantity: '1' }
];

// Invalid Stripe items
const itemWithZeroAmount = [{ id: 1, title: 'Test', amount: 0 }];
```

**Assertions:**
- HTTP status codes: 400 for client validation errors, 500 for server-side price validation failures
- Error response includes descriptive message
- No PayPal/Stripe API calls made for validation failures (mock not triggered)

**Mock Strategy:**
- For tests that should fail validation BEFORE API call: No mocks needed (should fail early)
- For tests that verify valid currencies work: Set up success mocks
- Use nock.pendingMocks() to verify API was NOT called for early validation failures
  </action>
  <verify>
Run tests:
```bash
cd backend && npm test -- --run payment.validation
```
All tests pass. Verify test count is at least 20 tests covering validation edge cases.
  </verify>
  <done>
Payment validation tests pass with coverage for:
- Required field validation (PAY-11)
- Negative amount rejection (PAY-12)
- Invalid currency code rejection (PAY-13)
- Edge cases for both PayPal and Stripe endpoints
  </done>
</task>

</tasks>

<verification>
1. Run `cd backend && npm test -- --run payment.validation` - all tests pass
2. Verify validation errors occur BEFORE external API calls (nock mocks unused)
3. Test count is at least 20 covering requirements PAY-11, PAY-12, PAY-13
4. All validation errors return 400 status codes
</verification>

<success_criteria>
- Payment endpoints validate required fields and return 400 for missing data (PAY-11)
- Payment endpoints reject negative amounts with 400 error (PAY-12)
- Payment endpoints reject invalid currency codes with 400 error (PAY-13)
- Validation happens before external API calls (efficient, no wasted requests)
- Error messages are descriptive for frontend display
</success_criteria>

<output>
After completion, create `.planning/phases/12-payment-processing/12-03-SUMMARY.md`
</output>
