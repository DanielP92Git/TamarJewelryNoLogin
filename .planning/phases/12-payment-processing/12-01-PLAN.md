---
phase: 12-payment-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/integration/paypal.orders.test.js
autonomous: true

must_haves:
  truths:
    - "PayPal order creation returns order ID with mocked API"
    - "PayPal order capture completes payment with mocked API"
    - "PayPal error scenarios return appropriate HTTP status codes"
    - "PayPal timeout errors are handled gracefully"
  artifacts:
    - path: "backend/tests/integration/paypal.orders.test.js"
      provides: "PayPal order and capture endpoint integration tests"
      min_lines: 200
  key_links:
    - from: "backend/tests/integration/paypal.orders.test.js"
      to: "backend/index.js"
      via: "supertest HTTP boundary testing"
      pattern: "request\\(app\\).*post.*\\/orders"
---

<objective>
Create PayPal payment endpoint integration tests with mocked API responses

Purpose: Verify PayPal order creation and capture flows work correctly without touching live PayPal API. Covers requirements PAY-01, PAY-02, PAY-03, PAY-04, PAY-05.

Output: Comprehensive test file covering PayPal happy path and error scenarios
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-payment-processing/12-CONTEXT.md

# Existing test infrastructure
@backend/tests/setup.js
@backend/tests/helpers/mocks/paypal.js
@backend/tests/helpers/mocks/index.js
@backend/tests/helpers/fixtures/products.js

# Test pattern reference
@backend/tests/integration/auth.login.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PayPal order endpoint integration tests</name>
  <files>backend/tests/integration/paypal.orders.test.js</files>
  <action>
Create integration test file for PayPal payment endpoints. Follow the established test patterns from auth.login.test.js.

**Test Structure:**
```javascript
import { describe, it, expect, beforeAll, afterAll, beforeEach } from 'vitest';
import request from 'supertest';
import mongoose from 'mongoose';
import { validateTestEnvironment } from '../helpers/envGuard.js';
import {
  disableNetConnect,
  cleanAllMocks,
  mockPayPalAuth,
  mockPayPalCreateOrder,
  mockPayPalCaptureOrder,
  mockPayPalError
} from '../helpers/mocks/index.js';
import { createProduct } from '../helpers/factories.js';
```

**Test Groups:**

1. **POST /orders - Order Creation (PAY-01)**
   - `should return 201 with order ID for valid cart` - mock PayPal auth + create order, verify response includes `id` and `links`
   - `should include approve link in response` - verify response contains approval URL
   - `should process cart with multiple items` - test cart with 2-3 items
   - `should handle USD currency correctly` - verify currency code propagates
   - `should handle ILS currency correctly` - test ILS cart items

2. **POST /orders - Validation Errors (PAY-11 partial)**
   - `should return 400 for empty cart` - cart: []
   - `should return 400 for missing cart` - no cart field
   - `should return 400 for invalid cart (not array)` - cart: "string"
   - `should return 400 for cart item missing name` - item without name field
   - `should return 400 for cart item with invalid amount` - negative/NaN amounts

3. **POST /orders - PayPal API Errors (PAY-04)**
   - `should return 400 for PayPal INVALID_REQUEST error` - mock 400 response
   - `should return 422 for PayPal UNPROCESSABLE_ENTITY` - mock 422 response
   - `should return 502 for PayPal 500 server error` - mock 500 response
   - `should include paypalDebugId in error response` - verify debug_id propagates
   - `should include paypalDetails in dev mode` - verify error details in non-prod

4. **POST /orders - Timeout Handling (PAY-05)**
   - `should handle PayPal auth token timeout` - mock timeout on /v1/oauth2/token
   - `should return 504 with PAYPAL_TIMEOUT code on timeout` - verify timeout error structure

5. **POST /orders/:orderID/capture - Order Capture (PAY-02, PAY-03)**
   - `should return 200 with COMPLETED status on successful capture` - mock auth + capture
   - `should include payment details in capture response` - verify purchase_units.payments.captures
   - `should handle already-captured order error` - mock UNPROCESSABLE_ENTITY

6. **POST /orders/:orderID/capture - Capture Errors**
   - `should return 404 for non-existent order` - mock ORDER_NOT_FOUND error
   - `should return 422 for order not approved` - mock ORDER_NOT_APPROVED error
   - `should handle capture timeout` - mock timeout on capture

**Mock Setup Pattern:**
```javascript
beforeEach(async () => {
  cleanAllMocks();
});

// In each test, set up mocks BEFORE making request:
mockPayPalAuth('test-token');
mockPayPalCreateOrder('PAYPAL-ORDER-123', 'CREATED');
```

**Cart Data Pattern:**
Use realistic jewelry data matching store products:
```javascript
const validCart = [
  {
    name: 'Silver Necklace',
    unit_amount: { value: '75.00', currency_code: 'USD' },
    quantity: '1'
  }
];
```

**Assertions:**
- HTTP status codes (201, 400, 500, 502, 504)
- Response body structure (id, links, status)
- Error response structure (error, code, paypalDebugId)
- Mock verification with pendingMocks() if needed
  </action>
  <verify>
Run tests:
```bash
cd backend && npm test -- --run paypal.orders
```
All tests pass. Verify test count is at least 15 tests covering all scenarios.
  </verify>
  <done>
PayPal endpoint tests pass with coverage for:
- Order creation success (PAY-01)
- Order capture success (PAY-02, PAY-03)
- PayPal API errors (PAY-04)
- Timeout handling (PAY-05)
- Cart validation errors (partial PAY-11)
  </done>
</task>

</tasks>

<verification>
1. Run `cd backend && npm test -- --run paypal.orders` - all tests pass
2. Verify no real PayPal API calls by checking nock.pendingMocks() is empty after each test
3. Test count is at least 15 covering requirements PAY-01 through PAY-05
4. Error scenarios return correct HTTP status codes and error structures
</verification>

<success_criteria>
- PayPal order creation tests pass with mocked responses (PAY-01)
- PayPal order capture tests pass with mocked responses (PAY-02, PAY-03)
- PayPal error handling tests cover declined/invalid scenarios (PAY-04)
- PayPal timeout tests verify graceful failure (PAY-05)
- No live PayPal API calls during test execution
</success_criteria>

<output>
After completion, create `.planning/phases/12-payment-processing/12-01-SUMMARY.md`
</output>
