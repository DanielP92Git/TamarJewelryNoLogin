---
phase: 12-payment-processing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/integration/stripe.checkout.test.js
autonomous: true

must_haves:
  truths:
    - "Stripe checkout session creation returns session ID and URL"
    - "Stripe error scenarios return appropriate HTTP status codes"
    - "Stripe card decline errors are handled with user-friendly messages"
    - "Stripe network failures return 500 with error details"
  artifacts:
    - path: "backend/tests/integration/stripe.checkout.test.js"
      provides: "Stripe checkout session endpoint integration tests"
      min_lines: 200
  key_links:
    - from: "backend/tests/integration/stripe.checkout.test.js"
      to: "backend/index.js"
      via: "supertest HTTP boundary testing"
      pattern: "request\\(app\\).*post.*\\/create-checkout-session"
---

<objective>
Create Stripe checkout session endpoint integration tests with mocked API responses

Purpose: Verify Stripe checkout session creation works correctly without touching live Stripe API. Covers requirements PAY-06, PAY-07, PAY-08, PAY-09, PAY-10.

Output: Comprehensive test file covering Stripe happy path and error scenarios
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-payment-processing/12-CONTEXT.md

# Existing test infrastructure
@backend/tests/setup.js
@backend/tests/helpers/mocks/stripe.js
@backend/tests/helpers/mocks/index.js
@backend/tests/helpers/fixtures/products.js
@backend/tests/helpers/factories.js

# Test pattern reference
@backend/tests/integration/auth.login.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe checkout session integration tests</name>
  <files>backend/tests/integration/stripe.checkout.test.js</files>
  <action>
Create integration test file for Stripe checkout session endpoint. Follow established test patterns.

**Important:** The /create-checkout-session endpoint fetches product from database, so tests need to create products first.

**Test Structure:**
```javascript
import { describe, it, expect, beforeAll, afterAll, beforeEach } from 'vitest';
import request from 'supertest';
import mongoose from 'mongoose';
import nock from 'nock';
import { validateTestEnvironment } from '../helpers/envGuard.js';
import { disableNetConnect, cleanAllMocks } from '../helpers/mocks/index.js';
import { createProduct } from '../helpers/factories.js';
```

**Stripe API Mocking:**
The Stripe SDK uses HTTPS to api.stripe.com. Create mock helpers or use nock directly:
```javascript
function mockStripeCheckoutSession(sessionId = 'cs_test_123', url = 'https://checkout.stripe.com/pay/cs_test_123') {
  return nock('https://api.stripe.com')
    .post('/v1/checkout/sessions')
    .reply(200, {
      id: sessionId,
      object: 'checkout_session',
      url: url,
      currency: 'usd',
      amount_total: 7500,
      amount_subtotal: 7500,
      payment_status: 'unpaid',
      status: 'open'
    });
}

function mockStripeSessionRetrieve(sessionId = 'cs_test_123') {
  return nock('https://api.stripe.com')
    .get(`/v1/checkout/sessions/${sessionId}`)
    .query(true) // Match any query params (expand)
    .reply(200, {
      id: sessionId,
      object: 'checkout_session',
      currency: 'usd',
      amount_total: 7500,
      line_items: { data: [] }
    });
}
```

**Test Groups:**

1. **POST /create-checkout-session - Success (PAY-06, PAY-07)**
   - `should return 200 with sessionId and url for valid items` - create product in DB, mock Stripe API, verify response
   - `should process multiple items correctly` - test with 2 items
   - `should use USD currency from database product` - verify usd_price is used
   - `should convert price to cents for Stripe` - $75 becomes 7500 cents

2. **POST /create-checkout-session - Validation Errors**
   - `should return 400 for empty items array` - items: []
   - `should return 400 for missing items` - no items field
   - `should return 400 for invalid product id` - id: "invalid"
   - `should return 404 for non-existent product` - product not in DB
   - `should return 400 for out of stock product` - quantity: 0

3. **POST /create-checkout-session - Stripe Errors (PAY-08, PAY-09, PAY-10)**
   - `should return 500 for Stripe card_declined error` - mock card_error
   - `should return 500 for Stripe insufficient_funds error` - mock specific decline code
   - `should return 500 for Stripe network failure` - mock connection error
   - `should return 500 for Stripe API timeout` - mock delayed response / timeout
   - `should include error message in response` - verify error: "Failed to create checkout session"

4. **POST /create-checkout-session - Price Validation**
   - `should reject product with zero price` - product.usd_price = 0
   - `should reject product with negative price` - product.usd_price = -10
   - `should reject product with non-numeric price` - product.usd_price = "invalid"

**Product Setup Pattern:**
```javascript
// Create product in database before each test
let Product;
beforeAll(async () => {
  Product = mongoose.model('Product');
});

// In test:
const product = await Product.create({
  id: 1,
  name: 'Test Necklace',
  usd_price: 75,
  quantity: 10,
  category: 'necklaces',
  images: [{ desktop: 'test.jpg', mobile: 'test.jpg' }]
});

// Then make request with matching item
const response = await request(app)
  .post('/create-checkout-session')
  .send({
    items: [{ id: product.id, title: product.name, amount: 1 }],
    currency: 'usd'
  });
```

**Assertions:**
- HTTP status codes (200, 400, 404, 500)
- Response body structure (sessionId, url)
- Error response structure (error message)
- Price conversion accuracy (dollars to cents)
  </action>
  <verify>
Run tests:
```bash
cd backend && npm test -- --run stripe.checkout
```
All tests pass. Verify test count is at least 12 tests covering all scenarios.
  </verify>
  <done>
Stripe checkout tests pass with coverage for:
- Session creation success (PAY-06, PAY-07)
- Card decline errors (PAY-08)
- Insufficient funds errors (PAY-09)
- Network failures (PAY-10)
- Input validation and price handling
  </done>
</task>

</tasks>

<verification>
1. Run `cd backend && npm test -- --run stripe.checkout` - all tests pass
2. Verify no real Stripe API calls by checking nock interceptors
3. Test count is at least 12 covering requirements PAY-06 through PAY-10
4. Error scenarios return correct HTTP status codes
</verification>

<success_criteria>
- Stripe checkout session creation tests pass with mocked responses (PAY-06)
- Session includes sessionId and URL for checkout redirect (PAY-07)
- Card decline errors are handled appropriately (PAY-08)
- Insufficient funds errors are handled (PAY-09)
- Network failures return 500 with error details (PAY-10)
- No live Stripe API calls during test execution
</success_criteria>

<output>
After completion, create `.planning/phases/12-payment-processing/12-02-SUMMARY.md`
</output>
