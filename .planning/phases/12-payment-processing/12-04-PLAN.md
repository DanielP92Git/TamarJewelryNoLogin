---
phase: 12-payment-processing
plan: 04
type: execute
wave: 2
depends_on: ["12-02"]
files_modified:
  - backend/tests/integration/stripe.webhook.test.js
autonomous: true

must_haves:
  truths:
    - "Stripe webhook validates signature correctly"
    - "Webhook rejects requests with missing signature"
    - "Webhook processes checkout.session.completed events"
    - "Webhook returns 400 for invalid signatures"
  artifacts:
    - path: "backend/tests/integration/stripe.webhook.test.js"
      provides: "Stripe webhook endpoint integration tests"
      min_lines: 100
  key_links:
    - from: "backend/tests/integration/stripe.webhook.test.js"
      to: "backend/index.js"
      via: "supertest HTTP boundary testing"
      pattern: "request\\(app\\).*post.*\\/webhook"
---

<objective>
Create Stripe webhook endpoint integration tests for payment event handling

Purpose: Verify Stripe webhook signature validation and event processing work correctly. While not explicitly in requirements PAY-01 through PAY-13, webhook handling is critical for payment completion flow.

Output: Test file covering webhook signature validation and event processing
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-payment-processing/12-CONTEXT.md

# Reference the completed Stripe plan
@.planning/phases/12-payment-processing/12-02-SUMMARY.md

# Existing test infrastructure
@backend/tests/setup.js
@backend/tests/helpers/mocks/stripe.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe webhook integration tests</name>
  <files>backend/tests/integration/stripe.webhook.test.js</files>
  <action>
Create integration test file for Stripe webhook endpoint (/webhook).

**Important:** Stripe webhooks require signature verification. The app uses `stripe.webhooks.constructEvent()` which needs:
1. Raw request body (req.rawBody)
2. stripe-signature header
3. Webhook secret (WEBHOOK_SEC)

**Test Structure:**
```javascript
import { describe, it, expect, beforeAll, afterAll, beforeEach } from 'vitest';
import request from 'supertest';
import crypto from 'crypto';
import { validateTestEnvironment } from '../helpers/envGuard.js';
import { disableNetConnect, cleanAllMocks } from '../helpers/mocks/index.js';
```

**Stripe Webhook Signature Generation:**
```javascript
// Helper to generate valid Stripe signature for testing
function generateStripeSignature(payload, secret) {
  const timestamp = Math.floor(Date.now() / 1000);
  const signedPayload = `${timestamp}.${payload}`;
  const signature = crypto
    .createHmac('sha256', secret)
    .update(signedPayload)
    .digest('hex');
  return `t=${timestamp},v1=${signature}`;
}
```

**Test Groups:**

1. **POST /webhook - Signature Validation**
   - `should return 400 for missing stripe-signature header` - no header
   - `should return 400 for missing payload` - empty body
   - `should return 400 for invalid signature` - wrong signature
   - `should return 400 for tampered payload` - valid sig but modified body

2. **POST /webhook - Event Processing**
   - `should return 200 with {received: true} for valid webhook` - valid signature + payload
   - `should process checkout.session.completed event` - event.type = 'checkout.session.completed'
   - `should ignore unhandled event types` - event.type = 'payment_intent.created'

3. **POST /webhook - Edge Cases**
   - `should handle expired timestamp in signature` - old timestamp
   - `should handle malformed JSON payload` - invalid JSON
   - `should handle missing event.type` - payload without type field

**Webhook Payload Pattern:**
```javascript
const checkoutCompleteEvent = {
  id: 'evt_test_123',
  object: 'event',
  type: 'checkout.session.completed',
  data: {
    object: {
      id: 'cs_test_123',
      object: 'checkout_session',
      payment_status: 'paid',
      metadata: {
        productId: '1'
      }
    }
  },
  created: Math.floor(Date.now() / 1000)
};
```

**Test Setup:**
```javascript
let app;
const TEST_WEBHOOK_SECRET = 'whsec_test_secret_123';

beforeAll(async () => {
  validateTestEnvironment();
  disableNetConnect();

  // Set webhook secret for tests
  process.env.WEBHOOK_SEC = TEST_WEBHOOK_SECRET;

  const appModule = await import('../../index.js');
  app = appModule.app;
});
```

**Making Webhook Requests:**
```javascript
const payload = JSON.stringify(checkoutCompleteEvent);
const signature = generateStripeSignature(payload, TEST_WEBHOOK_SECRET);

const response = await request(app)
  .post('/webhook')
  .set('Content-Type', 'application/json')
  .set('stripe-signature', signature)
  .send(payload)
  .expect(200);
```

**Assertions:**
- HTTP status codes (200 for valid, 400 for invalid signature)
- Response body for valid: { received: true }
- Signature verification behavior
- Event type handling
  </action>
  <verify>
Run tests:
```bash
cd backend && npm test -- --run stripe.webhook
```
All tests pass. Verify test count is at least 10 tests.
  </verify>
  <done>
Stripe webhook tests pass with coverage for:
- Signature validation (missing, invalid, tampered)
- Successful event processing
- checkout.session.completed handling
- Edge cases (expired timestamp, malformed JSON)
  </done>
</task>

</tasks>

<verification>
1. Run `cd backend && npm test -- --run stripe.webhook` - all tests pass
2. Webhook signature validation works correctly
3. Test count is at least 10 covering signature validation and event handling
4. Invalid signatures return 400 status codes
</verification>

<success_criteria>
- Webhook validates Stripe signature correctly
- Missing/invalid signatures return 400
- Valid webhooks return { received: true }
- checkout.session.completed events are processed
- Unhandled event types are gracefully ignored
</success_criteria>

<output>
After completion, create `.planning/phases/12-payment-processing/12-04-SUMMARY.md`
</output>
