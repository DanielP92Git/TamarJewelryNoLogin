---
phase: 20-page-view-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tests/views/modal.test.js
  - frontend/tests/views/categories.test.js
autonomous: true

must_haves:
  truths:
    - "Product modal renders product images (main big image and thumbnail sidebar)"
    - "Product modal displays product description text"
    - "Product modal shows price in the currently selected currency"
    - "Add-to-cart button in modal triggers model.handleAddToCart"
    - "Modal closes when X button clicked"
    - "Modal closes when backdrop (overlay) clicked"
    - "Modal closes when Escape key pressed"
    - "Categories view displays products fetched for a specific category"
  artifacts:
    - path: "frontend/tests/views/modal.test.js"
      provides: "Product modal rendering, close methods, and add-to-cart tests"
      min_lines: 120
    - path: "frontend/tests/views/categories.test.js"
      provides: "Category product filtering and display tests"
      min_lines: 60
  key_links:
    - from: "frontend/tests/views/modal.test.js"
      to: "frontend/js/Views/categoriesView.js"
      via: "CategoriesView.generatePreview renders modal"
      pattern: "generatePreview|closeModal|isModalOpen"
    - from: "frontend/tests/views/categories.test.js"
      to: "frontend/js/Views/categoriesView.js"
      via: "CategoriesView.displayProducts renders product list"
      pattern: "displayProducts|fetchProductsByCategory"
    - from: "frontend/js/Views/categoriesView.js"
      to: "frontend/js/model.js"
      via: "model.handleAddToCart for add-to-cart action"
      pattern: "model\\.handleAddToCart"
---

<objective>
Test CategoriesView product modal (images, description, price, close methods, add-to-cart) and category product filtering/display.

Purpose: Verify PAGE-05 through PAGE-08 (modal) and PAGE-11 (categories) requirements -- modal is the primary product detail surface, categories is the main product listing.
Output: `frontend/tests/views/modal.test.js` and `frontend/tests/views/categories.test.js`
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-page-view-tests/20-CONTEXT.md
@.planning/phases/20-page-view-tests/20-RESEARCH.md

Source files to test:
@frontend/js/Views/categoriesView.js
@frontend/js/View.js
@frontend/js/model.js

Existing test infrastructure:
@frontend/tests/setup.js
@frontend/tests/helpers/dom.js
@frontend/tests/helpers/factories.js
@frontend/vitest.config.js

Established patterns:
@frontend/tests/view/language.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create product modal rendering, close, and add-to-cart tests</name>
  <files>frontend/tests/views/modal.test.js</files>
  <action>
Create `frontend/tests/views/modal.test.js` covering PAGE-05 through PAGE-08 requirements.

**CRITICAL architectural understanding:**

1. **CategoriesView is a singleton** -- exported as `export default new CategoriesView()`. The constructor is complex: it sets up DOMContentLoaded listeners, window.load listeners, and a 1-second setTimeout for initialization. The constructor calls `this.checkAndInitialize()` which checks for `body.id.includes('categories')`. This means tests need careful setup.

2. **The modal is NOT a standalone component** -- it's generated by `CategoriesView.generatePreview(item, imageMarkup, hasMultipleImages)`. The `generatePreview` method receives a clicked DOM item element and renders the full modal HTML into `.modal`, then calls `_setupModalEventListeners()`.

3. **Testing strategy for modal:** Rather than fighting the full CategoriesView initialization flow (which involves fetch, scroll listeners, DOMContentLoaded), test the modal in a more targeted way:
   - Option A: Directly call `generatePreview()` with a mock item element after setting up `this.products` array. This tests the actual modal rendering logic.
   - Option B: Set up the modal HTML that `generatePreview` would create and test the `_setupModalEventListeners()` behavior.
   - **Prefer Option A** for rendering tests (PAGE-05, 06, 07) and Option A + event testing for interactions (PAGE-08, close methods).

4. **CategoriesView has auto-initialization that needs suppressing.** The constructor immediately starts trying to initialize. For tests, we need to:
   - Set `document.body.id` to NOT include 'categories' initially (to prevent auto-init)
   - OR mock the fetch to prevent network calls
   - OR use `vi.useFakeTimers()` to prevent the setTimeout auto-init

5. **Key methods to understand:**
   - `generatePreview(item, imageMarkup, hasMultipleImages)` -- item is a DOM element with dataset properties and querySelector method
   - `closeModal()` -- clears modal innerHTML, sets isModalOpen=false, restores body scroll
   - `_setupModalEventListeners()` -- sets up close button, overlay click, Escape key, thumbnail clicks, add-to-cart
   - `addFromPrev(data)` -- called by modal add-to-cart button, calls model.handleAddToCart

6. **process.env.NODE_ENV** is used in the constructor (setupImageSourceDebugger). Set it or mock it.

**DOM fixture for modal tests:**
```
<header></header>
<div class="menu"></div>
<div data-purpose="header-utilities"></div>
<div class="footer"></div>
<div class="modal"></div>
<div class="outer-products-container">
  <div class="inner-products-container"></div>
  <div class="loader spinner-hidden"></div>
</div>
<div class="category-title">NECKLACES</div>
```
Note: body id should NOT be 'categories-page' during import to avoid auto-init. Set it after import if needed.

**Test structure:**

1. **Modal Image Rendering (PAGE-05)**
   - "should render main big image from product data" -- After generatePreview, verify `.big-image` src matches product's first image
   - "should render thumbnail sidebar with all product images" -- Verify `.small-image-thumb` count matches product images count
   - "should update big image when thumbnail clicked" -- Click a thumbnail, verify `.big-image` src changes to that thumbnail's image

2. **Modal Description Display (PAGE-06)**
   - "should display product description in modal" -- Verify `.item-description_modal` contains product description text
   - "should display product title in modal" -- Verify `.item-title_modal` contains product name

3. **Modal Price Display (PAGE-07)**
   - "should show price with current currency symbol in modal" -- Verify `.price-text-modal` contains price with $ or shekel symbol
   - "should show USD price when currency is USD" -- Set currency to 'usd', verify price shows $ symbol
   - "should show ILS price when currency is ILS" -- Set currency to 'ils', verify price shows shekel symbol

4. **Modal Add to Cart (PAGE-08)**
   - "should call model.handleAddToCart when add-to-cart button clicked" -- Spy on model.handleAddToCart, click `.add-to-cart-btn_modal`, verify spy called
   - "should increment cart number after adding to cart" -- Verify `.cart-number-mobile` text increments
   - "should show 'Added to Cart!' feedback after click" -- Verify button text changes temporarily

5. **Modal Close Methods**
   - "should close modal when X button clicked" -- Click `.close-modal-btn`, verify modal innerHTML is empty and isModalOpen is false
   - "should close modal when overlay background clicked" -- Click `.item-overlay` (not modal-content), verify modal closed
   - "should close modal when Escape key pressed" -- This is NOT in _setupModalEventListeners. Check if there's a global keydown handler. If not, note it as not implemented and skip.

**Mocking strategy for generatePreview:**
Create a mock DOM element that mimics what `addHandlerPreview`'s click handler provides:
```javascript
const mockItem = document.createElement('div');
mockItem.classList.add('item-container');
mockItem.dataset.id = '101';
mockItem.dataset.quant = '10';
mockItem.dataset.currency = '$';
mockItem.innerHTML = `
  <img class="front-image" src="https://example.com/main.jpg" />
  <div class="item-title">Test Necklace</div>
  <div class="item-price">$50</div>
`;
```

Also set `categoriesView.products` array with a matching product so `generatePreview` can find the product by ID.

Mock `model.handleAddToCart` with `vi.spyOn()`.
Mock `process.env.NODE_ENV` as 'test' or 'production'.
Mock `fetch` as `vi.fn()` to prevent real API calls.

**Important: The CategoriesView singleton will auto-initialize.** To handle this:
- Mock fetch globally before import
- Set body.id to something neutral
- Use `vi.useFakeTimers()` if needed to control the setTimeout
- Consider using `vi.mock()` to mock the module partially

Run `npx vitest run tests/views/modal.test.js` from frontend directory to verify.
  </action>
  <verify>
Run `cd frontend && npx vitest run tests/views/modal.test.js` -- all tests pass with 0 failures.
Verify at least 10 test cases covering modal rendering, close, and add-to-cart.
  </verify>
  <done>
Modal tests prove:
- PAGE-05: Product modal renders product images in gallery
- PAGE-06: Product modal displays product description
- PAGE-07: Product modal shows price in current currency
- PAGE-08: Add-to-cart button triggers cart update
- Modal close works via X button and backdrop click
  </done>
</task>

<task type="auto">
  <name>Task 2: Create categories view product filtering tests</name>
  <files>frontend/tests/views/categories.test.js</files>
  <action>
Create `frontend/tests/views/categories.test.js` covering PAGE-11 requirement.

**Architecture understanding:**
- `CategoriesView.fetchProductsByCategory()` POSTs to `${this.apiUrl}/productsByCategory` with `{ category, page }`
- Response is `{ products: [...], hasMore: boolean }` or a direct array
- Products are stored in `this.products` array
- `displayProducts()` clears inner container and renders all products via `getProductMarkup(item)`
- Products are filtered by `quantity > 0` before display

**Testing strategy:**
Since full initialization is complex, test the rendering pipeline more directly:
1. Set up the CategoriesView instance with properties set
2. Populate `this.products` with test product data
3. Call `displayProducts()` directly
4. Verify rendered product markup

Alternatively, test via `fetchProductsByCategory()` by mocking fetch to return product data and verifying the rendered output.

**Test structure:**

1. **Product Filtering by Category (PAGE-11)**
   - "should display products returned by category API" -- Mock fetch to return necklaces products, trigger fetch, verify product names appear
   - "should render product markup with name, price, and image" -- Verify each product has `.item-title`, `.item-price`, and `.front-image`
   - "should filter out zero-quantity products" -- Return mix of quantity>0 and quantity=0 products, verify only in-stock shown
   - "should display correct currency symbol for products" -- Set selectedCurrency to 'usd', verify '$' in price markup
   - "should show 'Add to Cart' button for each product" -- Verify `.add-to-cart-btn` exists for each rendered product

2. **Product Display Details**
   - "should set product data attributes (id, currency, prices)" -- Verify data-id, data-usd-price, data-ils-price attributes
   - "should truncate long descriptions" -- Product with 200+ char description, verify it's cut to 150 chars with '...'

**DOM fixture:**
```
<header></header>
<div class="menu"></div>
<div data-purpose="header-utilities"></div>
<div class="footer"></div>
<div class="modal"></div>
<div class="outer-products-container">
  <div class="inner-products-container"></div>
  <div class="loader spinner-hidden"></div>
</div>
<div class="category-title">NECKLACES</div>
```

**Mocking strategy:**
- Mock fetch globally with `vi.fn()` before CategoriesView import
- Use `vi.useFakeTimers()` to control constructor's setTimeout
- Set `categoriesView.products` directly and call `displayProducts()` for simple rendering tests
- For fetch integration test: mock `global.fetch` to return products, then trigger `fetchProductsByCategory()`

**Product test data** (use createProduct factory, extend with needed fields):
```javascript
const products = [
  createProduct({ id: 1, name: 'Gold Necklace', usd_price: 50, ils_price: 185, quantity: 5 }),
  createProduct({ id: 2, name: 'Silver Bracelet', usd_price: 30, ils_price: 111, quantity: 3 }),
  createProduct({ id: 3, name: 'Out of Stock Item', usd_price: 25, ils_price: 93, quantity: 0 })
];
```

Run `npx vitest run tests/views/categories.test.js` from frontend directory to verify.
  </action>
  <verify>
Run `cd frontend && npx vitest run tests/views/categories.test.js` -- all tests pass with 0 failures.
Verify at least 5 test cases covering product display and filtering.
  </verify>
  <done>
Categories tests prove:
- PAGE-11: Categories view displays products filtered by category
- Products render with correct name, price, image, and data attributes
- Zero-quantity products filtered out
- Currency symbol displayed correctly
  </done>
</task>

</tasks>

<verification>
Run full frontend test suite: `cd frontend && npx vitest run`
- All existing tests still pass (no regressions)
- New modal.test.js and categories.test.js tests all pass
- Test count increases by 15+ tests
</verification>

<success_criteria>
- frontend/tests/views/modal.test.js exists with 10+ passing tests
- frontend/tests/views/categories.test.js exists with 5+ passing tests
- PAGE-05 through PAGE-08 (modal) requirements verified
- PAGE-11 (categories filtering) requirement verified
- Modal close methods tested (X button, backdrop)
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/20-page-view-tests/20-02-SUMMARY.md`
</output>
