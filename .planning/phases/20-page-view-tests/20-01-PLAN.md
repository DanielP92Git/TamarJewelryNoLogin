---
phase: 20-page-view-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tests/views/cart.test.js
autonomous: true

must_haves:
  truths:
    - "Cart view displays each cart item's product name"
    - "Cart view shows correct quantity for each item"
    - "Cart view displays prices in the current currency (USD or ILS)"
    - "Cart view total calculates correctly as sum of (price x amount) for all items"
    - "Empty cart shows 'Your Cart Is Empty' message and hides summary"
    - "Currency switch triggers re-render with updated prices and symbol"
  artifacts:
    - path: "frontend/tests/views/cart.test.js"
      provides: "Cart view rendering and interaction tests"
      min_lines: 150
  key_links:
    - from: "frontend/tests/views/cart.test.js"
      to: "frontend/js/Views/cartView.js"
      via: "import CartView"
      pattern: "import.*cartView"
    - from: "frontend/js/Views/cartView.js"
      to: "frontend/js/model.js"
      via: "model.cart array for rendering"
      pattern: "model\\.cart"
---

<objective>
Test CartView rendering accuracy: items display correct names, quantities, and prices; totals add up; empty cart handled; currency switching re-renders prices.

Purpose: Verify PAGE-01 through PAGE-04 requirements -- cart view is the core e-commerce interaction surface.
Output: `frontend/tests/views/cart.test.js` with comprehensive cart view tests.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-page-view-tests/20-CONTEXT.md
@.planning/phases/20-page-view-tests/20-RESEARCH.md

Source files to test:
@frontend/js/Views/cartView.js
@frontend/js/View.js
@frontend/js/model.js

Existing test infrastructure:
@frontend/tests/setup.js
@frontend/tests/helpers/dom.js
@frontend/tests/helpers/factories.js
@frontend/vitest.config.js

Established patterns (reference for DOM fixture + View instantiation):
@frontend/tests/view/language.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cart view display and totals tests</name>
  <files>frontend/tests/views/cart.test.js</files>
  <action>
Create `frontend/tests/views/cart.test.js` covering PAGE-01 through PAGE-04 requirements.

**CRITICAL architectural understanding before writing tests:**

1. **CartView is a singleton** -- it's exported as `export default new CartView()`. The constructor runs at import time and calls `document.querySelector(...)` for all its element references (`_parentElement`, `_cartEmpty`, `_cartTitle`, etc.). This means the DOM fixture MUST be in place BEFORE importing CartView. Use dynamic `import()` inside `beforeEach` after `render()`, or alternatively, mock the module to avoid constructor side effects. The Phase 19 approach of `new View()` worked because View's constructor doesn't grab DOM refs the same way.

2. **CartView reads from `model.cart` array** (not localStorage directly) for rendering. The `_generateMarkup(cartNum)` method iterates `model.cart` to build item HTML. The `_calculateTotal()` and `_calculateOriginalTotal()` methods also read `model.cart`. So tests need to populate `model.cart` before triggering render, OR mock `model.cart` and `model.checkCartNumber`.

3. **CartView uses `process.env.API_URL`** and `process.env.USD_ILS_RATE`. Mock these with `vi.stubEnv()` or ensure they're defined.

4. **CartView uses `require('dotenv').config()`** at the top level. This may cause issues in the test environment. Mock it or handle the import error.

5. **The render flow is:** `view.render(cartNum)` calls `_generateMarkup(cartNum)` which reads `model.cart` and inserts HTML into `_itemsBox`. Then `_renderSummary(cartNum, lng)` builds the summary with totals.

**DOM fixture required** (must be present before CartView import):
```
<header></header>
<div class="menu"></div>
<div data-purpose="header-utilities"></div>
<div class="footer"></div>
<div class="cart-items-container"></div>
<div class="cart-empty">Your Cart Is Empty</div>
<h2 class="cart-title">Your Cart</h2>
<h3 class="summary-title">Order Summary</h3>
<div class="added-items"></div>
<div class="summary-details"></div>
<button id="stripe-checkout-btn">Checkout</button>
<button class="delete-all">Delete All</button>
<div class="check-me-out">Check Me Out With:</div>
<div class="summary"></div>
```

**Test structure with describe blocks:**

1. **Cart Item Display (PAGE-01, PAGE-02, PAGE-03)**
   - "should display cart items with correct product names" -- Populate model.cart with 2 items, call render(), verify item titles appear in DOM
   - "should show correct quantity for each item" -- Cart items with amount field, verify quantity inputs show correct values
   - "should display prices in USD when USD currency selected" -- Set localStorage currency to 'usd', render, verify $ symbol and USD prices
   - "should display prices in ILS when ILS currency selected" -- Set localStorage currency to 'ils', render, verify shekel symbol and ILS prices
   - "should display both USD and ILS price fields from stored dual-currency data" -- Cart items have both usdPrice and ilsPrice, verify correct one shown per currency

2. **Cart Total Calculation (PAGE-04)**
   - "should calculate correct total for single item" -- 1 item with known price, verify summary shows correct total
   - "should calculate correct total across multiple items" -- 2+ items, verify sum (price1 + price2 + ...) in summary
   - "should calculate total with discounted prices when discount active" -- Items with discountedPrice field, verify total uses discounted amounts
   - "should show zero/empty when cart is empty" -- cartNum=0, verify summary is empty or hidden

3. **Empty Cart State**
   - "should show empty cart message when cart has no items" -- cartNum=0, verify '.cart-empty' is visible (no 'remove' class)
   - "should hide items box when cart is empty" -- verify '.added-items' has 'remove' class
   - "should hide delete all button when cart is empty" -- verify '.delete-all' has 'remove' class
   - "should hide order summary when cart is empty" -- verify '.summary' has 'remove' class

4. **Currency Switching**
   - "should re-render with ILS prices after currency-changed event" -- Start with USD, dispatch currency-changed event with {currency: 'ils'}, verify prices update
   - "should re-render with USD prices after currency-changed event" -- Start with ILS, dispatch, verify

**Mocking strategy:**
- Mock `model.cart` array directly (set items on it)
- Mock `model.checkCartNumber` to return cart length
- Mock `model.getGlobalDiscount` to return `{ active: false, percentage: 0 }`
- Mock `process.env.API_URL` and `process.env.USD_ILS_RATE`
- Use `vi.fn()` for fetch mock (for currency change handler that calls model methods)

**Cart item structure** (matching model.js addToLocalStorage output):
```javascript
{
  id: 'product-123',
  title: 'Gold Necklace',
  image: 'https://example.com/img.jpg',
  price: 185,           // Current display price
  usdPrice: 50,         // Stored USD price
  ilsPrice: 185,        // Stored ILS price
  originalPrice: 185,
  originalUsdPrice: 50,
  originalIlsPrice: 185,
  discountedPrice: null,
  amount: 1,
  quantity: 10,
  currency: '₪'
}
```

**Important implementation notes:**
- CartView._getItemPrice() reads usdPrice/ilsPrice from cart items based on localStorage currency
- CartView._getCurrencySymbol() returns '$' or '₪' based on localStorage currency
- CartView._calculateTotal() sums `discountedPrice || price` for each item
- CartView._generateMarkup() shows quantity via `item.amount` in an input field
- The `afterEach` should reset `window.__currencyPersistenceInitialized` (Phase 19 pattern)

Run `npx vitest run tests/views/cart.test.js` from frontend directory to verify all tests pass.
  </action>
  <verify>
Run `cd frontend && npx vitest run tests/views/cart.test.js` -- all tests pass with 0 failures.
Verify at least 12 test cases across the 4 describe blocks.
  </verify>
  <done>
CartView tests prove:
- PAGE-01: Cart items display correct product names
- PAGE-02: Cart items show correct quantities
- PAGE-03: Cart displays prices in current currency (USD/ILS)
- PAGE-04: Cart total calculates correctly across all items
- Empty cart state handled (message shown, summary hidden)
- Currency switching re-renders prices correctly
  </done>
</task>

</tasks>

<verification>
Run full frontend test suite: `cd frontend && npx vitest run`
- All existing tests still pass (no regressions)
- New cart.test.js tests all pass
- Test count increases by 12+ tests
</verification>

<success_criteria>
- frontend/tests/views/cart.test.js exists with 12+ passing tests
- PAGE-01 through PAGE-04 requirements verified
- Empty cart edge case tested
- Currency switching tested
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/20-page-view-tests/20-01-SUMMARY.md`
</output>
