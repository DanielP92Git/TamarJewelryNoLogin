---
phase: 10-test-infrastructure-foundation
plan: 07
type: execute
wave: 3
depends_on: ["10-01", "10-02"]
files_modified:
  - .github/workflows/test.yml
  - backend/vitest.config.js
  - frontend/vitest.config.js
autonomous: true

must_haves:
  truths:
    - "GitHub Actions workflow runs tests on every push and PR"
    - "CI pipeline runs both backend and frontend tests"
    - "Coverage reports are generated and displayed"
    - "Pipeline fails if tests fail"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "CI/CD pipeline configuration"
      contains: "npm test"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "backend/package.json"
      via: "npm test command"
      pattern: "npm test"
    - from: ".github/workflows/test.yml"
      to: "frontend/package.json"
      via: "npm test command"
      pattern: "npm test"
---

<objective>
Set up GitHub Actions CI/CD pipeline that runs tests on every commit and PR with coverage reporting.

Purpose: Ensure tests run automatically on every code change, catching regressions early and displaying coverage metrics for visibility.
Output: GitHub Actions workflow that runs backend and frontend tests with coverage reports.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-test-infrastructure-foundation/10-CONTEXT.md

# Test configurations from prior plans
@backend/vitest.config.js
@frontend/vitest.config.js
@backend/package.json
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow for tests</name>
  <files>.github/workflows/test.yml</files>
  <action>
Create .github/workflows/test.yml:

```yaml
name: Test Suite

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Run backend tests with coverage
        run: npm run test:coverage
        working-directory: backend
        env:
          NODE_ENV: test

      - name: Upload backend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage/
        if: always()

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Run frontend tests with coverage
        run: npm run test:coverage
        working-directory: frontend
        env:
          NODE_ENV: test

      - name: Upload frontend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/
        if: always()

  coverage-summary:
    name: Coverage Summary
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend-coverage
        continue-on-error: true

      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: frontend-coverage
        continue-on-error: true

      - name: Display coverage summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f backend-coverage/coverage-summary.json ]; then
            echo "### Backend Coverage" >> $GITHUB_STEP_SUMMARY
            cat backend-coverage/coverage-summary.json | head -20 >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f frontend-coverage/coverage-summary.json ]; then
            echo "### Frontend Coverage" >> $GITHUB_STEP_SUMMARY
            cat frontend-coverage/coverage-summary.json | head -20 >> $GITHUB_STEP_SUMMARY
          fi
```

This workflow:
1. Runs on pushes to master/main and on PRs
2. Tests backend and frontend in parallel
3. Uses Node.js 20 with npm caching
4. Generates coverage reports
5. Uploads coverage as artifacts
6. Creates a summary in GitHub Actions UI
  </action>
  <verify>
File exists at .github/workflows/test.yml.

Validate YAML syntax:
```bash
# If yq is available:
yq eval '.' .github/workflows/test.yml > /dev/null && echo "Valid YAML"

# Or just check file exists
ls -la .github/workflows/test.yml
```
  </verify>
  <done>
GitHub Actions workflow created:
- Triggers on push to master/main and PRs
- Runs backend and frontend tests in parallel
- Generates and uploads coverage reports
- Creates summary in GitHub UI
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure coverage reporting in Vitest configs</name>
  <files>
    backend/vitest.config.js
    frontend/vitest.config.js
  </files>
  <action>
Update backend/vitest.config.js to add coverage configuration:

```javascript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    environment: 'node',
    globals: true,
    setupFiles: ['./tests/setup.js'],
    include: ['tests/**/*.test.js'],
    exclude: ['node_modules', 'coverage'],
    testTimeout: 30000,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'json-summary', 'html'],
      reportsDirectory: './coverage',
      include: [
        'index.js',
        'middleware/**/*.js',
        'models/**/*.js',
        'services/**/*.js',
        'config/**/*.js',
        'jobs/**/*.js'
      ],
      exclude: [
        'node_modules/**',
        'tests/**',
        'coverage/**',
        '*.config.js'
      ],
      thresholds: {
        // Start with no thresholds, increase as coverage improves
        // lines: 70,
        // functions: 70,
        // branches: 60,
        // statements: 70
      }
    }
  }
});
```

Update frontend/vitest.config.js to add coverage configuration:

```javascript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./tests/setup.js'],
    include: ['tests/**/*.test.js', 'js/**/*.test.js'],
    exclude: ['node_modules', '.parcel-cache', 'dist', 'coverage'],
    testTimeout: 10000,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'json-summary', 'html'],
      reportsDirectory: './coverage',
      include: [
        'js/**/*.js'
      ],
      exclude: [
        'node_modules/**',
        'tests/**',
        'coverage/**',
        'dist/**',
        '.parcel-cache/**',
        '*.config.js'
      ],
      thresholds: {
        // Start with no thresholds, increase as coverage improves
        // lines: 70,
        // functions: 70,
        // branches: 60,
        // statements: 70
      }
    }
  }
});
```

Key coverage settings:
- v8 provider (built into Node.js, fast)
- Multiple reporters: text (console), json (machine-readable), html (browsable)
- Include source directories, exclude test/config files
- Thresholds commented out for now (enable in Phase 11+ as coverage improves)
  </action>
  <verify>
Run coverage locally:
```bash
cd backend && npm run test:coverage
cd ../frontend && npm run test:coverage
```

Both should complete and generate coverage/ directories.
  </verify>
  <done>
Coverage reporting configured:
- v8 provider for fast coverage
- Multiple output formats (text, json, html)
- Source files included, test files excluded
- Ready for threshold enforcement later
  </done>
</task>

<task type="auto">
  <name>Task 3: Add coverage directories to .gitignore</name>
  <files>.gitignore</files>
  <action>
Update the root .gitignore to exclude coverage directories:

Check if coverage is already in .gitignore. If not, add:

```
# Test coverage
coverage/
backend/coverage/
frontend/coverage/
*.lcov
```

This prevents coverage reports from being committed (they're generated fresh on each CI run and locally).

If .gitignore doesn't exist at the root, create it with these entries plus any other common exclusions that should apply project-wide.
  </action>
  <verify>
Check .gitignore contains coverage entries:
```bash
grep -i "coverage" .gitignore
```
Should show coverage/ entries.
  </verify>
  <done>
Coverage directories added to .gitignore:
- Prevents accidental commits of generated reports
- Coverage regenerated fresh on each test run
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/test.yml` exists with valid YAML
2. `cd backend && npm run test:coverage` generates coverage/ directory
3. `cd frontend && npm run test:coverage` generates coverage/ directory
4. Coverage directories are gitignored
5. Workflow will run on next push to master/main or PR (verify after commit)
</verification>

<success_criteria>
- GitHub Actions workflow triggers on push and PR
- Backend tests run in CI with coverage
- Frontend tests run in CI with coverage
- Coverage reports uploaded as artifacts
- Summary displayed in GitHub Actions UI
- Coverage thresholds ready for enforcement (commented)
- Coverage directories excluded from git
</success_criteria>

<output>
After completion, create `.planning/phases/10-test-infrastructure-foundation/10-07-SUMMARY.md`
</output>
