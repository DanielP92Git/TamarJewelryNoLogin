---
phase: 10-test-infrastructure-foundation
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - backend/tests/helpers/mocks/paypal.js
  - backend/tests/helpers/mocks/stripe.js
  - backend/tests/helpers/mocks/exchangeRate.js
  - backend/tests/helpers/mocks/s3.js
  - backend/tests/helpers/mocks/index.js
  - backend/package.json
autonomous: true

must_haves:
  truths:
    - "PayPal API calls can be mocked with configurable responses"
    - "Stripe API calls can be mocked with configurable responses"
    - "Exchange rate API calls can be mocked with fixed rates"
    - "S3/Spaces uploads can be mocked without touching real storage"
    - "No HTTP requests leave the test process to external APIs"
  artifacts:
    - path: "backend/tests/helpers/mocks/paypal.js"
      provides: "PayPal API mock patterns"
      exports: ["mockPayPalCreateOrder", "mockPayPalCaptureOrder", "mockPayPalError"]
    - path: "backend/tests/helpers/mocks/stripe.js"
      provides: "Stripe API mock patterns"
      exports: ["mockStripePaymentIntent", "mockStripeWebhook", "mockStripeError"]
    - path: "backend/tests/helpers/mocks/exchangeRate.js"
      provides: "Exchange rate API mock"
      exports: ["mockExchangeRateAPI", "mockExchangeRateError"]
    - path: "backend/tests/helpers/mocks/s3.js"
      provides: "S3/Spaces upload mock"
      exports: ["mockS3Upload", "mockS3Delete", "mockS3Error"]
  key_links:
    - from: "backend/tests/helpers/mocks/index.js"
      to: "nock"
      via: "HTTP interception"
      pattern: "nock"
---

<objective>
Install nock HTTP mocking library and create reusable mock patterns for all external APIs (PayPal, Stripe, exchange rate, S3).

Purpose: Enable integration tests to run without making real HTTP requests to payment providers, exchange rate APIs, or file storage services.
Output: Mock helper modules with configurable success and error responses for each external service.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-test-infrastructure-foundation/10-CONTEXT.md

# External API patterns reference
@.planning/codebase/INTEGRATIONS.md

# Backend index.js for API endpoint patterns
@backend/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install nock and create mock infrastructure</name>
  <files>
    backend/package.json
    backend/tests/helpers/mocks/index.js
  </files>
  <action>
Install nock as dev dependency:
```bash
cd backend
npm install --save-dev nock
```

Create backend/tests/helpers/mocks/index.js as the main mock orchestrator:

```javascript
/**
 * Mock orchestrator for external API mocking in tests.
 * Uses nock to intercept HTTP requests and return configurable responses.
 */
import nock from 'nock';

// Re-export all mocks for convenience
export * from './paypal.js';
export * from './stripe.js';
export * from './exchangeRate.js';
export * from './s3.js';

/**
 * Disable all real HTTP requests in tests.
 * Call this in beforeAll to ensure no requests escape to real APIs.
 */
export function disableNetConnect() {
  nock.disableNetConnect();
  // Allow localhost for supertest integration tests
  nock.enableNetConnect('127.0.0.1');
}

/**
 * Re-enable real HTTP requests (for cleanup).
 */
export function enableNetConnect() {
  nock.enableNetConnect();
}

/**
 * Clear all pending nock interceptors.
 * Call in afterEach to ensure clean state between tests.
 */
export function cleanAllMocks() {
  nock.cleanAll();
}

/**
 * Check if any nock interceptors are still pending (unused).
 * Useful for verifying all expected API calls were made.
 */
export function pendingMocks() {
  return nock.pendingMocks();
}

/**
 * Assert no pending mocks remain.
 * Throws if any expected API calls were not made.
 */
export function assertAllMocksUsed() {
  const pending = pendingMocks();
  if (pending.length > 0) {
    throw new Error(`Unused mocks: ${pending.join(', ')}`);
  }
}
```
  </action>
  <verify>
Run `npm ls nock` in backend directory - nock listed.
File exists at backend/tests/helpers/mocks/index.js.
  </verify>
  <done>
nock installed as devDependency.
Mock orchestrator created with utilities for disabling real HTTP, cleanup, and verification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PayPal and Stripe mock patterns</name>
  <files>
    backend/tests/helpers/mocks/paypal.js
    backend/tests/helpers/mocks/stripe.js
  </files>
  <action>
Create backend/tests/helpers/mocks/paypal.js:

```javascript
/**
 * PayPal API mock patterns.
 * Mocks PayPal REST API endpoints used for order creation and capture.
 */
import nock from 'nock';

const PAYPAL_SANDBOX_URL = 'https://api-m.sandbox.paypal.com';

/**
 * Mock PayPal OAuth token endpoint.
 * PayPal requires token before any API call.
 */
export function mockPayPalAuth(accessToken = 'test-access-token') {
  return nock(PAYPAL_SANDBOX_URL)
    .post('/v1/oauth2/token')
    .reply(200, {
      access_token: accessToken,
      token_type: 'Bearer',
      expires_in: 32400
    });
}

/**
 * Mock PayPal create order endpoint.
 * @param {string} orderId - The order ID to return
 * @param {string} status - Order status (CREATED, APPROVED, etc.)
 */
export function mockPayPalCreateOrder(orderId = 'PAYPAL-ORDER-123', status = 'CREATED') {
  return nock(PAYPAL_SANDBOX_URL)
    .post('/v2/checkout/orders')
    .reply(201, {
      id: orderId,
      status: status,
      links: [
        { rel: 'approve', href: `https://sandbox.paypal.com/checkoutnow?token=${orderId}` },
        { rel: 'capture', href: `${PAYPAL_SANDBOX_URL}/v2/checkout/orders/${orderId}/capture` }
      ]
    });
}

/**
 * Mock PayPal capture order endpoint.
 * @param {string} orderId - The order ID being captured
 */
export function mockPayPalCaptureOrder(orderId = 'PAYPAL-ORDER-123') {
  return nock(PAYPAL_SANDBOX_URL)
    .post(`/v2/checkout/orders/${orderId}/capture`)
    .reply(200, {
      id: orderId,
      status: 'COMPLETED',
      purchase_units: [{
        payments: {
          captures: [{
            id: 'CAPTURE-123',
            status: 'COMPLETED',
            amount: { value: '100.00', currency_code: 'USD' }
          }]
        }
      }]
    });
}

/**
 * Mock PayPal error response.
 * @param {number} statusCode - HTTP status code
 * @param {string} errorCode - PayPal error code
 */
export function mockPayPalError(statusCode = 400, errorCode = 'INVALID_REQUEST') {
  return nock(PAYPAL_SANDBOX_URL)
    .post(/\/v2\/checkout\/orders/)
    .reply(statusCode, {
      name: errorCode,
      message: 'Test error message',
      debug_id: 'debug-123'
    });
}
```

Create backend/tests/helpers/mocks/stripe.js:

```javascript
/**
 * Stripe API mock patterns.
 * Mocks Stripe API endpoints for payment intents and webhooks.
 */
import nock from 'nock';

const STRIPE_API_URL = 'https://api.stripe.com';

/**
 * Mock Stripe create payment intent endpoint.
 * @param {Object} options - Payment intent options
 */
export function mockStripePaymentIntent({
  id = 'pi_test_123',
  clientSecret = 'pi_test_123_secret_abc',
  status = 'requires_payment_method',
  amount = 10000,
  currency = 'usd'
} = {}) {
  return nock(STRIPE_API_URL)
    .post('/v1/payment_intents')
    .reply(200, {
      id,
      object: 'payment_intent',
      amount,
      currency,
      status,
      client_secret: clientSecret
    });
}

/**
 * Mock Stripe confirm payment intent.
 * @param {string} paymentIntentId - The payment intent ID
 */
export function mockStripeConfirmPayment(paymentIntentId = 'pi_test_123') {
  return nock(STRIPE_API_URL)
    .post(`/v1/payment_intents/${paymentIntentId}/confirm`)
    .reply(200, {
      id: paymentIntentId,
      object: 'payment_intent',
      status: 'succeeded'
    });
}

/**
 * Mock Stripe retrieve payment intent.
 * @param {string} paymentIntentId - The payment intent ID
 * @param {string} status - Payment status
 */
export function mockStripeRetrievePayment(paymentIntentId = 'pi_test_123', status = 'succeeded') {
  return nock(STRIPE_API_URL)
    .get(`/v1/payment_intents/${paymentIntentId}`)
    .reply(200, {
      id: paymentIntentId,
      object: 'payment_intent',
      status
    });
}

/**
 * Mock Stripe error response.
 * @param {string} errorType - Stripe error type
 * @param {string} errorCode - Stripe error code
 */
export function mockStripeError(errorType = 'card_error', errorCode = 'card_declined') {
  return nock(STRIPE_API_URL)
    .post('/v1/payment_intents')
    .reply(400, {
      error: {
        type: errorType,
        code: errorCode,
        message: 'Your card was declined.'
      }
    });
}

/**
 * Create a mock Stripe webhook event payload.
 * Note: This doesn't mock HTTP - it returns event data for testing webhook handlers.
 * @param {string} type - Event type (e.g., 'payment_intent.succeeded')
 * @param {Object} data - Event data object
 */
export function createStripeWebhookEvent(type, data) {
  return {
    id: 'evt_test_123',
    object: 'event',
    type,
    data: { object: data },
    created: Math.floor(Date.now() / 1000)
  };
}
```
  </action>
  <verify>
Files exist at:
- backend/tests/helpers/mocks/paypal.js
- backend/tests/helpers/mocks/stripe.js

Quick syntax check:
```bash
cd backend
node -e "require('./tests/helpers/mocks/paypal.js')"
node -e "require('./tests/helpers/mocks/stripe.js')"
```
Should complete without errors.
  </verify>
  <done>
PayPal mock patterns created:
- OAuth token, create order, capture order, error responses

Stripe mock patterns created:
- Payment intent creation, confirmation, retrieval, error responses
- Webhook event payload builder
  </done>
</task>

<task type="auto">
  <name>Task 3: Create exchange rate and S3 mock patterns</name>
  <files>
    backend/tests/helpers/mocks/exchangeRate.js
    backend/tests/helpers/mocks/s3.js
  </files>
  <action>
Create backend/tests/helpers/mocks/exchangeRate.js:

```javascript
/**
 * Exchange rate API mock patterns.
 * Mocks both primary (exchangerate-api.com) and fallback (exchangerate.host) APIs.
 */
import nock from 'nock';

const PRIMARY_API = 'https://api.exchangerate-api.com';
const FALLBACK_API = 'https://api.exchangerate.host';

/**
 * Mock primary exchange rate API with configurable rate.
 * @param {number} ilsRate - USD to ILS exchange rate
 */
export function mockExchangeRateAPI(ilsRate = 3.70) {
  return nock(PRIMARY_API)
    .get('/v4/latest/USD')
    .reply(200, {
      base: 'USD',
      date: new Date().toISOString().split('T')[0],
      rates: {
        ILS: ilsRate,
        EUR: 0.92,
        GBP: 0.79
      }
    });
}

/**
 * Mock fallback exchange rate API.
 * @param {number} ilsRate - USD to ILS exchange rate
 */
export function mockExchangeRateFallback(ilsRate = 3.70) {
  return nock(FALLBACK_API)
    .get('/latest')
    .query({ base: 'USD', symbols: 'ILS' })
    .reply(200, {
      base: 'USD',
      date: new Date().toISOString().split('T')[0],
      rates: {
        ILS: ilsRate
      }
    });
}

/**
 * Mock exchange rate API error (both APIs fail).
 */
export function mockExchangeRateError() {
  nock(PRIMARY_API)
    .get('/v4/latest/USD')
    .reply(500, { error: 'Service unavailable' });

  return nock(FALLBACK_API)
    .get('/latest')
    .query({ base: 'USD', symbols: 'ILS' })
    .reply(500, { error: 'Service unavailable' });
}

/**
 * Mock exchange rate API with network timeout.
 */
export function mockExchangeRateTimeout() {
  return nock(PRIMARY_API)
    .get('/v4/latest/USD')
    .delay(30000) // 30 second delay (longer than typical timeout)
    .reply(200, {});
}
```

Create backend/tests/helpers/mocks/s3.js:

```javascript
/**
 * S3/DigitalOcean Spaces mock patterns.
 * Mocks AWS SDK S3 operations for file upload/delete without real storage.
 */
import nock from 'nock';

// Default Spaces endpoint format
const DEFAULT_SPACES_ENDPOINT = 'https://nyc3.digitaloceanspaces.com';

/**
 * Mock S3 putObject (upload) operation.
 * @param {Object} options - Mock options
 */
export function mockS3Upload({
  bucket = 'test-bucket',
  endpoint = DEFAULT_SPACES_ENDPOINT,
  key = null
} = {}) {
  const scope = nock(endpoint);

  if (key) {
    // Mock specific key
    scope.put(`/${bucket}/${key}`).reply(200, '', {
      'x-amz-request-id': 'test-request-id',
      'ETag': '"test-etag-123"'
    });
  } else {
    // Mock any key in bucket
    scope.put(new RegExp(`/${bucket}/.*`)).reply(200, '', {
      'x-amz-request-id': 'test-request-id',
      'ETag': '"test-etag-123"'
    });
  }

  return scope;
}

/**
 * Mock S3 deleteObject operation.
 * @param {Object} options - Mock options
 */
export function mockS3Delete({
  bucket = 'test-bucket',
  endpoint = DEFAULT_SPACES_ENDPOINT,
  key = null
} = {}) {
  const scope = nock(endpoint);

  if (key) {
    scope.delete(`/${bucket}/${key}`).reply(204);
  } else {
    scope.delete(new RegExp(`/${bucket}/.*`)).reply(204);
  }

  return scope;
}

/**
 * Mock S3 upload error.
 * @param {number} statusCode - HTTP status code
 * @param {string} errorCode - S3 error code
 */
export function mockS3Error({
  bucket = 'test-bucket',
  endpoint = DEFAULT_SPACES_ENDPOINT,
  statusCode = 403,
  errorCode = 'AccessDenied'
} = {}) {
  return nock(endpoint)
    .put(new RegExp(`/${bucket}/.*`))
    .reply(statusCode, `<?xml version="1.0" encoding="UTF-8"?>
      <Error>
        <Code>${errorCode}</Code>
        <Message>Access Denied</Message>
        <RequestId>test-request-id</RequestId>
      </Error>
    `, {
      'Content-Type': 'application/xml'
    });
}

/**
 * Mock S3 getObject operation (for downloads/reads).
 * @param {Object} options - Mock options
 */
export function mockS3GetObject({
  bucket = 'test-bucket',
  endpoint = DEFAULT_SPACES_ENDPOINT,
  key,
  body = Buffer.from('test-file-content')
} = {}) {
  return nock(endpoint)
    .get(`/${bucket}/${key}`)
    .reply(200, body, {
      'Content-Type': 'application/octet-stream',
      'Content-Length': body.length
    });
}
```
  </action>
  <verify>
Files exist at:
- backend/tests/helpers/mocks/exchangeRate.js
- backend/tests/helpers/mocks/s3.js

Quick syntax check:
```bash
cd backend
node -e "require('./tests/helpers/mocks/exchangeRate.js')"
node -e "require('./tests/helpers/mocks/s3.js')"
```
Should complete without errors.
  </verify>
  <done>
Exchange rate mock patterns created:
- Primary and fallback API mocks
- Error and timeout scenarios

S3/Spaces mock patterns created:
- Upload, delete, get operations
- Error scenarios with proper XML response format
  </done>
</task>

</tasks>

<verification>
1. `npm ls nock` shows nock installed in backend
2. All mock files exist in backend/tests/helpers/mocks/
3. Files can be imported without syntax errors
4. `cd backend && npm test` still passes (mocks don't interfere with existing tests)
</verification>

<success_criteria>
- nock HTTP mocking library installed
- PayPal mock patterns cover auth, create order, capture, errors
- Stripe mock patterns cover payment intents, webhooks, errors
- Exchange rate mock patterns cover both APIs and fallback scenarios
- S3 mock patterns cover upload, delete, get, errors
- All mocks exported from central index.js
- disableNetConnect() prevents any real HTTP requests in tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-test-infrastructure-foundation/10-04-SUMMARY.md`
</output>
