---
phase: 10-test-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/vitest.config.js
  - backend/tests/setup.js
  - backend/tests/helpers/db.js
  - backend/package.json
autonomous: true

must_haves:
  truths:
    - "npm test runs in backend directory without errors"
    - "Tests connect to in-memory MongoDB, not real database"
    - "mongodb-memory-server starts automatically before tests"
    - "Test database is isolated per test run"
  artifacts:
    - path: "backend/vitest.config.js"
      provides: "Vitest configuration for backend"
      contains: "defineConfig"
    - path: "backend/tests/setup.js"
      provides: "Global test setup with mongodb-memory-server"
      contains: "MongoMemoryServer"
    - path: "backend/tests/helpers/db.js"
      provides: "Database connection helpers for tests"
      exports: ["connect", "disconnect", "clearDatabase"]
  key_links:
    - from: "backend/vitest.config.js"
      to: "backend/tests/setup.js"
      via: "setupFiles config"
      pattern: "setupFiles.*setup"
    - from: "backend/tests/setup.js"
      to: "mongodb-memory-server"
      via: "MongoMemoryServer import"
      pattern: "MongoMemoryServer"
---

<objective>
Install and configure Vitest testing framework with mongodb-memory-server for isolated backend testing.

Purpose: Establish the foundation for all backend tests with in-memory database isolation, ensuring tests never touch production MongoDB.
Output: Working test runner configuration with automatic database setup/teardown.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-test-infrastructure-foundation/10-CONTEXT.md

# Current backend package.json
@backend/package.json

# Current backend entry point (for understanding mongoose setup)
@backend/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vitest and mongodb-memory-server</name>
  <files>backend/package.json</files>
  <action>
Install Vitest and mongodb-memory-server as dev dependencies in backend:

```bash
cd backend
npm install --save-dev vitest mongodb-memory-server @vitest/coverage-v8
```

Add test scripts to package.json:
- "test": "vitest run"
- "test:watch": "vitest"
- "test:coverage": "vitest run --coverage"

Do NOT modify existing scripts (start, devStart, lint, migrate:*).
  </action>
  <verify>
Run `npm ls vitest mongodb-memory-server` in backend directory - both packages listed.
Check backend/package.json has test scripts.
  </verify>
  <done>
Vitest and mongodb-memory-server are installed as devDependencies.
Test scripts added to package.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Vitest configuration and test setup</name>
  <files>
    backend/vitest.config.js
    backend/tests/setup.js
    backend/tests/helpers/db.js
  </files>
  <action>
Create backend/vitest.config.js:
- Use defineConfig from vitest/config
- Set test environment to 'node'
- Set testMatch to include files in tests/**/*.test.js
- Set setupFiles to ['./tests/setup.js']
- Enable globals (describe, it, expect available without import)
- Set timeout to 30000ms (mongodb-memory-server needs time to start)
- Exclude node_modules and coverage from watch

Create backend/tests/setup.js:
- Import MongoMemoryServer from mongodb-memory-server
- Import mongoose
- Create global mongoServer variable
- beforeAll: Start MongoMemoryServer, get URI, connect mongoose to that URI
- afterAll: Disconnect mongoose, stop MongoMemoryServer
- Set mongoose.set('strictQuery', true) to suppress deprecation warnings

Create backend/tests/helpers/db.js with exports:
- connect(): Start memory server and connect mongoose (for manual control)
- disconnect(): Close mongoose connection and stop memory server
- clearDatabase(): Drop all collections (for cleanup between tests)
- getUri(): Return current memory server URI (for debugging)

Include JSDoc comments explaining each function's purpose.
  </action>
  <verify>
Files exist at:
- backend/vitest.config.js
- backend/tests/setup.js
- backend/tests/helpers/db.js

Run from backend directory:
```bash
npx vitest run --passWithNoTests
```
Should complete without errors (no tests yet, but setup runs).
  </verify>
  <done>
Vitest configuration created with proper test matching.
Setup file connects to mongodb-memory-server automatically.
Database helper functions exported for test use.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create smoke test to verify infrastructure</name>
  <files>backend/tests/infrastructure.test.js</files>
  <action>
Create backend/tests/infrastructure.test.js as a minimal smoke test:

```javascript
import { describe, it, expect } from 'vitest';
import mongoose from 'mongoose';

describe('Test Infrastructure', () => {
  it('should connect to in-memory MongoDB', () => {
    expect(mongoose.connection.readyState).toBe(1); // 1 = connected
  });

  it('should use mongodb-memory-server (not production)', () => {
    const uri = mongoose.connection.host;
    // Memory server uses 127.0.0.1, not production hostnames
    expect(uri).toBe('127.0.0.1');
  });

  it('should be able to create and query a test collection', async () => {
    const TestModel = mongoose.model('Test', new mongoose.Schema({ name: String }));
    await TestModel.create({ name: 'test-item' });
    const found = await TestModel.findOne({ name: 'test-item' });
    expect(found).toBeDefined();
    expect(found.name).toBe('test-item');
  });
});
```

This verifies:
1. Database connection is established
2. Using in-memory server (not production)
3. CRUD operations work
  </action>
  <verify>
Run from backend directory:
```bash
npm test
```
All 3 tests should pass.
Output should NOT contain any production database URLs.
  </verify>
  <done>
Smoke test passes confirming:
- Vitest runs correctly
- mongodb-memory-server connects successfully
- Tests are isolated from production database
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npm test` - All tests pass
2. `cd backend && npm test -- --reporter=verbose` - Shows test names
3. No production MongoDB connection string appears in test output
4. Tests complete in under 30 seconds
</verification>

<success_criteria>
- Vitest installed and configured in backend
- mongodb-memory-server provides isolated test database
- `npm test` runs and passes in backend directory
- Smoke test verifies infrastructure works correctly
- Tests do NOT connect to production database
</success_criteria>

<output>
After completion, create `.planning/phases/10-test-infrastructure-foundation/10-01-SUMMARY.md`
</output>
