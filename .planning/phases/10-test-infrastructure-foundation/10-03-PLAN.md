---
phase: 10-test-infrastructure-foundation
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - backend/tests/helpers/envGuard.js
  - backend/tests/setup.js
autonomous: true

must_haves:
  truths:
    - "Tests fail immediately if production MongoDB URL detected"
    - "Tests fail immediately if live PayPal credentials detected"
    - "Tests fail immediately if live Stripe credentials detected"
    - "Environment validation runs before any test executes"
  artifacts:
    - path: "backend/tests/helpers/envGuard.js"
      provides: "Environment validation to prevent production contamination"
      exports: ["validateTestEnvironment", "isProductionCredential"]
  key_links:
    - from: "backend/tests/setup.js"
      to: "backend/tests/helpers/envGuard.js"
      via: "import and call in beforeAll"
      pattern: "validateTestEnvironment"
---

<objective>
Create environment validation guards that prevent tests from running with production credentials.

Purpose: Ensure tests NEVER accidentally connect to production MongoDB, PayPal, or Stripe by detecting and rejecting production-like credentials before any test executes.
Output: Environment guard module that throws hard errors if production credentials detected.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-test-infrastructure-foundation/10-CONTEXT.md

# Environment variables reference
@backend/env.example

# Existing test setup (from Plan 01)
@backend/tests/setup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment guard module</name>
  <files>backend/tests/helpers/envGuard.js</files>
  <action>
Create backend/tests/helpers/envGuard.js with these functions:

**isProductionMongoUrl(url):**
- Return true if URL contains: mongodb.net, mongodb+srv://, cloud.mongodb.com
- Return true if URL contains production hostnames (not localhost, 127.0.0.1, memory-server)
- Return false for mongodb-memory-server URLs (127.0.0.1:random-port)

**isProductionPayPal(clientId, baseUrl):**
- Return true if baseUrl contains 'api-m.paypal.com' (live, not sandbox)
- Return true if clientId is non-empty and baseUrl is NOT 'api-m.sandbox.paypal.com'
- Return false if clientId is empty/undefined (mocking)

**isProductionStripe(secretKey):**
- Return true if secretKey starts with 'sk_live_'
- Return false if secretKey starts with 'sk_test_' or is empty/undefined

**validateTestEnvironment():**
- Check process.env.MONGO_URL with isProductionMongoUrl
- Check process.env.PAYPAL_CLIENT_ID and PAYPAL_BASE_URL with isProductionPayPal
- Check process.env.STRIPE_SECRET_KEY with isProductionStripe
- For each production credential found, collect error message
- If ANY production credentials found, throw Error with all messages combined
- Include suggestion: "Use TEST_ prefixed env vars or ensure mongodb-memory-server is used"

**Export all four functions for direct testing and reuse.**

Add JSDoc comments explaining:
- Why each check exists
- What patterns indicate production vs test credentials
- How to fix if error thrown
  </action>
  <verify>
File exists at backend/tests/helpers/envGuard.js.
Run in Node REPL or quick test:
```bash
cd backend
node -e "const { isProductionStripe } = require('./tests/helpers/envGuard'); console.log(isProductionStripe('sk_live_abc123') === true ? 'PASS' : 'FAIL')"
```
  </verify>
  <done>
Environment guard module created with detection for:
- Production MongoDB URLs (Atlas, cloud hosts)
- Live PayPal credentials (non-sandbox)
- Live Stripe credentials (sk_live_*)
All functions exported with JSDoc documentation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate environment guard into test setup</name>
  <files>backend/tests/setup.js</files>
  <action>
Update backend/tests/setup.js to:

1. Import validateTestEnvironment from './helpers/envGuard.js'

2. At the TOP of the file (before MongoMemoryServer import), add:
```javascript
// SAFETY FIRST: Validate environment before anything else
import { validateTestEnvironment } from './helpers/envGuard.js';

// This runs at module load time, before any tests
try {
  validateTestEnvironment();
} catch (error) {
  console.error('\n========================================');
  console.error('ENVIRONMENT SAFETY CHECK FAILED');
  console.error('========================================');
  console.error(error.message);
  console.error('\nTests aborted to prevent production contamination.');
  console.error('========================================\n');
  process.exit(1);
}
```

3. In beforeAll, add a second-level check:
```javascript
// Double-check: Ensure we're using memory server, not real MongoDB
const uri = mongoServer.getUri();
if (!uri.includes('127.0.0.1')) {
  throw new Error(`SAFETY: Expected in-memory MongoDB (127.0.0.1), got: ${uri}`);
}
```

4. Clear any payment-related env vars in beforeAll to prevent accidental API calls:
```javascript
// Clear payment credentials to ensure mocking is used
delete process.env.PAYPAL_CLIENT_ID;
delete process.env.PAYPAL_CLIENT_SECRET;
delete process.env.STRIPE_SECRET_KEY;
delete process.env.STRIPE_WEBHOOK_SECRET;
```

Keep all existing MongoMemoryServer setup unchanged.
  </action>
  <verify>
Run tests to confirm setup still works:
```bash
cd backend && npm test
```
All existing tests should still pass.

To verify guard works, temporarily set env var and confirm failure:
```bash
cd backend
MONGO_URL="mongodb+srv://prod.cluster.mongodb.net" npm test 2>&1 | grep -i "SAFETY"
```
Should see safety check failure message.
  </verify>
  <done>
Environment guard integrated into test setup:
- Validates at module load time (before tests start)
- Validates again at mongodb connection time
- Clears payment credentials to force mocking
- Aborts test run with clear error if production credentials detected
  </done>
</task>

<task type="auto">
  <name>Task 3: Create environment guard unit tests</name>
  <files>backend/tests/helpers/envGuard.test.js</files>
  <action>
Create backend/tests/helpers/envGuard.test.js to test the guard functions directly:

```javascript
import { describe, it, expect } from 'vitest';
import {
  isProductionMongoUrl,
  isProductionPayPal,
  isProductionStripe,
  validateTestEnvironment
} from './envGuard.js';

describe('Environment Guard', () => {
  describe('isProductionMongoUrl', () => {
    it('should detect MongoDB Atlas URLs', () => {
      expect(isProductionMongoUrl('mongodb+srv://user:pass@cluster.mongodb.net/db')).toBe(true);
    });

    it('should detect cloud.mongodb.com URLs', () => {
      expect(isProductionMongoUrl('mongodb://cloud.mongodb.com/db')).toBe(true);
    });

    it('should allow localhost URLs', () => {
      expect(isProductionMongoUrl('mongodb://localhost:27017/test')).toBe(false);
    });

    it('should allow 127.0.0.1 URLs (memory server)', () => {
      expect(isProductionMongoUrl('mongodb://127.0.0.1:52345/test')).toBe(false);
    });

    it('should allow undefined/empty URLs', () => {
      expect(isProductionMongoUrl(undefined)).toBe(false);
      expect(isProductionMongoUrl('')).toBe(false);
    });
  });

  describe('isProductionPayPal', () => {
    it('should detect live PayPal API URL', () => {
      expect(isProductionPayPal('ABC123', 'https://api-m.paypal.com')).toBe(true);
    });

    it('should allow sandbox PayPal URL', () => {
      expect(isProductionPayPal('ABC123', 'https://api-m.sandbox.paypal.com')).toBe(false);
    });

    it('should allow empty credentials (mocking)', () => {
      expect(isProductionPayPal(undefined, 'https://api-m.paypal.com')).toBe(false);
      expect(isProductionPayPal('', 'https://api-m.paypal.com')).toBe(false);
    });
  });

  describe('isProductionStripe', () => {
    it('should detect live Stripe key', () => {
      expect(isProductionStripe('sk_live_abc123xyz')).toBe(true);
    });

    it('should allow test Stripe key', () => {
      expect(isProductionStripe('sk_test_abc123xyz')).toBe(false);
    });

    it('should allow empty/undefined key (mocking)', () => {
      expect(isProductionStripe(undefined)).toBe(false);
      expect(isProductionStripe('')).toBe(false);
    });
  });

  describe('validateTestEnvironment', () => {
    it('should not throw when no production credentials present', () => {
      // In test environment with memory server, should pass
      expect(() => validateTestEnvironment()).not.toThrow();
    });
  });
});
```
  </action>
  <verify>
Run tests:
```bash
cd backend && npm test
```
All environment guard tests should pass along with existing infrastructure tests.
  </verify>
  <done>
Environment guard module fully tested:
- MongoDB URL detection works for Atlas, cloud, localhost, memory server
- PayPal detection distinguishes live vs sandbox
- Stripe detection distinguishes sk_live_ vs sk_test_
- validateTestEnvironment passes in test environment
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npm test` - All tests pass including new envGuard tests
2. Tests abort immediately if production MONGO_URL set
3. Tests abort immediately if live STRIPE_SECRET_KEY set
4. Tests abort immediately if live PAYPAL_BASE_URL set
5. Error messages clearly explain which credential is problematic
</verification>

<success_criteria>
- Environment guard module detects production MongoDB, PayPal, Stripe credentials
- Test setup validates environment before any test runs
- Tests abort with clear error message if production credentials detected
- Payment credentials cleared in test setup to force mocking
- All guard functions have unit tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-test-infrastructure-foundation/10-03-SUMMARY.md`
</output>
