---
phase: 25-dynamic-ssr-structured-data-sitemap
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - backend/routes/ssrDynamic.js
  - backend/views/pages/product.ejs
  - backend/config/meta.js
  - backend/index.js
autonomous: true

must_haves:
  truths:
    - "Visiting /en/product/:slug returns a dedicated product detail page with full product information"
    - "Page source includes Product JSON-LD with name, image, description, SKU, price/currency/availability"
    - "Page source includes BreadcrumbList JSON-LD showing Home > Category > Product"
    - "Page source includes product:price:amount and product:price:currency OG meta tags"
    - "Invalid slug returns 404"
    - "Hebrew product page shows ILS prices and Hebrew UI chrome"
  artifacts:
    - path: "backend/views/pages/product.ejs"
      provides: "Product detail page EJS template"
      contains: "data-ssr"
    - path: "backend/routes/ssrDynamic.js"
      provides: "Product page SSR handler added to existing file"
      exports: ["renderCategoryPage", "renderProductPage"]
  key_links:
    - from: "backend/routes/ssrDynamic.js"
      to: "backend/models/Product.js"
      via: "Product.findOne({ slug, available: true })"
      pattern: "Product\\.findOne"
    - from: "backend/views/pages/product.ejs"
      to: "backend/views/partials/product-schema.ejs"
      via: "EJS include"
      pattern: "include.*product-schema"
    - from: "backend/views/pages/product.ejs"
      to: "backend/views/partials/breadcrumb-schema.ejs"
      via: "EJS include"
      pattern: "include.*breadcrumb-schema"
    - from: "backend/index.js"
      to: "backend/routes/ssrDynamic.js"
      via: "require and app.get route registration"
      pattern: "renderProductPage"
---

<objective>
Create individual product detail pages as a new SSR feature with dedicated URLs, full product information, and Product + BreadcrumbList structured data.

Purpose: Product detail pages are a new feature that gives each product a unique, shareable URL with rich structured data for search engine product listings and social sharing. This is the primary conversion page.
Output: Working product pages at /:lang/product/:slug with complete product info, JSON-LD structured data, and OG price meta tags.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-RESEARCH.md
@.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-01-SUMMARY.md
@backend/routes/ssr.js
@backend/routes/ssrDynamic.js
@backend/helpers/schemaHelpers.js
@backend/config/meta.js
@backend/views/partials/meta-tags.ejs
@backend/views/pages/category.ejs
@backend/models/Product.js
@backend/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add product detail handler to ssrDynamic.js and create product.ejs template</name>
  <files>
    backend/routes/ssrDynamic.js
    backend/views/pages/product.ejs
    backend/config/meta.js
  </files>
  <action>
    1. Add `renderProductPage(req, res)` async handler to `backend/routes/ssrDynamic.js`:
       a. Extract lang and slug from req.params
       b. Query Product.findOne({ slug, available: true }).lean() -- no need to limit fields since this is the detail page
       c. If product not found, render 404 page using buildPageData(req, '404', [])
       d. Determine langKey (he->heb, en->eng), currency (eng->USD, heb->ILS), price
       e. Build pageData: DO NOT use buildPageData for the base since product pages need dynamic title/description from the product itself, not from meta config. Instead, manually construct pageData:
          - lang, urlLang, dir (same logic as buildPageData)
          - title: product.name (will get " | Tamar Kfir Jewelry" suffix from meta-tags.ejs)
          - description: product.description truncated to 158 chars, or fallback to generic description
          - canonical: baseUrl/lang/product/slug
          - alternateUrl: { en: baseUrl/en/product/slug, he: baseUrl/he/product/slug }
          - ogImage: product.images[0]?.publicDesktop || product.mainImage?.publicDesktop || null
          - productPrice: the price value (toFixed(2))
          - productCurrency: 'USD' or 'ILS'
          - baseUrl
          - pageStyles: standard reset, desktop-menu, footer, mobile-menu CSS. For product page CSS, check if there are product-specific CSS files in frontend/css/ -- if not, use categories CSS as closest match or create minimal styling inline
          - product: the full product object
          - categoryDisplayName: from categoryDisplayNames mapping using product.category
          - categorySlug: reverse-map product.category to URL slug (e.g., crochetNecklaces -> crochet-necklaces)
          - ssrFlag: true
       f. Generate single product schema using generateProductSchema
       g. Generate breadcrumb: [{ name: Home/בית, url: /urlLang }, { name: categoryDisplayName, url: /urlLang/categorySlug }, { name: product.name }] (3-level hierarchy)
       h. Pass schemaItems (single-element array) and breadcrumbSchema to pageData
       i. res.render('pages/product', pageData)
       j. Wrap in try/catch with error page fallback

    2. Export renderProductPage alongside existing renderCategoryPage.

    3. Create `backend/views/pages/product.ejs`:
       - Same HTML structure pattern as category.ejs: doctype, html with lang/dir, head with meta-tags include, structured data, controller.js, Clarity
       - Body id: "product-detail" (or similar unique identifier)
       - Include header partial
       - Main content with data-ssr="true" on the product detail container
       - Product image gallery: Show main image large, with thumbnail strip for additional images (product.images array). Use picture elements for responsive images.
       - Product info section:
         - Product name as h1
         - Price display with currency symbol
         - Original price with strikethrough if discount_percentage > 0
         - Description
         - SKU display if present
         - Availability indicator (In Stock / Out of Stock based on quantity)
         - Add to Cart button (non-functional for SSR, client-side JS will handle)
       - Include product-schema partial (pass as single-item array)
       - Include breadcrumb-schema partial
       - Include footer partial
       - The HTML should be structured so categoriesView.js or a future productView.js can attach event listeners to existing DOM elements

    4. If `backend/config/meta.js` needs a 'product' key as fallback (for buildPageData pattern), add one with generic title/description. However, since product pages use dynamic title from the product name, this is only needed if buildPageData is used as base.

    NOTE: Create a reverse category slug mapping in ssrDynamic.js (or schemaHelpers.js): { necklaces: 'necklaces', crochetNecklaces: 'crochet-necklaces', hoops: 'hoops', dangle: 'dangle', bracelets: 'bracelets', unisex: 'unisex' } to go from DB category to URL slug.
  </action>
  <verify>
    - Start dev server and verify with a real product slug from the database
    - `curl -s http://localhost:4000/en/product/SOME_REAL_SLUG | grep "application/ld+json"` shows Product and BreadcrumbList
    - `curl -s http://localhost:4000/en/product/SOME_REAL_SLUG | grep "product:price:amount"` shows OG price tag
    - `curl -s http://localhost:4000/en/product/nonexistent-slug` returns 404
    - View page source shows product name, description, image, price in HTML
    - BreadcrumbList shows 3 levels: Home > Category > Product Name
  </verify>
  <done>
    Product detail pages render at /:lang/product/:slug with product name, images, price, description, and SKU visible in HTML source. Product JSON-LD and BreadcrumbList JSON-LD are in the head. OG price meta tags are present. Invalid slugs return 404.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register product route in index.js</name>
  <files>backend/index.js</files>
  <action>
    1. In backend/index.js, update the require statement for ssrDynamic to also import renderProductPage.
    2. Add route after the category routes (registered in Plan 01):
       `app.get('/:lang(en|he)/product/:slug', languageMiddleware, renderProductPage);`
    3. Ensure route order: static pages -> categories -> product detail -> other routes. The product route must come after categories to avoid /:category matching "product" as a category (though the regex constraint should prevent this).
  </action>
  <verify>
    - `curl -s -o /dev/null -w "%{http_code}" http://localhost:4000/en/product/SOME_REAL_SLUG` returns 200
    - `curl -s -o /dev/null -w "%{http_code}" http://localhost:4000/he/product/SOME_REAL_SLUG` returns 200
    - `curl -s -o /dev/null -w "%{http_code}" http://localhost:4000/en/product/nonexistent` returns 404
  </verify>
  <done>
    Product detail route is registered and accessible in both languages. Route order is correct with no conflicts.
  </done>
</task>

</tasks>

<verification>
1. Visit /en/product/:slug for a real product -- page source shows full product detail
2. Product JSON-LD contains name, image, description, sku, offers with price/currency/availability
3. BreadcrumbList JSON-LD shows Home > Category Name > Product Name with correct URLs
4. OG meta tags include product:price:amount and product:price:currency
5. Canonical URL is product-specific, hreflang alternates link en/he versions
6. Hebrew version shows ILS price and Hebrew UI
7. Invalid slug returns 404
</verification>

<success_criteria>
- Product pages work for all products with slugs in both languages
- Product JSON-LD passes schema validation
- BreadcrumbList shows 3-level hierarchy with correct category
- OG price tags present for social sharing
- Page title uses product name with site suffix
- Product image, name, price, description visible in page source (not JS-injected)
</success_criteria>

<output>
After completion, create `.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-02-SUMMARY.md`
</output>
