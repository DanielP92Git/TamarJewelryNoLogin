---
phase: 25-dynamic-ssr-structured-data-sitemap
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/routes/sitemap.js
  - backend/index.js
  - backend/package.json
autonomous: true

must_haves:
  truths:
    - "/sitemap.xml returns valid XML with application/xml content type"
    - "Sitemap lists all public pages (home, about, contact, workshop, policies) in both languages"
    - "Sitemap lists all category pages in both languages"
    - "Sitemap lists all available products with /en/product/:slug and /he/product/:slug URLs"
    - "Each URL has hreflang alternates (en, he, x-default)"
    - "Product URLs include image entries with product image URLs"
    - "Product URLs include lastmod dates from actual product.date field"
  artifacts:
    - path: "backend/routes/sitemap.js"
      provides: "Dynamic XML sitemap generator"
      exports: ["serveSitemap"]
    - path: "backend/package.json"
      provides: "sitemap npm package dependency"
      contains: "sitemap"
  key_links:
    - from: "backend/routes/sitemap.js"
      to: "backend/models/Product.js"
      via: "Product.find for sitemap URLs"
      pattern: "Product\\.find"
    - from: "backend/index.js"
      to: "backend/routes/sitemap.js"
      via: "require and app.get /sitemap.xml"
      pattern: "serveSitemap"
---

<objective>
Create a dynamic XML sitemap generated from MongoDB product data, covering all public pages with hreflang alternates, image extensions, and content-based lastmod dates.

Purpose: The sitemap tells search engines about every page on the site, ensuring complete crawl coverage for both languages. Image extensions help product images appear in Google Image Search.
Output: /sitemap.xml endpoint returning valid XML with all public URLs, hreflang, images, and lastmod.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-RESEARCH.md
@backend/routes/ssr.js
@backend/models/Product.js
@backend/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sitemap package and create sitemap route</name>
  <files>
    backend/package.json
    backend/routes/sitemap.js
  </files>
  <action>
    1. Install sitemap package: `cd backend && npm install sitemap`

    2. Create `backend/routes/sitemap.js`:
       - Import { SitemapStream, streamToPromise } from 'sitemap', { Readable } from 'stream', and Product model
       - Export async function `serveSitemap(req, res)`:

       a. Set baseUrl from process.env.BASE_URL || 'https://tamarkfir.online'

       b. Create SitemapStream with hostname: baseUrl, xmlns: { news: false, xhtml: true, image: true, video: false }

       c. Build links array:

       **Static pages** (priority decreasing):
       - Home ('') - priority 1.0, changefreq monthly
       - About ('/about') - priority 0.8, changefreq monthly
       - Contact ('/contact') - priority 0.8, changefreq monthly
       - Workshop ('/workshop') - priority 0.8, changefreq monthly
       - Policies ('/policies') - priority 0.7, changefreq yearly

       For each static page, add TWO entries (one per language), each with `links` array containing all 3 hreflang alternates:
       ```
       { lang: 'en', url: `/en${path}` }
       { lang: 'he', url: `/he${path}` }
       { lang: 'x-default', url: `/en${path}` }
       ```

       **Category pages** (necklaces, crochet-necklaces, hoops, dangle, bracelets, unisex):
       - Priority 0.9, changefreq weekly
       - Same hreflang pattern as static pages

       **Product pages**:
       - Query Product.find({ available: true }).select('slug name images mainImage date').lean()
       - For each product, add TWO entries (en/he), each with:
         - url: `/${lang}/product/${product.slug}`
         - changefreq: 'weekly'
         - priority: 0.7
         - lastmod: product.date ? new Date(product.date).toISOString() : undefined (CRAWL-06: actual content update time)
         - img: Array with product image if available: [{ url: imageUrl, caption: product.name }] where imageUrl = product.images[0]?.publicDesktop || product.mainImage?.publicDesktop (CRAWL-05: image sitemap extension)
         - links: hreflang alternates (en, he, x-default pointing to en)

       d. Pipe links through SitemapStream:
       ```javascript
       const data = await streamToPromise(Readable.from(links).pipe(stream));
       ```

       e. Set response headers:
       - Content-Type: application/xml
       - Cache-Control: public, max-age=3600 (1 hour cache for CDN)

       f. Send data.toString()

       g. Wrap everything in try/catch. On error, return 500 with plain text error.

    NOTE: Do NOT deduplicate entries. Each URL appears once per language (en and he). The sitemap package handles xmlns:xhtml namespace for hreflang via the `links` property.
  </action>
  <verify>
    - `cd backend && node -e "require('./routes/sitemap')"` loads without error
    - `npm ls sitemap` shows sitemap package installed
  </verify>
  <done>
    Sitemap route module created with dynamic generation from MongoDB. Sitemap package installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register sitemap route in index.js</name>
  <files>backend/index.js</files>
  <action>
    1. Import serveSitemap from './routes/sitemap' in backend/index.js
    2. Register route BEFORE the SSR routes (near the static file serving / robots.txt area, since sitemap is a crawl directive like robots.txt):
       `app.get('/sitemap.xml', serveSitemap);`
    3. No languageMiddleware needed since sitemap.xml is language-agnostic (contains all languages)
    4. Place after trailing slash redirect middleware but before SSR page routes
  </action>
  <verify>
    - Start dev server
    - `curl -s http://localhost:4000/sitemap.xml | head -5` shows XML declaration and urlset with xmlns
    - `curl -s http://localhost:4000/sitemap.xml | grep -c "<url>"` returns count > 0 (at least static pages + categories)
    - `curl -s http://localhost:4000/sitemap.xml | grep "xhtml:link"` shows hreflang alternates present
    - `curl -s http://localhost:4000/sitemap.xml | grep "image:image"` shows image entries for products
    - `curl -s -I http://localhost:4000/sitemap.xml | grep "Content-Type"` shows application/xml
    - Verify lastmod dates are ISO format (YYYY-MM-DDTHH:MM:SS.sssZ), not future dates
  </verify>
  <done>
    /sitemap.xml returns valid XML sitemap with all public pages (home, static, categories, products) in both languages. Each URL has hreflang alternates. Product URLs have image entries and lastmod from actual content dates.
  </done>
</task>

</tasks>

<verification>
1. `curl http://localhost:4000/sitemap.xml` returns well-formed XML
2. Count of URLs matches expected: (5 static * 2 langs) + (6 categories * 2 langs) + (N products * 2 langs)
3. Every URL has 3 xhtml:link elements (en, he, x-default)
4. Product entries have image:image elements
5. Product entries have lastmod dates in W3C datetime format
6. Content-Type header is application/xml
7. No duplicate URLs in the sitemap
</verification>

<success_criteria>
- /sitemap.xml responds with valid XML (parseable by any XML parser)
- All static pages present in both languages (CRAWL-03)
- All category pages present in both languages (CRAWL-03)
- All available products present with both language URLs (CRAWL-03)
- Hreflang alternates on every entry with x-default pointing to English (CRAWL-04)
- Product images included via image sitemap extension (CRAWL-05)
- Lastmod reflects actual product.date, not current timestamp (CRAWL-06)
</success_criteria>

<output>
After completion, create `.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-03-SUMMARY.md`
</output>
