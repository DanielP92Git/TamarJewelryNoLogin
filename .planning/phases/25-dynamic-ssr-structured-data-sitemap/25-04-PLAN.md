---
phase: 25-dynamic-ssr-structured-data-sitemap
plan: 04
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - frontend/js/Views/categoriesView.js
  - backend/views/pages/cart.ejs
  - backend/routes/ssrDynamic.js
  - backend/index.js
autonomous: true

must_haves:
  truths:
    - "Client-side JS detects data-ssr flag on category pages and does not re-fetch products"
    - "Category page works correctly with JavaScript enabled (no content flash or duplicate rendering)"
    - "Cart page at /:lang/cart renders SSR shell with header/footer but cart contents area is empty for client-side population"
  artifacts:
    - path: "frontend/js/Views/categoriesView.js"
      provides: "SSR-aware category view that skips re-fetch when data-ssr is present"
      contains: "data-ssr"
    - path: "backend/views/pages/cart.ejs"
      provides: "Cart page SSR shell template"
      contains: "cart"
  key_links:
    - from: "frontend/js/Views/categoriesView.js"
      to: "backend/views/pages/category.ejs"
      via: "data-ssr attribute detection"
      pattern: "dataset\\.ssr"
    - from: "backend/index.js"
      to: "backend/routes/ssrDynamic.js"
      via: "renderCartPage route registration"
      pattern: "renderCartPage"
---

<objective>
Add client-side SSR awareness to prevent re-fetching on category pages, and create a minimal cart page SSR shell.

Purpose: Without SSR awareness, the existing SPA JavaScript would re-fetch and re-render products that are already in the HTML, causing content flash. The cart shell provides SSR header/footer/meta for the cart URL while keeping cart logic client-side.
Output: Modified categoriesView.js that detects SSR content, cart.ejs shell page.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-RESEARCH.md
@.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-01-SUMMARY.md
@.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-02-SUMMARY.md
@frontend/js/Views/categoriesView.js
@frontend/js/controller.js
@backend/views/pages/category.ejs
@backend/views/pages/home.ejs
@backend/routes/ssrDynamic.js
@backend/config/meta.js
@backend/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSR detection to categoriesView.js</name>
  <files>frontend/js/Views/categoriesView.js</files>
  <action>
    1. Read the full categoriesView.js to understand the initialization and product fetching flow.

    2. Find the method that triggers the initial product fetch (likely in `checkAndInitialize`, `directInitialize`, or a `render`/`loadProducts` method). The goal is to detect if the product grid already has SSR content and skip the API fetch.

    3. Add SSR detection early in the initialization flow:
       - Check for the outer products container (`.outer-products-container` or whatever selector is used)
       - If the container exists AND has `dataset.ssr === 'true'`, set a flag like `this.ssrRendered = true`
       - When `this.ssrRendered` is true:
         a. Do NOT call the API to fetch products
         b. Do NOT clear/replace the existing DOM content
         c. DO attach event listeners to existing product cards (click handlers for modals, etc.)
         d. DO initialize any other non-data functionality (infinite scroll can be set up to load MORE products beyond the SSR batch)
         e. Log: `console.log('[SSR] Category products already rendered, attaching handlers')`

    4. The key places to guard:
       - The initial fetch call (skip it)
       - Any DOM clearing/innerHTML replacement (skip it)
       - Event listener attachment (keep it, apply to existing cards)
       - The currency display logic (may need to update prices if user's selected currency differs from SSR default -- check this carefully)

    5. For the currency issue: SSR renders prices based on language (eng->USD, heb->ILS). If the user has a different currency preference in localStorage, the client-side JS may need to update prices after SSR. This is acceptable as a progressive enhancement -- the SSR content is correct for the default case, and JS enhances for user preferences.

    6. Do NOT restructure the entire file. Make minimal, targeted changes to the initialization flow to check for SSR content.

    IMPORTANT: Preserve all existing SPA functionality. When the user navigates to a category page via client-side routing (hash change / pushState), there will be no SSR content, so the normal fetch flow must still work.
  </action>
  <verify>
    - `npm run build` in frontend succeeds (no syntax errors)
    - Open category page in browser with DevTools Network tab -- no API call to fetch products if SSR content present
    - Product cards are clickable (event listeners attached)
    - Navigate to a category via client-side routing (if applicable) -- normal fetch still works
  </verify>
  <done>
    categoriesView.js detects data-ssr="true" on the product grid and skips initial API fetch. Event listeners are attached to existing SSR-rendered cards. SPA navigation without SSR continues to work normally.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cart page SSR shell and register route</name>
  <files>
    backend/views/pages/cart.ejs
    backend/routes/ssrDynamic.js
    backend/index.js
  </files>
  <action>
    1. Create `backend/views/pages/cart.ejs`:
       - Standard HTML structure matching other pages: doctype, html with lang/dir, head with meta-tags include
       - Include controller.js script and Clarity script
       - Include header partial
       - Body id: "cart" (matching frontend pattern for cart page detection)
       - Main content area: Empty container where client-side JS will render cart items. Use appropriate class names that the frontend cartView.js expects (check frontend/js/Views/cartView.js for container selectors).
       - Include footer partial
       - This is a SHELL only -- no cart item rendering. Cart data comes from localStorage/API on the client side.

    2. Add `renderCartPage(req, res)` to `backend/routes/ssrDynamic.js`:
       - Simple synchronous handler (no MongoDB query needed)
       - Use buildPageData(req, 'cart', [...cartStyles])
       - Cart CSS: check frontend for cart-specific CSS files (cart-devices.css, cart-800plus.css or similar). If none exist, use minimal common styles.
       - res.render('pages/cart', pageData)

    3. Export renderCartPage from ssrDynamic.js

    4. Register route in backend/index.js:
       - Import renderCartPage (update existing require)
       - `app.get('/:lang(en|he)/cart', languageMiddleware, renderCartPage);`
       - Place after product detail route

    NOTE: The cart meta entry was already added to meta.js in Plan 01 (Task 1).
  </action>
  <verify>
    - `curl -s http://localhost:4000/en/cart | grep "<title>"` shows "Shopping Cart | Tamar Kfir Jewelry"
    - `curl -s http://localhost:4000/he/cart | grep "<title>"` shows Hebrew cart title
    - Page has header and footer but empty cart content area
    - `curl -s -o /dev/null -w "%{http_code}" http://localhost:4000/en/cart` returns 200
  </verify>
  <done>
    Cart page renders at /:lang/cart with SSR shell (header, footer, meta tags) but empty content area for client-side cart rendering. Route registered and accessible in both languages.
  </done>
</task>

</tasks>

<verification>
1. Category page with JS enabled: no duplicate product rendering, no content flash
2. Category page Network tab: no unnecessary API calls when SSR content present
3. Product card interactions work (click events attached to SSR-rendered cards)
4. Cart page loads with proper meta tags, header, and footer
5. Cart page content area is empty (ready for client-side population)
6. Frontend build succeeds with no errors
</verification>

<success_criteria>
- SSR-06: Client-side JS detects data-ssr flag and skips initial re-fetch
- SSR-07: Cart page renders as SSR shell with proper meta tags
- No content flashing on category pages
- All existing SPA functionality preserved (non-SSR navigation still works)
</success_criteria>

<output>
After completion, create `.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-04-SUMMARY.md`
</output>
