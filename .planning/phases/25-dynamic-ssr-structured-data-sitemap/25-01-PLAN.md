---
phase: 25-dynamic-ssr-structured-data-sitemap
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/helpers/schemaHelpers.js
  - backend/views/partials/product-schema.ejs
  - backend/views/partials/breadcrumb-schema.ejs
  - backend/views/partials/meta-tags.ejs
  - backend/config/meta.js
  - backend/routes/ssrDynamic.js
  - backend/views/pages/category.ejs
  - backend/index.js
autonomous: true

must_haves:
  truths:
    - "Visiting /en/necklaces returns fully-rendered HTML with product names, images, prices visible in page source"
    - "Visiting /he/necklaces returns the same products with Hebrew UI chrome and ILS prices"
    - "Category pages include Product JSON-LD for each listed product"
    - "Category pages include BreadcrumbList JSON-LD (Home > Category)"
    - "Empty categories return 404, not a blank page"
  artifacts:
    - path: "backend/helpers/schemaHelpers.js"
      provides: "JSON-LD generation for Product and BreadcrumbList"
      exports: ["generateProductSchema", "generateBreadcrumbSchema"]
    - path: "backend/views/partials/product-schema.ejs"
      provides: "Product JSON-LD partial for EJS templates"
      contains: "application/ld+json"
    - path: "backend/views/partials/breadcrumb-schema.ejs"
      provides: "BreadcrumbList JSON-LD partial for EJS templates"
      contains: "BreadcrumbList"
    - path: "backend/routes/ssrDynamic.js"
      provides: "Category page SSR handler with MongoDB query"
      exports: ["renderCategoryPage"]
    - path: "backend/views/pages/category.ejs"
      provides: "Category page EJS template with product grid"
      contains: "data-ssr"
    - path: "backend/config/meta.js"
      provides: "Meta tag config extended with category entries"
      contains: "necklaces"
  key_links:
    - from: "backend/routes/ssrDynamic.js"
      to: "backend/models/Product.js"
      via: "Product.find({ category, available: true })"
      pattern: "Product\\.find"
    - from: "backend/views/pages/category.ejs"
      to: "backend/views/partials/product-schema.ejs"
      via: "EJS include"
      pattern: "include.*product-schema"
    - from: "backend/index.js"
      to: "backend/routes/ssrDynamic.js"
      via: "require and app.get route registration"
      pattern: "renderCategoryPage"
---

<objective>
Create category page SSR with product grids, structured data helpers, and schema partials that will also serve product detail pages in Plan 02.

Purpose: Category pages are the primary product discovery path. SSR ensures search engines see product names, images, prices, and structured data in the initial HTML response.
Output: Working category pages at /:lang/:category with Product and BreadcrumbList JSON-LD, product grid with data-ssr flag, and reusable schema infrastructure.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-RESEARCH.md
@backend/routes/ssr.js
@backend/config/meta.js
@backend/views/partials/meta-tags.ejs
@backend/views/partials/header.ejs
@backend/views/partials/footer.ejs
@backend/views/pages/home.ejs
@backend/models/Product.js
@backend/index.js
@frontend/js/Views/categoriesView.js
@frontend/css/categories-800plus.css
@frontend/css/categories-devices.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema helpers, EJS partials, and extend meta config</name>
  <files>
    backend/helpers/schemaHelpers.js
    backend/views/partials/product-schema.ejs
    backend/views/partials/breadcrumb-schema.ejs
    backend/views/partials/meta-tags.ejs
    backend/config/meta.js
  </files>
  <action>
    1. Create `backend/helpers/schemaHelpers.js` with two exported functions:
       - `generateProductSchema(product, langKey, baseUrl)`: Returns a JSON-LD object with @context, @type: Product, name, image (from product.images[0]?.publicDesktop || product.mainImage?.publicDesktop), description, sku (omit if falsy), and offers object with @type: Offer, url (using English slug for both languages: baseUrl + /en/product/ or /he/product/ + product.slug), priceCurrency (eng->USD, heb->ILS), price (toFixed(2)), availability (https://schema.org/InStock if quantity > 0, else https://schema.org/OutOfStock). Use full schema.org URLs for availability values.
       - `generateBreadcrumbSchema(items, baseUrl)`: Takes array of {name, url} objects. Returns JSON-LD with @type: BreadcrumbList. Last item should NOT have "item" property (current page convention). Each ListItem has position (1-indexed), name, and item (baseUrl + url) if url is provided.

    2. Create `backend/views/partials/product-schema.ejs`: Accepts a `products` array and `schemaItems` array (pre-generated JSON-LD objects from the helper). Renders a single `<script type="application/ld+json">` tag containing an array of all Product schemas. Use `<%- JSON.stringify(schemaItems, null, 2) %>` for safe escaping (unescaped EJS output since JSON.stringify handles the content).

    3. Create `backend/views/partials/breadcrumb-schema.ejs`: Accepts a `breadcrumbSchema` object (pre-generated from the helper). Renders a `<script type="application/ld+json">` tag with `<%- JSON.stringify(breadcrumbSchema, null, 2) %>`.

    4. Extend `backend/views/partials/meta-tags.ejs`: After the Twitter Card section and before the hreflang section, add product price OG tags. Check `if (typeof productPrice !== 'undefined' && productPrice !== null)` and render `<meta property="product:price:amount" content="<%= productPrice %>">` and `<meta property="product:price:currency" content="<%= productCurrency %>">`. This will be used by product detail pages (Plan 02) but must be added now since the partial is shared.

    5. Extend `backend/config/meta.js` with entries for each category. Add category keys that match URL slugs: `necklaces`, `crochet-necklaces`, `hoops`, `dangle`, `bracelets`, `unisex`. Each has eng/heb with title and description. Titles follow pattern: "Handmade [Category] | Tamar Kfir Jewelry" (eng) / "[Hebrew Category] | תכשיטי תמר כפיר" (heb). Descriptions should be 120-158 chars describing the category. Also add a `categoryDisplayNames` export mapping slug to display names: { necklaces: { eng: 'Necklaces', heb: 'שרשראות' }, 'crochet-necklaces': { eng: 'Crochet Necklaces', heb: 'שרשראות סרוגות' }, hoops: { eng: 'Hoop Earrings', heb: 'עגילי חישוק' }, dangle: { eng: 'Dangle Earrings', heb: 'עגילים תלויים' }, bracelets: { eng: 'Bracelets', heb: 'צמידים' }, unisex: { eng: 'Unisex Jewelry', heb: 'תכשיטים יוניסקס' } }.

    Also add a `cart` meta entry for SSR-07 (cart shell page in Plan 04): cart: { eng: { title: 'Shopping Cart', description: 'View and manage your shopping cart.' }, heb: { title: 'עגלת קניות', description: 'צפייה וניהול עגלת הקניות שלך.' } }.

    NOTE: The category slugs in URLs must match the `category` field stored in MongoDB for products. Check the footer.ejs for the mapping: necklaces, crochet-necklaces, hoops, dangle, bracelets, unisex. If MongoDB stores different values (e.g., "crochetNecklaces"), create a URL-to-DB mapping in the helpers.
  </action>
  <verify>
    - `node -e "const s = require('./backend/helpers/schemaHelpers'); console.log(JSON.stringify(s.generateProductSchema({name:'Test',slug:'test',images:[{publicDesktop:'https://img.jpg'}],quantity:1,usd_price:50,ils_price:180,sku:'T01'},'eng','https://example.com'), null, 2))"` outputs valid Product JSON-LD with offers.availability = "https://schema.org/InStock"
    - `node -e "const s = require('./backend/helpers/schemaHelpers'); console.log(JSON.stringify(s.generateBreadcrumbSchema([{name:'Home',url:'/en'},{name:'Necklaces',url:'/en/necklaces'},{name:'Gold Star'}],'https://example.com'), null, 2))"` outputs valid BreadcrumbList with 3 items, last item has no "item" field
    - `node -e "const m = require('./backend/config/meta'); console.log(Object.keys(m))"` shows category keys present
  </verify>
  <done>
    Schema helper functions generate valid Product and BreadcrumbList JSON-LD. Meta config has entries for all 6 categories plus cart. Meta-tags partial conditionally renders product price OG tags. EJS partials render JSON-LD script tags.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create category SSR route handler, EJS template, and register routes</name>
  <files>
    backend/routes/ssrDynamic.js
    backend/views/pages/category.ejs
    backend/index.js
  </files>
  <action>
    1. Create `backend/routes/ssrDynamic.js` with:
       - Import Product model, buildPageData from ./ssr, schemaHelpers, and metaConfig (including categoryDisplayNames).
       - `renderCategoryPage(req, res)` async handler:
         a. Extract lang and category from req.params
         b. Validate category is one of the known slugs (necklaces, crochet-necklaces, hoops, dangle, bracelets, unisex). If invalid, return 404.
         c. Map URL slug to MongoDB category field if they differ. Check what the frontend categoriesView.js uses as the category field value. The frontend View.js links show "necklaces", "crochetNecklaces", "hoops", "dangle" as the internal category names. So create a mapping: { 'necklaces': 'necklaces', 'crochet-necklaces': 'crochetNecklaces', 'hoops': 'hoops', 'dangle': 'dangle', 'bracelets': 'bracelets', 'unisex': 'unisex' } (mapping URL slug to DB category value). If crochet-necklaces maps to crochetNecklaces in DB, use that mapping.
         d. Query Product.find({ category: dbCategory, available: true }).sort({ displayOrder: 1 }).limit(20).select('id name slug images mainImage description quantity ils_price usd_price category sku discount_percentage original_ils_price original_usd_price').lean()
         e. If no products found, render 404 page
         f. Build pageData using buildPageData(req, category-slug, [...styles]). Use category CSS files: categories-devices.css (max-width: 799.9px), categories-800plus.css (min-width: 800px), plus standard reset, desktop-menu, footer, mobile-menu CSS.
         g. Override canonical and alternateUrl to point to category-specific URLs (baseUrl/lang/category)
         h. Add to pageData: category (url slug), categoryDisplayName (from categoryDisplayNames[category][langKey]), products, ssrFlag: true
         i. Generate product schema items using generateProductSchema for each product
         j. Generate breadcrumb schema: [{ name: Home/בית, url: /urlLang }, { name: categoryDisplayName }] (category is current page, no URL)
         k. Pass schemaItems and breadcrumbSchema to pageData
         l. res.render('pages/category', pageData)
         m. Wrap in try/catch, render error page on failure (consistent with Phase 24 pattern)
       - Export renderCategoryPage

    2. Create `backend/views/pages/category.ejs`:
       - Follow exact same structure as home.ejs: doctype, html tag with lang/dir, head with meta-tags include, structured data script tags, controller.js script, Clarity script, body.
       - Body id should be "categories" with class set to the URL category slug and data-hebrew attribute for the Hebrew category name (matching how the frontend categoriesView.js detects category from body).
       - Include header partial
       - Main content area with category title (h1 with categoryDisplayName)
       - Product grid container with `data-ssr="true"` attribute and class "outer-products-container" (matching frontend CSS selectors)
       - Inner container with class "inner-products-container"
       - Loop over products rendering product cards. Each card should have:
         - Container div with class "product-card" and data-product-id
         - Product image using picture element or img with srcset for desktop/mobile (use product.images[0]?.publicDesktop and publicMobile, fallback to mainImage.publicDesktop/publicMobile)
         - Product name
         - Price display (use lang to determine currency: eng->usd_price with $ symbol, heb->ils_price with ILS symbol)
         - Discount badge if discount_percentage > 0
         - Link to product detail page: /urlLang/product/product.slug
       - The HTML structure must match what categoriesView.js would produce so existing CSS works. Read categoriesView.js carefully to match class names and structure.
       - Include product-schema partial with schemaItems
       - Include breadcrumb-schema partial with breadcrumbSchema
       - Include footer partial

    3. Register routes in `backend/index.js`:
       - Import renderCategoryPage from './routes/ssrDynamic'
       - Add route AFTER the static page routes (line ~1188) and BEFORE the locale detection routes:
         `app.get('/:lang(en|he)/:category(necklaces|crochet-necklaces|hoops|dangle|bracelets|unisex)', languageMiddleware, renderCategoryPage);`
       - Use regex constraint on :category param to only match valid category slugs (prevents collision with other routes)
  </action>
  <verify>
    - Start dev server: `cd backend && npm run devStart`
    - `curl -s http://localhost:4000/en/necklaces | grep -c "data-ssr"` returns at least 1
    - `curl -s http://localhost:4000/en/necklaces | grep "application/ld+json"` shows Product and BreadcrumbList schemas
    - `curl -s http://localhost:4000/he/necklaces | grep "ILS"` shows ILS prices
    - `curl -s http://localhost:4000/en/invalid-category` returns 404
    - Page source shows product names, images, prices in HTML (not injected by JS)
  </verify>
  <done>
    All 6 category pages render at /:lang/:category with SSR product grids containing product names, images, prices, and descriptions. Product JSON-LD and BreadcrumbList JSON-LD are present in page source. data-ssr="true" flag is on the product grid container. Invalid categories return 404.
  </done>
</task>

</tasks>

<verification>
1. Visit /en/necklaces and view page source -- product data visible in HTML, not empty containers
2. Visit /he/dangle and verify Hebrew UI chrome with ILS prices
3. View source shows Product JSON-LD array with valid offers (availability as full URL)
4. View source shows BreadcrumbList JSON-LD with Home > Category hierarchy
5. Visit /en/nonexistent returns 404
6. Product grid container has data-ssr="true" attribute
</verification>

<success_criteria>
- All 6 category URLs work in both languages (12 total routes)
- Products display with correct images, names, prices per language
- Product JSON-LD passes schema validation (name, image, offers with price/currency/availability)
- BreadcrumbList JSON-LD shows correct hierarchy
- Meta title and description are category-specific
- Canonical URL and hreflang alternates are correct for each category page
</success_criteria>

<output>
After completion, create `.planning/phases/25-dynamic-ssr-structured-data-sitemap/25-01-SUMMARY.md`
</output>
