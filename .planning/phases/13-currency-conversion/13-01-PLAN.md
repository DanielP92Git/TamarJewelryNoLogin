---
phase: 13-currency-conversion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/unit/services/exchangeRateService.test.js
autonomous: true

must_haves:
  truths:
    - "fetchCurrentRate returns rate from primary API and identifies source"
    - "fetchCurrentRate falls back to secondary API when primary fails"
    - "fetchCurrentRate rejects invalid rates (negative, zero, NaN, missing ILS)"
    - "fetchCurrentRate throws when all APIs fail"
    - "getStoredRate returns rate from Settings document"
    - "getStoredRate returns null when no settings exist"
    - "updateRate stores rate, source, and timestamp in Settings"
    - "updateRate rejects invalid rates (negative, zero, NaN)"
    - "getExchangeRate returns stored rate when available (no forceRefresh)"
    - "getExchangeRate with forceRefresh fetches from API and updates DB"
    - "getExchangeRate falls back to env variable when DB has no rate"
    - "getExchangeRate falls back to DEFAULT_EXCHANGE_RATE (3.3) when all else fails"
    - "isRateStale returns true when rate is older than maxAgeHours"
    - "isRateStale returns false when rate is fresh"
    - "isRateStale returns true when no rate or timestamp exists"
  artifacts:
    - path: "backend/tests/unit/services/exchangeRateService.test.js"
      provides: "Unit tests for all 5 exported service functions"
      min_lines: 200
  key_links:
    - from: "backend/tests/unit/services/exchangeRateService.test.js"
      to: "backend/services/exchangeRateService.js"
      via: "import"
      pattern: "require.*exchangeRateService|import.*exchangeRateService"
    - from: "backend/tests/unit/services/exchangeRateService.test.js"
      to: "backend/tests/helpers/mocks/exchangeRate.js"
      via: "import mock helpers"
      pattern: "mockExchangeRateAPI|mockExchangeRateError|mockExchangeRateFallback"
---

<objective>
Test all 5 exported functions of exchangeRateService.js: fetchCurrentRate, getStoredRate, updateRate, getExchangeRate, and isRateStale. These tests verify the exchange rate API fetching, database caching, fallback chain (API -> DB -> env -> default), staleness detection, and input validation.

Purpose: Covers CURR-01 (API fetch), CURR-02 (fallback to cached rate), CURR-05 (edge cases), CURR-06 (caching with timestamp), CURR-07 (cache TTL). These are the core backend currency functions that all other currency features depend on.

Output: `backend/tests/unit/services/exchangeRateService.test.js` with comprehensive unit tests.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/services/exchangeRateService.js
@backend/models/Settings.js
@backend/tests/helpers/mocks/exchangeRate.js
@backend/tests/helpers/mocks/index.js
@backend/tests/helpers/factories.js
@backend/tests/setup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Exchange rate service unit tests</name>
  <files>backend/tests/unit/services/exchangeRateService.test.js</files>
  <action>
Create comprehensive unit tests for `backend/services/exchangeRateService.js`. The file uses CommonJS (`require`/`module.exports`), so import it accordingly in the test file (Vitest supports both ESM and CJS).

The service exports 5 functions + 1 constant. Tests should be organized in describe blocks per function:

**1. `fetchCurrentRate()` tests (~8 tests):**
- Successful fetch from primary API (exchangerate-api.com): mock `https://api.exchangerate-api.com/v4/latest/USD` with `{ rates: { ILS: 3.75 } }`. Assert returns `{ rate: 3.75, source: 'exchangerate-api.com' }`.
- Fallback to secondary API when primary fails: mock primary with 500, mock `https://api.exchangerate.host/latest?base=USD&symbols=ILS` with `{ rates: { ILS: 3.70 } }`. Assert returns rate from fallback.
- Handles `result` response format from fallback API: mock with `{ result: 3.65 }`. Assert returns `{ rate: 3.65, source: 'exchangerate.host' }`.
- Rejects negative rate: mock primary with `{ rates: { ILS: -3.75 } }`, mock fallback similarly. Expect throws "All exchange rate APIs failed".
- Rejects zero rate: mock primary with `{ rates: { ILS: 0 } }`, mock fallback similarly. Expect throws.
- Rejects missing ILS in response: mock with `{ rates: { EUR: 0.92 } }` (no ILS). Both APIs. Expect throws with "All exchange rate APIs failed".
- Rejects malformed response (200 OK but invalid structure): mock with `{ foo: 'bar' }`. Expect throws.
- Throws when all APIs fail (both return 500): use `mockExchangeRateError()` from existing mocks. Assert throws with error message containing "All exchange rate APIs failed".

IMPORTANT: `fetchCurrentRate` uses `globalThis.fetch` (not `http`/`https` module). nock intercepts Node's HTTP requests, which `globalThis.fetch` in Node 18+ uses under the hood. This should work with nock. If fetch-based nock interception fails, use `nock` with `{ allowUnmocked: false }` or consider that the service has a fallback to `https` module for older Node versions.

**2. `getStoredRate()` tests (~3 tests):**
- Returns stored rate when Settings document has `usd_ils_rate` set. Create a Settings document first via `Settings.getSettings()` then set `usd_ils_rate = 3.70` and save.
- Returns null when Settings has no `usd_ils_rate` (fresh Settings document).
- Returns null when Settings document has `usd_ils_rate: 0` (falsy value check -- the code uses `settings.usd_ils_rate || null` so 0 returns null).

**3. `updateRate(rate, source)` tests (~5 tests):**
- Stores rate, source, and timestamp in Settings. Call `updateRate(3.80, 'test-source')`, then read Settings and verify `usd_ils_rate === 3.80`, `exchange_rate_source === 'test-source'`, `exchange_rate_last_updated` is a recent Date.
- Rejects negative rate: call `updateRate(-1, 'test')`. Expect throws with "Invalid rate value".
- Rejects zero rate: call `updateRate(0, 'test')`. Expect throws.
- Rejects NaN: call `updateRate(NaN, 'test')`. Expect throws.
- Rejects Infinity: call `updateRate(Infinity, 'test')`. Expect throws.

**4. `getExchangeRate(forceRefresh)` tests (~7 tests):**
This is the fallback chain function. Test each layer:
- Returns stored rate when DB has a valid rate (no API call needed): Seed Settings with rate 3.70 via `updateRate(3.70, 'seed')`. Call `getExchangeRate(false)`. Assert returns 3.70. Assert NO HTTP requests were made (use `nock.pendingMocks()` or similar -- no mocks should be registered, and if nock is in strict mode it would catch leaks).
- forceRefresh=true fetches from API and updates DB: Mock primary API with rate 3.85. Call `getExchangeRate(true)`. Assert returns 3.85. Read Settings and verify `usd_ils_rate === 3.85`.
- forceRefresh=true falls back to stored rate when API fails: Seed Settings with 3.70. Mock both APIs to fail (500). Call `getExchangeRate(true)`. Assert returns 3.70 (stored rate used as fallback).
- Falls back to `process.env.USD_ILS_RATE` when DB has no rate: Ensure no Settings rate. Set `process.env.USD_ILS_RATE = '3.50'`. Call `getExchangeRate(false)`. Assert returns 3.50. Clean up env var in afterEach.
- Falls back to DEFAULT_EXCHANGE_RATE (3.3) when DB and env both missing: Ensure no Settings rate. Delete `process.env.USD_ILS_RATE`. Call `getExchangeRate(false)`. Assert returns 3.3.
- Env variable rate gets stored in DB for future use: Set `process.env.USD_ILS_RATE = '3.50'`. Call `getExchangeRate(false)`. Read Settings and verify rate was stored.
- Handles very large rate without overflow: Mock API with rate 999999.99. Call `getExchangeRate(true)`. Assert returns 999999.99.

IMPORTANT: Save and restore `process.env.USD_ILS_RATE` in beforeEach/afterEach to prevent test pollution.

**5. `isRateStale(maxAgeHours)` tests (~5 tests):**
- Returns false when rate was updated within maxAgeHours: Call `updateRate(3.70, 'test')` (sets `exchange_rate_last_updated` to now). Call `isRateStale(24)`. Assert returns false.
- Returns true when rate is older than maxAgeHours: Create Settings with `exchange_rate_last_updated` set to 25 hours ago. Call `isRateStale(24)`. Assert returns true. To set a past date, use `Settings.getSettings()`, set `usd_ils_rate = 3.70`, set `exchange_rate_last_updated = new Date(Date.now() - 25 * 60 * 60 * 1000)`, save.
- Returns true when no rate exists (fresh Settings): Call `isRateStale()`. Assert returns true.
- Returns true when no timestamp exists: Create Settings with `usd_ils_rate = 3.70` but `exchange_rate_last_updated = null`. Call `isRateStale()`. Assert returns true.
- Custom maxAgeHours: Set rate updated 2 hours ago. Call `isRateStale(1)` (1-hour max). Assert returns true. Call `isRateStale(3)` (3-hour max). Assert returns false.

**6. `DEFAULT_EXCHANGE_RATE` constant test (~1 test):**
- Assert `DEFAULT_EXCHANGE_RATE === 3.3`.

**Test setup pattern:**
```javascript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import nock from 'nock';

// Use afterEach from setup.js (already configured) for DB cleanup + mock cleanup.
// Additional cleanup for env vars as needed.
```

Import the service with: `const exchangeRateService = require('../../services/exchangeRateService');` or use dynamic import if needed with ESM.

Use `nock.cleanAll()` in afterEach (already done by setup.js). For the getExchangeRate env variable tests, save/restore `process.env.USD_ILS_RATE` explicitly.
  </action>
  <verify>
Run `cd backend && npx vitest run tests/unit/services/exchangeRateService.test.js` -- all tests pass.
Expected: ~29 tests across 6 describe blocks, all passing.
Run `cd backend && npx vitest run` to verify no regressions in existing tests.
  </verify>
  <done>
All 5 service functions have comprehensive unit tests covering:
- fetchCurrentRate: primary API, fallback API, invalid rates, all-fail scenario
- getStoredRate: stored rate, null when missing
- updateRate: valid storage, invalid rate rejection
- getExchangeRate: full fallback chain (API -> DB -> env -> default)
- isRateStale: fresh rate, stale rate, missing rate, custom TTL
- DEFAULT_EXCHANGE_RATE constant verified
Requirements covered: CURR-01, CURR-02, CURR-05 (partial), CURR-06, CURR-07
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npx vitest run tests/unit/services/exchangeRateService.test.js` passes with 0 failures
2. `cd backend && npx vitest run` passes (no regressions in existing 147+ tests)
3. Test file covers all 5 exported functions of exchangeRateService.js
4. No real HTTP requests are made during tests (nock intercepts all)
5. No production database is accessed (mongodb-memory-server only)
</verification>

<success_criteria>
- All exchange rate service unit tests pass
- fetchCurrentRate tested with primary API, fallback API, and failure scenarios
- getExchangeRate fallback chain fully tested (API -> DB -> env -> default 3.3)
- isRateStale TTL logic verified (fresh, stale, missing, custom hours)
- updateRate validates and persists rate + timestamp + source
- No test pollution between test cases (env vars restored, DB cleared)
</success_criteria>

<output>
After completion, create `.planning/phases/13-currency-conversion/13-01-SUMMARY.md`
</output>
