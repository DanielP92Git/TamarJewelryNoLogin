---
phase: 16-security-and-middleware
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/integration/security.cors.test.js
autonomous: true

must_haves:
  truths:
    - "CORS allows configured origins in production mode"
    - "CORS rejects unauthorized origins in production mode"
    - "CORS allows any localhost port in development mode"
    - "CORS preflight handles OPTIONS requests correctly"
    - "CORS credentials and allowed headers are properly configured"
  artifacts:
    - path: "backend/tests/integration/security.cors.test.js"
      provides: "CORS middleware integration tests"
      min_lines: 150
      contains: "describe.*CORS"
  key_links:
    - from: "backend/tests/integration/security.cors.test.js"
      to: "backend/index.js"
      via: "supertest app import"
      pattern: "import.*index.js|request\\(app\\)"
---

<objective>
Test CORS middleware configuration for both production and development modes

Purpose: Verify the application properly controls cross-origin requests - allowing legitimate origins while blocking unauthorized ones. CORS misconfiguration is a critical security vulnerability that could allow malicious sites to make authenticated requests on behalf of users.

Output: Integration test file covering SEC-01, SEC-02, SEC-03 requirements with ~20 test cases
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-security-and-middleware/16-CONTEXT.md
@.planning/phases/16-security-and-middleware/16-RESEARCH.md

# Test infrastructure patterns
@backend/tests/setup.js
@backend/tests/integration/auth.login.test.js

# CORS configuration (lines 614-684)
@backend/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CORS production mode tests</name>
  <files>backend/tests/integration/security.cors.test.js</files>
  <action>
Create `backend/tests/integration/security.cors.test.js` with CORS middleware tests.

**File structure:**
- Import vitest (describe, it, expect, beforeAll, afterAll, beforeEach)
- Import supertest (request)
- Import helpers (validateTestEnvironment, disableNetConnect, cleanAllMocks)
- Dynamic app import in beforeAll (pattern from auth.login.test.js)

**Test suites to create:**

1. **Production Mode CORS (NODE_ENV=production):**

Before importing app, set:
```javascript
process.env.NODE_ENV = 'production';
process.env.HOST = 'https://example.com';
process.env.ADMIN_URL = 'https://admin.example.com';
```

Tests (SEC-01, SEC-02):
- `should allow configured HOST origin` - Set Origin header to https://example.com, verify Access-Control-Allow-Origin returned
- `should allow configured ADMIN_URL origin` - Origin: https://admin.example.com, verify allowed
- `should reject unauthorized origin in production` - Origin: https://malicious-site.com, verify no ACAO header or error
- `should reject similar-looking domain (subdomain attack)` - Origin: https://example.com.evil.com, verify rejected
- `should reject null origin in production` - Origin: null (common attack vector)
- `should allow same-origin requests (no Origin header)` - Request without Origin header should succeed (non-browser clients)

2. **CORS Preflight (OPTIONS) Tests:**
- `should return 204 for valid preflight request` - OPTIONS with Origin + Access-Control-Request-Method
- `should include Access-Control-Allow-Methods header` - Verify GET, POST, PUT, PATCH, DELETE, OPTIONS
- `should include Access-Control-Allow-Headers header` - Verify Content-Type, Authorization, auth-token, X-Requested-With
- `should include Access-Control-Allow-Credentials header` - Verify 'true' for cookie support

3. **CORS Rejection Details:**
- `should not expose server information on CORS failure` - No stack traces, minimal error response
- `should not set ACAO header for rejected origins` - Verify header is undefined/missing

**Testing approach:**
- Use `/allproducts` endpoint for GET tests (public, no auth needed)
- Use OPTIONS requests for preflight tests
- Set Origin header using `.set('Origin', 'https://...')`
- Check response.headers['access-control-allow-origin'] for allow/reject

**Important:** The CORS origin callback in index.js returns `callback(new Error('Not allowed by CORS'))` for rejected origins, which Express translates to an error response. Verify the behavior by checking either the error response or missing ACAO header.
  </action>
  <verify>
Run: `cd backend && npm test -- --run security.cors.test.js`
All tests pass. Verify at least 10 test cases for production mode.
  </verify>
  <done>
CORS production tests pass, covering SEC-01 (allow configured) and SEC-02 (reject unauthorized).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CORS development mode and edge case tests</name>
  <files>backend/tests/integration/security.cors.test.js</files>
  <action>
Add development mode tests to the existing security.cors.test.js file.

**Additional test suites to add:**

4. **Development Mode CORS (NODE_ENV !== production):**

Create a separate describe block that sets NODE_ENV to 'development' or 'test':
```javascript
describe('CORS Middleware - Development Mode', () => {
  // Reset and set dev environment before app import
});
```

Tests (SEC-03):
- `should allow localhost:5500 in development` - Origin: http://localhost:5500, verify allowed
- `should allow localhost:3000 in development` - Origin: http://localhost:3000, verify allowed
- `should allow localhost with any port in development` - Origin: http://localhost:8080, verify allowed
- `should allow 127.0.0.1 with any port in development` - Origin: http://127.0.0.1:9999, verify allowed
- `should still reject non-localhost origins in development` - Origin: https://malicious.com, verify behavior (may still reject or allow based on config)

5. **Edge Cases:**
- `should handle malformed Origin header gracefully` - Origin: 'not-a-url', no crash
- `should handle empty Origin header` - Origin: '', verify behavior
- `should handle Origin with trailing slash` - Origin: https://example.com/, verify normalization
- `should handle case variations in localhost` - Origin: http://LOCALHOST:5500

6. **Security Headers (Helmet integration):**
- `should set X-Content-Type-Options header` - Verify 'nosniff'
- `should set X-Frame-Options header` - Verify 'SAMEORIGIN'
- `should NOT set X-Powered-By header` - Helmet removes this
- `should set X-DNS-Prefetch-Control header` - Verify 'off'

**Note on app isolation:** Since CORS behavior depends on NODE_ENV at module load time, you may need to:
1. Use separate test files for prod vs dev (if dynamic reload is complex)
2. OR use vi.resetModules() and dynamic import to reload app with different env
3. Document in test comments which approach is used

**Threat model comments:** Add JSDoc comments explaining why each test exists:
```javascript
/**
 * SEC-02: CORS subdomain attack protection
 * Threat: Attacker registers example.com.evil.com to bypass naive origin checks
 * Protection: Origin callback uses strict URL parsing, not substring matching
 */
it('should reject similar-looking domain (subdomain attack)', ...);
```
  </action>
  <verify>
Run: `cd backend && npm test -- --run security.cors.test.js`
All tests pass (production + development + edge cases + security headers).
Expected: 18-25 test cases total.
  </verify>
  <done>
CORS tests complete, covering SEC-01, SEC-02, SEC-03 requirements. Security headers verified.
  </done>
</task>

</tasks>

<verification>
Run full CORS test suite:
```bash
cd backend && npm test -- --run security.cors.test.js
```

Expected output:
- All tests pass
- Coverage includes production, development, preflight, and edge cases
- Security headers from Helmet are verified

Count tests:
```bash
grep -c "it\(" backend/tests/integration/security.cors.test.js
```
Target: 18+ test cases
</verification>

<success_criteria>
- [ ] security.cors.test.js exists with 18+ test cases
- [ ] SEC-01: Tests verify configured origins are allowed in production
- [ ] SEC-02: Tests verify unauthorized origins are rejected in production
- [ ] SEC-03: Tests verify localhost origins are allowed in development
- [ ] Preflight OPTIONS requests handled correctly
- [ ] Security headers (Helmet) verified
- [ ] All tests pass: `npm test -- --run security.cors.test.js`
</success_criteria>

<output>
After completion, create `.planning/phases/16-security-and-middleware/16-01-SUMMARY.md`
</output>
