---
phase: 11-authentication-authorization-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/integration/auth.signup.test.js
autonomous: true

must_haves:
  truths:
    - "Valid signup creates user and returns 201"
    - "Duplicate email returns 400 with 'Existing user' error"
    - "Missing required fields returns 400"
    - "Password is hashed with bcrypt before storage"
  artifacts:
    - path: "backend/tests/integration/auth.signup.test.js"
      provides: "Signup endpoint integration tests"
      contains: "describe('POST /signup'"
  key_links:
    - from: "backend/tests/integration/auth.signup.test.js"
      to: "backend/index.js"
      via: "supertest POST /signup"
      pattern: "request\\(app\\).*post.*\\/signup"
---

<objective>
Create comprehensive signup endpoint tests.

Purpose: Verify the signup endpoint correctly creates users with hashed passwords, validates required fields, and prevents duplicate email registration.

Output: Signup integration test suite with 6+ tests covering user creation, validation, and duplicate prevention.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 11 research
@.planning/phases/11-authentication-a-authorization-tests/11-RESEARCH.md

# Test infrastructure
@backend/tests/setup.js
@backend/tests/helpers/factories.js
@backend/tests/integration/sample.integration.test.js

# Source code to test
@backend/index.js (lines 1645-1697 for signup endpoint)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create signup endpoint integration tests</name>
  <files>backend/tests/integration/auth.signup.test.js</files>
  <action>
Create comprehensive integration tests for POST /signup endpoint.

Test structure:
```javascript
import { describe, it, expect, beforeAll, beforeEach, afterAll } from 'vitest';
import request from 'supertest';
import bcrypt from 'bcrypt';
import mongoose from 'mongoose';
import { createUser } from '../helpers/factories.js';
import { validateTestEnvironment } from '../helpers/envGuard.js';
import { disableNetConnect, cleanAllMocks } from '../helpers/mocks/index.js';
```

Test cases to implement:

1. **Success cases:**
   - `should create user and return 201 for valid signup data`
     - POST with { email, password, username }
     - Expect 201, message: 'User Created!'
     - Verify user exists in database after signup

   - `should hash password before storing in database`
     - Signup with known plaintext password
     - Query database for created user
     - Verify password field is NOT plaintext (starts with $2b$ or $2a$ for bcrypt)
     - Verify bcrypt.compare(plaintextPassword, storedHash) returns true

   - `should create user with userType "user" by default`
     - Signup new user
     - Query database
     - Expect userType === 'user'

2. **Validation failures:**
   - `should return 400 for missing email`
     - POST with { password, username } only
     - Expect 400, errors: 'Invalid signup payload'

   - `should return 400 for missing password`
     - POST with { email, username } only
     - Expect 400

   - `should return 400 for missing username`
     - POST with { email, password } only
     - Expect 400

3. **Duplicate prevention:**
   - `should return 400 for duplicate email`
     - Create user with email 'existing@example.com' using factory
     - POST signup with same email
     - Expect 400, errors contains 'Existing user'

4. **Data integrity:**
   - `should initialize cartData for new user`
     - Signup new user
     - Query database
     - Verify cartData object exists and is initialized

Implementation notes:
- Import app dynamically in beforeAll
- Use unique emails for each test (use counter or timestamp)
- Query Users model directly to verify database state:
  ```javascript
  const Users = mongoose.model('Users');
  const savedUser = await Users.findOne({ email: 'test@example.com' });
  ```
- Use bcrypt.compare to verify password hashing works correctly
  </action>
  <verify>
Run: `cd backend && npm test -- --run --reporter=verbose tests/integration/auth.signup.test.js`

All tests should pass. Expect 7+ test cases.
  </verify>
  <done>
auth.signup.test.js passes all tests. Signup endpoint correctly:
- Creates users with 201 response
- Hashes passwords with bcrypt
- Sets default userType to 'user'
- Validates required fields (400 for missing)
- Prevents duplicate emails (400 for existing)
- Initializes cartData object
  </done>
</task>

<task type="auto">
  <name>Task 2: Add password hashing verification tests</name>
  <files>backend/tests/integration/auth.signup.test.js</files>
  <action>
Add additional tests to the signup test file for bcrypt password hashing verification.

Add these test cases to the existing file:

1. **bcrypt-specific tests:**
   - `should generate unique salt for each password hash`
     - Sign up two users with identical passwords
     - Query both from database
     - Verify their password hashes are different (different salts)
     - Verify both hashes validate against the original password

   - `should use bcrypt cost factor of 10`
     - Sign up a user
     - Query from database
     - Extract cost factor from hash: `const cost = parseInt(hash.split('$')[2], 10);`
     - Expect cost to be 10 (production setting)

Note: These tests verify the bcrypt configuration matches production settings. The backend uses `bcrypt.hash(password, 10)` where 10 is the salt rounds.
  </action>
  <verify>
Run: `cd backend && npm test -- --run --reporter=verbose tests/integration/auth.signup.test.js`

All tests should pass including the new bcrypt verification tests.
  </verify>
  <done>
auth.signup.test.js has 9+ tests covering all signup scenarios including bcrypt hashing verification with unique salts and cost factor validation.
  </done>
</task>

</tasks>

<verification>
```bash
cd backend && npm test -- --run --reporter=verbose tests/integration/auth.signup.test.js
```

Expected output:
- 9+ passing tests
- Password hashing verified with bcrypt
- Duplicate email prevention works
- Validation catches missing fields
</verification>

<success_criteria>
1. auth.signup.test.js exists with 9+ passing tests
2. User creation returns 201 and creates database record
3. Password is hashed with bcrypt (not stored in plaintext)
4. Duplicate email detection returns 400
5. Missing required fields return 400 validation error
6. bcrypt uses unique salts and cost factor 10
</success_criteria>

<output>
After completion, create `.planning/phases/11-authentication-a-authorization-tests/11-02-SUMMARY.md`
</output>
