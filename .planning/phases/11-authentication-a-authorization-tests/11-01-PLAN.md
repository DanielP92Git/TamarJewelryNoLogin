---
phase: 11-authentication-authorization-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/helpers/authHelpers.js
  - backend/tests/integration/auth.login.test.js
autonomous: true

must_haves:
  truths:
    - "Valid credentials return 200 with JWT token in response"
    - "Invalid password returns 401 Auth Failed"
    - "Non-existent email returns 404 No user found"
    - "Missing email or password returns 400 Invalid payload"
  artifacts:
    - path: "backend/tests/helpers/authHelpers.js"
      provides: "Token creation helpers for tests"
      exports: ["createAuthToken", "createExpiredToken", "createInvalidToken"]
    - path: "backend/tests/integration/auth.login.test.js"
      provides: "Login endpoint integration tests"
      contains: "describe('POST /login'"
  key_links:
    - from: "backend/tests/integration/auth.login.test.js"
      to: "backend/index.js"
      via: "supertest POST /login"
      pattern: "request\\(app\\).*post.*\\/login"
---

<objective>
Create auth test helpers and comprehensive login endpoint tests.

Purpose: Establish reusable token generation helpers and verify the login endpoint correctly authenticates users, returns valid JWT tokens for valid credentials, and rejects invalid credentials with appropriate error codes.

Output: Auth helper module and login integration test suite with 6+ tests covering success and error scenarios.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 11 research with patterns
@.planning/phases/11-authentication-a-authorization-tests/11-RESEARCH.md

# Existing test infrastructure
@backend/tests/setup.js
@backend/tests/helpers/factories.js
@backend/tests/helpers/fixtures/users.js
@backend/tests/integration/sample.integration.test.js

# Source code to test
@backend/middleware/auth.js
@backend/index.js (lines 1594-1643 for login endpoint)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth test helpers module</name>
  <files>backend/tests/helpers/authHelpers.js</files>
  <action>
Create a helper module for generating JWT tokens in tests. Include:

1. `createAuthToken(userDoc, options = {})` - Creates valid JWT token from user document
   - Payload: `{ user: { id: userDoc._id.toString(), email: userDoc.email, userType: userDoc.userType } }`
   - Default expiration: '1h'
   - Use process.env.JWT_KEY (set by vitest.config.js env)
   - Accept options to override jwt.sign options

2. `createExpiredToken(userDoc)` - Creates already-expired token
   - Same payload structure
   - Set expiresIn: '-1s' (expired 1 second ago)

3. `createInvalidToken(userDoc)` - Creates token with wrong signature
   - Same payload structure
   - Sign with 'wrong-secret-key' instead of JWT_KEY

4. `TEST_JWT_KEY` constant - Export a test JWT key for tests that need to set it
   - Use a complex value: 'test-jwt-secret-key-32-chars-long!'

Important: At top of file, set process.env.JWT_KEY if not already set:
```javascript
// Ensure JWT_KEY is set for tests (before any imports that might use it)
if (!process.env.JWT_KEY) {
  process.env.JWT_KEY = 'test-jwt-secret-key-32-chars-long!';
}
```

Use ESM exports (export function, not module.exports).
  </action>
  <verify>
Run: `cd backend && npm test -- --run --reporter=verbose tests/helpers/authHelpers.js 2>&1 || echo "No direct tests for helpers (expected)"`

Verify file exists and exports functions:
`node -e "import('./tests/helpers/authHelpers.js').then(m => console.log(Object.keys(m)))"`
  </verify>
  <done>
authHelpers.js exports createAuthToken, createExpiredToken, createInvalidToken, and TEST_JWT_KEY.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login endpoint integration tests</name>
  <files>backend/tests/integration/auth.login.test.js</files>
  <action>
Create comprehensive integration tests for POST /login endpoint using supertest.

Test structure:
```javascript
import { describe, it, expect, beforeAll, beforeEach } from 'vitest';
import request from 'supertest';
import jwt from 'jsonwebtoken';
import mongoose from 'mongoose';
import { createUser, createAdmin } from '../helpers/factories.js';
import { mockUserCredentials, mockAdminCredentials } from '../helpers/fixtures/users.js';
import { createAuthToken, TEST_JWT_KEY } from '../helpers/authHelpers.js';
import { validateTestEnvironment } from '../helpers/envGuard.js';
import { disableNetConnect, cleanAllMocks } from '../helpers/mocks/index.js';
```

Test cases to implement:

1. **Success cases:**
   - `should return 200 and JWT token for valid user credentials`
     - Create user with known password (use factory with hashed password)
     - POST /login with email and plaintext password
     - Expect 200, success: true, token defined
     - Verify token decodes to correct user id and email

   - `should return adminCheck field matching user type`
     - Test with regular user (adminCheck: 'user')
     - Test with admin user (adminCheck: 'admin')

2. **Authentication failures:**
   - `should return 401 for incorrect password`
     - Create user, send wrong password
     - Expect 401, success: false, errors: 'Auth Failed'

   - `should return 404 for non-existent email`
     - POST with email that doesn't exist in DB
     - Expect 404, errors contains 'No user found'

3. **Validation failures:**
   - `should return 400 for missing email`
     - POST with { password } only
     - Expect 400, errors: 'Invalid login payload'

   - `should return 400 for missing password`
     - POST with { email } only
     - Expect 400

4. **Token verification:**
   - `should return token that validates with JWT_KEY`
     - Get token from successful login
     - jwt.verify(token, process.env.JWT_KEY) should not throw
     - Decoded payload should have user.id, user.email, user.userType

Important implementation notes:
- Import app dynamically: `const { app } = await import('../../index.js');`
- Use beforeAll to validate environment and import app
- Create fresh users in each test using factories
- Use bcrypt.hashSync with 10 rounds in factories (already configured)
- Test credentials: create user with factory, use plaintext 'TestPassword123' for login
  </action>
  <verify>
Run: `cd backend && npm test -- --run --reporter=verbose tests/integration/auth.login.test.js`

All tests should pass. Expect 6+ test cases covering:
- Valid login returns 200 + token
- Invalid password returns 401
- Non-existent email returns 404
- Missing fields return 400
- Token is valid JWT
  </verify>
  <done>
auth.login.test.js passes all tests. Login endpoint correctly:
- Returns JWT for valid credentials
- Returns 401 for wrong password
- Returns 404 for unknown email
- Returns 400 for invalid payload
  </done>
</task>

</tasks>

<verification>
```bash
cd backend && npm test -- --run --reporter=verbose tests/integration/auth.login.test.js
```

Expected output:
- 6+ passing tests
- No production contamination warnings
- Tests use mongodb-memory-server (127.0.0.1)
</verification>

<success_criteria>
1. authHelpers.js exists with createAuthToken, createExpiredToken, createInvalidToken exports
2. auth.login.test.js has 6+ passing tests
3. Login success case verifies JWT token structure and validity
4. Login failure cases verify correct HTTP status codes (400, 401, 404)
5. No tests touch production database or APIs
</success_criteria>

<output>
After completion, create `.planning/phases/11-authentication-a-authorization-tests/11-01-SUMMARY.md`
</output>
