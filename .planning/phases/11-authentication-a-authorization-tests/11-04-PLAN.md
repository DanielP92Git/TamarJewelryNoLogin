---
phase: 11-authentication-authorization-tests
plan: 04
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - backend/tests/integration/auth.admin.test.js
autonomous: true

must_haves:
  truths:
    - "Admin user can access admin-protected routes"
    - "Regular user cannot access admin-protected routes (403)"
    - "Request without token to admin routes returns 401"
    - "403 response contains 'Admin access required' error"
  artifacts:
    - path: "backend/tests/integration/auth.admin.test.js"
      provides: "Admin route authorization tests"
      contains: "describe('requireAdmin middleware'"
  key_links:
    - from: "backend/tests/integration/auth.admin.test.js"
      to: "backend/middleware/auth.js"
      via: "requireAdmin middleware tested via HTTP"
      pattern: "request\\(app\\).*set.*Authorization.*admin"
---

<objective>
Test requireAdmin middleware through admin-protected endpoints.

Purpose: Verify that admin routes correctly enforce role-based access control, allowing admin users while blocking regular users with appropriate 403 Forbidden responses.

Output: Admin route authorization test suite testing requireAdmin middleware behavior via HTTP boundary.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 11 research
@.planning/phases/11-authentication-a-authorization-tests/11-RESEARCH.md

# Auth helpers from Plan 01
@backend/tests/helpers/authHelpers.js

# Test infrastructure
@backend/tests/setup.js
@backend/tests/helpers/factories.js

# Source code to test
@backend/middleware/auth.js (requireAdmin function)
@backend/index.js (admin endpoints using fetchUser + requireAdmin)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin route authorization tests</name>
  <files>backend/tests/integration/auth.admin.test.js</files>
  <action>
Create integration tests for requireAdmin middleware by testing admin-protected endpoints.

Use GET /admin/products as a test endpoint that uses fetchUser + requireAdmin.
If that doesn't exist, use any endpoint with the pattern `fetchUser, requireAdmin` middleware chain.

Looking at the codebase, good test endpoints are:
- POST /addproduct (requires admin)
- DELETE /removeproduct (requires admin)
- Use a simpler admin endpoint if available

Test structure:
```javascript
import { describe, it, expect, beforeAll, beforeEach } from 'vitest';
import request from 'supertest';
import mongoose from 'mongoose';
import { createUser, createAdmin, createProduct } from '../helpers/factories.js';
import { createAuthToken, TEST_JWT_KEY } from '../helpers/authHelpers.js';
import { validateTestEnvironment } from '../helpers/envGuard.js';
import { disableNetConnect, cleanAllMocks } from '../helpers/mocks/index.js';

// Ensure JWT_KEY is set
process.env.JWT_KEY = TEST_JWT_KEY;
```

Test cases to implement:

1. **Admin access (200):**
   - `should allow admin user to access admin routes`
     - Create admin user (userType: 'admin')
     - Generate token
     - POST to admin endpoint (e.g., /removeproduct with valid product)
     - Expect 200 or appropriate success status

   - `should allow admin to perform admin actions`
     - Create admin, create product
     - DELETE product via admin endpoint
     - Verify product is deleted

2. **Regular user blocked (403):**
   - `should return 403 when regular user accesses admin route`
     - Create regular user (userType: 'user')
     - Generate token
     - POST to admin endpoint
     - Expect 403, errors: 'Admin access required'

   - `should include correct error message in 403 response`
     - Verify response.body.errors contains 'Admin'
     - Verify response.body.success === false

3. **Authentication before authorization (401):**
   - `should return 401 (not 403) when no token provided to admin route`
     - POST to admin endpoint without token
     - Expect 401 (fetchUser runs first, fails before requireAdmin)

   - `should return 401 for expired token on admin route`
     - Create expired admin token
     - Expect 401 (authentication fails before authorization check)

4. **User type edge cases:**
   - `should return 403 for user with undefined userType`
     - Create user without explicit userType
     - Generate token
     - Expect 403 (only 'admin' type passes)

   - `should return 403 for user with empty string userType`
     - Create user with userType: ''
     - Expect 403

5. **Multiple admin endpoints:**
   - `should enforce admin requirement on /addproduct`
     - Regular user token -> 403
     - Admin token -> 200 (with valid product data)

   - `should enforce admin requirement on /removeproduct`
     - Regular user token -> 403
     - Admin token -> 200

Implementation notes:
- The fetchUser middleware runs before requireAdmin
- fetchUser attaches req.userDoc (the full user document)
- requireAdmin checks req.userDoc.userType === 'admin'
- 401 = authentication failed (no/invalid token)
- 403 = authenticated but not authorized (not admin)
- Use createAdmin() factory for admin users
- Use createUser() factory for regular users
  </action>
  <verify>
Run: `cd backend && npm test -- --run --reporter=verbose tests/integration/auth.admin.test.js`

All tests should pass. Expect 10+ test cases.
  </verify>
  <done>
auth.admin.test.js passes all tests. Admin routes correctly:
- Allow admin users access
- Block regular users with 403
- Return 401 when authentication fails (before authorization)
- Include 'Admin access required' in 403 error
- Enforce admin requirement across multiple endpoints
  </done>
</task>

<task type="auto">
  <name>Task 2: Add role-based access control edge cases</name>
  <files>backend/tests/integration/auth.admin.test.js</files>
  <action>
Add additional edge case tests for RBAC behavior.

Add these test cases:

1. **401 vs 403 distinction:**
   - `should return 401 for invalid token (authentication failure)`
     - Send malformed token to admin endpoint
     - Expect 401 (not 403 - authentication fails first)

   - `should return 403 for valid non-admin token (authorization failure)`
     - Send valid user token to admin endpoint
     - Expect 403 (authentication passes, authorization fails)

2. **User type validation:**
   - `should handle userType case sensitivity`
     - Create user with userType: 'Admin' (capital A)
     - Expect 403 (code checks for exact 'admin' match)

   - `should handle userType: 'administrator' (not just 'admin')`
     - Create user with userType: 'administrator'
     - Expect 403 (only 'admin' is valid)

3. **Sequential middleware behavior:**
   - `should attach req.user before requireAdmin check`
     - Verify admin endpoint can access req.user data after passing both middlewares
     - This tests the middleware chain is working correctly

These tests verify the distinction between authentication (401) and authorization (403) which is a common source of confusion and bugs.
  </action>
  <verify>
Run: `cd backend && npm test -- --run --reporter=verbose tests/integration/auth.admin.test.js`

All tests pass including RBAC edge cases.
  </verify>
  <done>
auth.admin.test.js has 14+ tests covering all requireAdmin middleware scenarios including 401 vs 403 distinction and userType edge cases.
  </done>
</task>

</tasks>

<verification>
```bash
cd backend && npm test -- --run --reporter=verbose tests/integration/auth.admin.test.js
```

Expected output:
- 14+ passing tests
- Admin users can access admin routes
- Regular users get 403 on admin routes
- Unauthenticated requests get 401 (not 403)
- Clear distinction between authentication and authorization failures
</verification>

<success_criteria>
1. auth.admin.test.js exists with 14+ passing tests
2. Admin user with valid token gets 200 on admin routes
3. Regular user with valid token gets 403 on admin routes
4. No token gets 401 (authentication failure, not authorization)
5. Invalid token gets 401
6. 403 response includes 'Admin access required' message
7. userType validation is case-sensitive and exact-match
</success_criteria>

<output>
After completion, create `.planning/phases/11-authentication-a-authorization-tests/11-04-SUMMARY.md`
</output>
