---
phase: 07-image-array-migration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - backend/models/Product.js
autonomous: true

must_haves:
  truths:
    - "Migration has been executed and all products have images array field"
    - "Product schema includes images array definition with proper structure"
    - "Old fields (mainImage, smallImages) remain in schema for backwards compatibility"
    - "New products can be created with images array via schema"
    - "Migration status shows as 'applied' in migrate-mongo"
  artifacts:
    - path: "backend/models/Product.js"
      provides: "Updated Product schema with images array field"
      contains: "images:"
  key_links:
    - from: "backend/models/Product.js"
      to: "products collection"
      via: "mongoose.model('Product')"
      pattern: "mongoose\\.model\\(['\"]Product['\"]"
---

<objective>
Execute the migration and update Product schema to include images array field.

Purpose: Transform all existing product data to use unified images array while maintaining backwards compatibility with old field structure. This is the point of no return for the data transformation.

Output: All products have images array populated, schema updated to define new field structure.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-image-array-migration/07-01-SUMMARY.md
@backend/models/Product.js
@backend/migrations/20260203000000-merge-image-arrays.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run final audit and execute migration</name>
  <files></files>
  <action>
Execute the migration sequence:

1. Run audit script one final time to confirm data state:
   ```bash
   cd backend
   node scripts/audit-image-data.js
   ```
   Review output and confirm no blocking issues.

2. Run migration in dry-run mode one more time to preview:
   ```bash
   DRY_RUN=true npx migrate-mongo up
   ```
   Verify sample transformations look correct.

3. Execute the actual migration:
   ```bash
   npx migrate-mongo up
   ```
   Monitor output for any errors.

4. Verify migration success:
   ```bash
   npx migrate-mongo status
   ```
   Confirm migration shows as APPLIED.

5. Spot-check products in database:
   ```bash
   node -e "require('dotenv').config(); const mongoose = require('mongoose'); mongoose.connect(process.env.DB_CONNECTION_STRING).then(async () => { const sample = await mongoose.connection.db.collection('products').findOne({images: {\$exists: true}}); console.log('Sample product images:', JSON.stringify(sample.images, null, 2)); mongoose.disconnect(); })"
   ```

If migration fails: Run `npx migrate-mongo down` to rollback.
  </action>
  <verify>
Verify migration applied:
```bash
cd backend
npx migrate-mongo status
```
Should show migration as APPLIED (UP).

Verify products have images array:
```bash
node -e "require('dotenv').config(); const mongoose = require('mongoose'); mongoose.connect(process.env.DB_CONNECTION_STRING).then(async () => { const total = await mongoose.connection.db.collection('products').countDocuments({}); const withImages = await mongoose.connection.db.collection('products').countDocuments({images: {\$exists: true}}); console.log('Total products:', total, 'With images array:', withImages); mongoose.disconnect(); })"
```
  </verify>
  <done>
Migration executed successfully. All products now have images array. Migration status shows APPLIED.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Product schema with images array definition</name>
  <files>backend/models/Product.js</files>
  <action>
Add images array field to Product schema in backend/models/Product.js.

Add AFTER the smallImagesLocal field and BEFORE the description field:

```javascript
// Unified images array (replaces mainImage + smallImages)
// First image in array is the main/featured image
images: [
  {
    desktop: { type: String },
    mobile: { type: String },
    desktopLocal: { type: String },
    mobileLocal: { type: String },
    publicDesktop: { type: String },
    publicMobile: { type: String },
  },
],
```

DO NOT remove the existing mainImage, smallImages, or smallImagesLocal fields yet - they must remain for backwards compatibility during the transition period.

Add a comment above the new field explaining the migration status:
```javascript
// Unified images array (Phase 7 migration)
// First image = main/featured image
// Old fields (mainImage, smallImages, smallImagesLocal) kept for backwards compatibility
// TODO: Remove old fields after frontend fully migrated
```
  </action>
  <verify>
Verify schema compiles without errors:
```bash
cd backend
node -e "const Product = require('./models/Product'); console.log('Schema fields:', Object.keys(Product.schema.paths).filter(k => k.includes('image') || k === 'images'));"
```
Should output array including both old fields AND new 'images' field.
  </verify>
  <done>
Product schema updated with images array definition. Old fields preserved for backwards compatibility. Schema compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify data integrity post-migration</name>
  <files></files>
  <action>
Run comprehensive verification to ensure migration succeeded:

1. Count verification - all products should have images array:
   ```bash
   cd backend
   node -e "require('dotenv').config(); const mongoose = require('mongoose'); mongoose.connect(process.env.DB_CONNECTION_STRING).then(async () => { const db = mongoose.connection.db; const total = await db.collection('products').countDocuments({}); const withImages = await db.collection('products').countDocuments({images: {\$exists: true, \$ne: []}}); const withEmptyImages = await db.collection('products').countDocuments({images: []}); const withMainImage = await db.collection('products').countDocuments({mainImage: {\$exists: true}}); console.log('Total:', total, '| With images:', withImages, '| Empty images:', withEmptyImages, '| With mainImage:', withMainImage); mongoose.disconnect(); })"
   ```

2. Structure verification - sample product should have correct format:
   ```bash
   node -e "require('dotenv').config(); const mongoose = require('mongoose'); mongoose.connect(process.env.DB_CONNECTION_STRING).then(async () => { const product = await mongoose.connection.db.collection('products').findOne({images: {\$exists: true, \$ne: []}}); console.log('Product:', product.name); console.log('Images count:', product.images.length); console.log('First image keys:', product.images[0] ? Object.keys(product.images[0]) : 'none'); console.log('Has mainImage:', !!product.mainImage); console.log('Has smallImages:', !!product.smallImages); mongoose.disconnect(); })"
   ```

3. Verify old fields still present (backwards compatibility):
   Products should have BOTH old fields AND new images array.

If any verification fails, document the issue but DO NOT rollback yet - Plan 03 will handle API compatibility.
  </action>
  <verify>
All products have images array AND old fields preserved:
- Total products = products with images array (or empty array for products with no images)
- Sample product shows correct structure
- Old mainImage/smallImages fields still exist
  </verify>
  <done>
Data integrity verified. All products have images array with correct structure. Old fields preserved for backwards compatibility.
  </done>
</task>

</tasks>

<verification>
Phase 7 Plan 02 complete when:
- [ ] Migration executed successfully (not just dry-run)
- [ ] migrate-mongo status shows migration as APPLIED
- [ ] Product schema includes images array definition
- [ ] All products have images array field populated
- [ ] Old fields (mainImage, smallImages) still exist in schema and data
- [ ] Sample products show correct images array structure
</verification>

<success_criteria>
- Migration completed without errors
- Schema updated with images array definition
- Data verification shows all products migrated
- Backwards compatibility maintained (old fields preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/07-image-array-migration/07-02-SUMMARY.md`
</output>
