---
phase: 07-image-array-migration
plan: 04
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - frontend/js/Views/categoriesView.js
autonomous: true

must_haves:
  truths:
    - "Frontend uses images array when available"
    - "Frontend falls back to mainImage/smallImages if images array missing"
    - "First image in array displays as main product image"
    - "Gallery thumbnails come from images array"
    - "Product modal shows correct images from unified array"
  artifacts:
    - path: "frontend/js/Views/categoriesView.js"
      provides: "Updated image handling with images array support"
      contains: "images"
  key_links:
    - from: "frontend/js/Views/categoriesView.js:getProductMarkup"
      to: "product.images"
      via: "array access"
      pattern: "images\\[0\\]|images\\.\\[|product\\.images"
    - from: "frontend/js/Views/categoriesView.js:generatePreview"
      to: "product.images"
      via: "gallery rendering"
      pattern: "images\\."
---

<objective>
Update frontend to prefer images array while maintaining fallback to old fields.

Purpose: Enable frontend to use the new unified images array format while gracefully handling products that might still have only old format (defensive programming). Per CONTEXT.md: "Frontend fallback duration: Claude's discretion" - implementing permanent fallback for robustness.

Output: Frontend displays images from images array when available, falls back to mainImage/smallImages if not.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-image-array-migration/07-02-SUMMARY.md
@frontend/js/Views/categoriesView.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update getProductMarkup to use images array</name>
  <files>frontend/js/Views/categoriesView.js</files>
  <action>
Update the getProductMarkup method (around line 1222) to prefer images array for main product display.

Find these lines that get desktop/mobile images:
```javascript
const desktopImage = this.ensureHttps(
  item.mainImage?.publicDesktop ||
    item.mainImage?.desktop ||
    item.publicImage ||
    item.image
);
const mobileImage = this.ensureHttps(
  item.mainImage?.publicMobile ||
    item.mainImage?.mobile ||
    item.mainImage?.desktop ||
    item.image
);
```

Update to check images array FIRST:
```javascript
// Helper to get image URL from images array element or mainImage object
const getMainImageUrl = (item, preferDesktop = true) => {
  // Prefer unified images array
  const mainImg = Array.isArray(item.images) && item.images.length > 0
    ? item.images[0]
    : item.mainImage;

  if (!mainImg || typeof mainImg !== 'object') {
    return item.publicImage || item.image || '';
  }

  if (preferDesktop) {
    return mainImg.publicDesktop || mainImg.desktop || mainImg.publicMobile || mainImg.mobile || '';
  } else {
    return mainImg.publicMobile || mainImg.mobile || mainImg.publicDesktop || mainImg.desktop || '';
  }
};

const desktopImage = this.ensureHttps(getMainImageUrl(item, true));
const mobileImage = this.ensureHttps(getMainImageUrl(item, false));
```

This maintains the same fallback chain but adds images[0] as the preferred source.
  </action>
  <verify>
Load a category page in browser. Open dev tools Network tab.
- Product images should load correctly
- No 404 errors for images
- Inspect API response - products have images array
- Displayed image should match images[0]
  </verify>
  <done>
getProductMarkup updated to prefer images array. Product list displays correctly using unified image format.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update generatePreview for product modal</name>
  <files>frontend/js/Views/categoriesView.js</files>
  <action>
Update the generatePreview method (around line 622) to use images array for gallery thumbnails.

Find the section that builds smallImagesArray (around lines 715-765):
```javascript
// Handle old format (array of strings)
if (Array.isArray(product?.smallImagesLocal)) { ... }
// Handle old/new format from API
else if (Array.isArray(product?.smallImages)) { ... }
```

Insert images array handling BEFORE the existing checks:
```javascript
// Build gallery array - prefer unified images array
let smallImagesArray = [];

// NEW: Prefer unified images array (Phase 7 migration)
if (Array.isArray(product?.images) && product.images.length > 0) {
  smallImagesArray = product.images
    .filter(img => img && typeof img === 'object')
    .map(img => {
      // Get best URL: prefer public, then regular, then local
      const url = img.publicDesktop || img.desktop ||
                  img.publicMobile || img.mobile ||
                  img.desktopLocal || img.mobileLocal || '';
      return this.ensureHttps(url);
    })
    .filter(url => url !== '');
}
// FALLBACK: Handle old format (array of strings)
else if (Array.isArray(product?.smallImagesLocal)) {
  // ... existing code ...
}
// FALLBACK: Handle old/new format from API
else if (Array.isArray(product?.smallImages)) {
  // ... existing code ...
}
```

Also update the main image URL selection in generatePreview to use images[0]:
```javascript
// Get main image URL - prefer unified images array
const mainDesktopImage = this.ensureHttps(
  (Array.isArray(product?.images) && product.images[0]?.publicDesktop) ||
  (Array.isArray(product?.images) && product.images[0]?.desktop) ||
  clickedImageUrl ||
  getImageUrl(product?.mainImage, true) ||
  product?.image ||
  ''
);
```
  </action>
  <verify>
Click a product to open modal:
- Main image displays correctly
- Gallery thumbnails appear (if product has multiple images)
- Clicking thumbnails switches main image
- No console errors
  </verify>
  <done>
generatePreview updated to use images array for both main image and gallery. Product modal displays correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update addHandlerPreview gallery source</name>
  <files>frontend/js/Views/categoriesView.js</files>
  <action>
Update the addHandlerPreview method (around line 547) which also accesses smallImages.

Find this line:
```javascript
const smallImages = filtered.smallImages || [];
```

Update to prefer images array:
```javascript
// Prefer unified images array, fall back to smallImages
const smallImages = (Array.isArray(filtered.images) && filtered.images.length > 1)
  ? filtered.images.slice(1).map(img => {
      if (typeof img === 'string') return img;
      if (img && typeof img === 'object') {
        return img.publicDesktop || img.desktop || img.publicMobile || img.mobile || '';
      }
      return '';
    }).filter(Boolean)
  : (filtered.smallImages || []);
```

This ensures the hasMultipleImages check works correctly with the new format.

Note: The imageMarkup generation following this line maps over smallImages and expects URLs. The above code ensures we pass URLs whether from images array or old smallImages field.
  </action>
  <verify>
Products with multiple images:
- Modal shows gallery thumbnails
- hasMultipleImages correctly detects multiple images
- Gallery navigation works (prev/next buttons if present)
  </verify>
  <done>
addHandlerPreview updated to use images array for gallery. Multi-image products display gallery correctly.
  </done>
</task>

</tasks>

<verification>
Phase 7 Plan 04 complete when:
- [ ] Product list displays images from images array
- [ ] Product modal main image uses images[0]
- [ ] Product modal gallery uses images array
- [ ] Fallback to mainImage/smallImages works if images array missing
- [ ] No 404 errors for product images
- [ ] Gallery navigation works correctly
- [ ] No JavaScript console errors
</verification>

<success_criteria>
- Frontend correctly displays products using images array
- Fallback to old fields works (defensive programming)
- Product modal shows all images from unified array
- All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/07-image-array-migration/07-04-SUMMARY.md`
</output>
