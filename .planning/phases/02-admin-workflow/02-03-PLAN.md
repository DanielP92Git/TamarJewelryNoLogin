---
phase: 02-admin-workflow
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - admin/BisliView.js
autonomous: true

must_haves:
  truths:
    - "Admin sees SKU column in product listing table (second column after Product)"
    - "Admin can click SKU column header to sort products A-Z or Z-A by SKU"
    - "Admin can search products by typing SKU in the search field"
    - "Admin sees 'Missing SKU (N)' filter badge showing count of products without SKUs"
    - "Admin can click Missing SKU filter to show only products without SKUs"
    - "Admin can click SKU cell to edit inline and save on blur/Enter"
    - "Filter and sort state persists when navigating away and returning to product list"
  artifacts:
    - path: "admin/BisliView.js"
      provides: "SKU column, sorting, search, filter, inline editing"
      contains: "Missing SKU"
  key_links:
    - from: "admin/BisliView.js:loadProducts"
      to: "product.sku"
      via: "SKU column render"
      pattern: "item\\.sku"
    - from: "admin/BisliView.js:loadProducts"
      to: "sessionStorage"
      via: "filter state persistence"
      pattern: "sessionStorage\\.(get|set)Item"
---

<objective>
Add SKU column to product listing with sorting, search integration, missing SKU filter, and inline editing.

Purpose: Enables admin to view, sort, search, and quickly edit SKUs directly in the product listing table, with a quick filter to surface products needing SKU assignment.

Output: Product listing table with SKU column (sortable), extended search supporting SKU, "Missing SKU (N)" filter badge, and inline editing for quick SKU updates.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-workflow/02-01-SUMMARY.md

Key decisions from CONTEXT.md:
- SKU appears as second column in product listing table (after product name)
- Clickable column header to sort A-Z or Z-A by SKU
- Show dash (-) for products without SKUs
- Partial match search (contains) for SKU
- "Missing SKU (N)" filter badge that toggles filter when clicked
- Filter persistence via sessionStorage
- Single click on SKU cell makes it editable immediately
- Inline edit saves on blur or Enter, cancels on Escape

Existing patterns from BisliView.js:
- loadProductsPage() at line ~892 creates the product list page
- loadProducts() at line ~1174 renders the product rows
- Table header at line ~952: .listproduct-format-main
- Product row at line ~1261: .listproduct-format
- Search input at line ~913: #productSearch
- Category filter at line ~916: #categoryFilter
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SKU column to product listing table</name>
  <files>admin/BisliView.js</files>
  <action>
1. In loadProductsPage() function (around line 892), find the table header markup (line ~952) and add SKU column:

Update the `.listproduct-format-main` div to include SKU header as second column:

```javascript
          <div class="listproduct-format-main">
            <p>Select</p>
            <p>Product</p>
            <p class="sortable-header" data-column="sku" style="cursor:pointer;">
              SKU <span class="sort-indicator"></span>
            </p>
            <p class="hide-sm">Category</p>
            <p>Stock Qty</p>
            <p class="hide-sm">ILS</p>
            <p>Status</p>
            <p style="text-align:right;">Actions</p>
          </div>
```

2. In loadProducts() function (around line 1261), update the product row HTML to include SKU column after the product name column:

```javascript
    productElement.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:center;">
        <input type="checkbox" class="product-checkbox" data-product-id="${item.id}">
      </div>
      <div class="row__name">
        <!-- existing picture/name content -->
      </div>
      <div class="sku-cell mono" data-product-id="${item.id}" data-editable="true" style="cursor:pointer;" title="Click to edit">
        <span class="sku-display">${item.sku || '—'}</span>
        <input
          type="text"
          class="sku-inline-input input"
          value="${item.sku || ''}"
          maxlength="7"
          style="display:none; width:80px; text-transform:uppercase;"
        />
      </div>
      <div class="mono hide-sm">${item.category ?? ""}</div>
      <!-- rest of columns unchanged -->
    `;
```

3. Add sort state tracking at the top of loadProductsPage (or in the global state object):

```javascript
  // Sort state for product listing
  let skuSortState = { active: false, direction: 'asc' };
```

4. Add sort handler after the table markup is inserted:

```javascript
  // SKU column sorting
  const skuHeader = document.querySelector('.sortable-header[data-column="sku"]');
  if (skuHeader) {
    skuHeader.addEventListener('click', () => {
      if (skuSortState.active) {
        skuSortState.direction = skuSortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        skuSortState.active = true;
        skuSortState.direction = 'asc';
      }

      // Update sort indicator
      const indicator = skuHeader.querySelector('.sort-indicator');
      if (indicator) {
        indicator.textContent = skuSortState.direction === 'asc' ? ' ↑' : ' ↓';
      }

      // Save sort state to session
      sessionStorage.setItem('productListSort', JSON.stringify(skuSortState));

      // Re-render products with sorting
      loadProducts(data);
    });
  }
```

5. In loadProducts(), apply SKU sorting to filteredData before rendering:

```javascript
  // Apply SKU sorting if active
  const savedSort = sessionStorage.getItem('productListSort');
  if (savedSort) {
    try {
      const sortState = JSON.parse(savedSort);
      if (sortState.active) {
        filteredData = [...filteredData].sort((a, b) => {
          const aVal = a.sku || '';
          const bVal = b.sku || '';

          // Put empty SKUs at the end
          if (!aVal && bVal) return 1;
          if (aVal && !bVal) return -1;
          if (!aVal && !bVal) return 0;

          const comparison = aVal.localeCompare(bVal);
          return sortState.direction === 'asc' ? comparison : -comparison;
        });
      }
    } catch (e) {
      console.error('Failed to parse sort state:', e);
    }
  }
```
  </action>
  <verify>
Search for 'data-column="sku"' in loadProductsPage to confirm sortable header.
Search for 'sku-cell' in loadProducts to confirm SKU column in product rows.
Verify sorting logic uses sessionStorage for persistence.
  </verify>
  <done>
Product listing table shows SKU column with sortable header and inline edit capability.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend search and add Missing SKU filter</name>
  <files>admin/BisliView.js</files>
  <action>
1. In loadProducts() function, update the search filter logic (around line 1205-1211) to include SKU:

```javascript
  if (searchTerm) {
    filteredData = filteredData.filter((product) => {
      const name = (product.name || "").toLowerCase();
      const id = String(product.id ?? "").toLowerCase();
      const sku = (product.sku || "").toLowerCase(); // Add SKU search
      return name.includes(searchTerm) ||
             id.includes(searchTerm) ||
             sku.includes(searchTerm);
    });
  }
```

2. Update the search input placeholder in loadProductsPage() (line ~913):

```javascript
<input id="productSearch" class="input" type="text" placeholder="Search by product name, ID, SKU..." />
```

3. In the toolbar section of loadProductsPage() (around line 911-930), add the Missing SKU filter badge after the category filter:

```javascript
        <div class="control" style="min-width: 220px; flex: 0 0 auto;">
          <select id="categoryFilter" class="select">
            <!-- existing options -->
          </select>
        </div>
        <div class="control">
          <button type="button" id="missing-sku-filter" class="badge" style="cursor:pointer; transition: all 0.2s;">
            Missing SKU (<span id="missing-sku-count">0</span>)
          </button>
        </div>
        <div class="control" style="min-width: 180px; flex: 0 0 auto;">
          <div class="badge" id="resultsBadge">0 items</div>
        </div>
```

4. Add filter state tracking and handler in loadProductsPage():

```javascript
  // Missing SKU filter state
  let showMissingSku = false;

  // Restore filter state from session
  const savedFilters = sessionStorage.getItem('productListFilters');
  if (savedFilters) {
    try {
      const filters = JSON.parse(savedFilters);
      showMissingSku = filters.showMissingSku || false;
      if (showMissingSku) {
        const badge = document.getElementById('missing-sku-filter');
        if (badge) {
          badge.style.background = 'rgba(239, 68, 68, 0.2)';
          badge.style.color = '#ef4444';
          badge.style.borderColor = 'rgba(239, 68, 68, 0.4)';
        }
      }
    } catch (e) {
      console.error('Failed to restore filter state:', e);
    }
  }

  // Missing SKU filter click handler
  const missingSkuBtn = document.getElementById('missing-sku-filter');
  if (missingSkuBtn) {
    missingSkuBtn.addEventListener('click', () => {
      showMissingSku = !showMissingSku;

      // Update badge appearance
      if (showMissingSku) {
        missingSkuBtn.style.background = 'rgba(239, 68, 68, 0.2)';
        missingSkuBtn.style.color = '#ef4444';
        missingSkuBtn.style.borderColor = 'rgba(239, 68, 68, 0.4)';
      } else {
        missingSkuBtn.style.background = '';
        missingSkuBtn.style.color = '';
        missingSkuBtn.style.borderColor = '';
      }

      // Save filter state
      const currentFilters = {
        showMissingSku: showMissingSku,
        category: document.getElementById('categoryFilter')?.value || 'all',
        searchTerm: document.getElementById('productSearch')?.value || ''
      };
      sessionStorage.setItem('productListFilters', JSON.stringify(currentFilters));

      // Re-render
      loadProducts(data);
    });
  }
```

5. In loadProducts(), add missing SKU filter logic and update count (add after category filter, before search filter):

```javascript
  // Apply missing SKU filter
  const savedFilters = sessionStorage.getItem('productListFilters');
  let showMissingSku = false;
  if (savedFilters) {
    try {
      showMissingSku = JSON.parse(savedFilters).showMissingSku || false;
    } catch (e) {}
  }

  // Count missing SKUs (before filtering)
  const missingSkuCount = filteredData.filter(p => !p.sku || p.sku.trim() === '').length;
  const countSpan = document.getElementById('missing-sku-count');
  if (countSpan) {
    countSpan.textContent = missingSkuCount;
  }

  // Apply filter
  if (showMissingSku) {
    filteredData = filteredData.filter(product => !product.sku || product.sku.trim() === '');
  }
```

6. Save search and category filter state when they change:

```javascript
  // Update filter handlers to save state
  const search = document.getElementById("productSearch");
  if (search) {
    search.addEventListener("input", () => {
      const currentFilters = JSON.parse(sessionStorage.getItem('productListFilters') || '{}');
      currentFilters.searchTerm = search.value;
      sessionStorage.setItem('productListFilters', JSON.stringify(currentFilters));
      loadProducts(data);
      // ... existing handlers
    });
  }
```
  </action>
  <verify>
Search for 'sku.includes(searchTerm)' to confirm SKU added to search.
Search for 'missing-sku-filter' to confirm filter badge exists.
Search for 'productListFilters' to confirm sessionStorage persistence.
  </verify>
  <done>
Search includes SKU, Missing SKU filter badge shows count and toggles filter, filter state persists in sessionStorage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add inline SKU editing in product listing</name>
  <files>admin/BisliView.js</files>
  <action>
1. In loadProducts(), after rendering all product rows (after the forEach loop), bind inline edit handlers:

```javascript
  // Bind inline SKU edit handlers
  document.querySelectorAll('.sku-cell[data-editable="true"]').forEach(cell => {
    const display = cell.querySelector('.sku-display');
    const input = cell.querySelector('.sku-inline-input');
    const productId = cell.dataset.productId;

    if (!display || !input) return;

    // Click to edit
    display.addEventListener('click', (e) => {
      e.stopPropagation();
      display.style.display = 'none';
      input.style.display = 'block';
      input.focus();
      input.select();
    });

    // Auto-uppercase while typing
    input.addEventListener('input', (e) => {
      const start = e.target.selectionStart;
      const end = e.target.selectionEnd;
      e.target.value = e.target.value.toUpperCase();
      e.target.setSelectionRange(start, end);
    });

    // Save handler
    const saveSkuInline = async () => {
      const newSku = input.value.trim().toUpperCase();
      const originalSku = display.textContent === '—' ? '' : display.textContent;

      // No change - just close
      if (newSku === originalSku) {
        display.style.display = 'inline';
        input.style.display = 'none';
        return;
      }

      // Validate format
      if (newSku && (newSku.length < 2 || newSku.length > 7)) {
        alert('SKU must be 2-7 characters');
        input.focus();
        return;
      }
      if (newSku && !/^[A-Z0-9]+$/.test(newSku)) {
        alert('SKU must contain only letters and numbers');
        input.focus();
        return;
      }

      // Save via API
      try {
        input.disabled = true;
        const response = await fetch(`${API_URL}/updateproduct/${productId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('auth-token')}`
          },
          body: JSON.stringify({ sku: newSku || null })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          // Check for duplicate error
          if (result.error && result.error.includes('already used')) {
            alert(result.error);
          } else {
            alert(result.error || 'Failed to update SKU');
          }
          input.disabled = false;
          input.focus();
          return;
        }

        // Update display
        display.textContent = newSku || '—';
        display.style.display = 'inline';
        input.style.display = 'none';
        input.disabled = false;

        // Update count if SKU was added/removed
        const countSpan = document.getElementById('missing-sku-count');
        if (countSpan) {
          let count = parseInt(countSpan.textContent) || 0;
          if (!originalSku && newSku) count--; // Added SKU
          if (originalSku && !newSku) count++; // Removed SKU
          countSpan.textContent = Math.max(0, count);
        }

        // Update product in state
        const product = state.products?.find(p => p.id == productId);
        if (product) {
          product.sku = newSku || null;
        }

      } catch (error) {
        console.error('Inline SKU update failed:', error);
        alert('Failed to update SKU. Please try again.');
        input.disabled = false;
        input.focus();
      }
    };

    // Save on blur
    input.addEventListener('blur', () => {
      // Small delay to allow cancel via Escape
      setTimeout(() => {
        if (input.style.display !== 'none') {
          saveSkuInline();
        }
      }, 100);
    });

    // Save on Enter, cancel on Escape
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveSkuInline();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        input.value = display.textContent === '—' ? '' : display.textContent;
        display.style.display = 'inline';
        input.style.display = 'none';
      }
    });
  });
```

2. Prevent row click navigation when clicking SKU cell by stopping propagation (already handled with e.stopPropagation in the click handler above).

3. Style the inline input to match the table aesthetic - the input already has class="input" and inline styles for width and text-transform.
  </action>
  <verify>
Search for 'sku-inline-input' to confirm inline input exists in row template.
Search for 'saveSkuInline' to confirm save handler exists.
Verify handler updates /updateproduct/:id endpoint.
  </verify>
  <done>
Product listing SKU cells are editable inline with auto-save on blur/Enter and cancel on Escape.
  </done>
</task>

</tasks>

<verification>
1. Search for SKU column header with sortable class
2. Verify SKU appears in product row template
3. Confirm search filter includes `sku.includes(searchTerm)`
4. Find "Missing SKU" filter badge with count
5. Verify sessionStorage used for filter/sort persistence
6. Confirm inline edit handlers save via /updateproduct/:id
7. Verify Enter/Escape key handlers for inline editing
</verification>

<success_criteria>
- [ ] SKU column appears in product listing table header
- [ ] SKU column header is clickable and sorts products
- [ ] Sort indicator shows current direction (up/down arrow)
- [ ] Product rows show SKU value or dash for missing
- [ ] Search input finds products by SKU (partial match)
- [ ] "Missing SKU (N)" badge shows count of products without SKU
- [ ] Clicking Missing SKU badge toggles filter
- [ ] Filter badge changes appearance when active
- [ ] Filter/sort state persists in sessionStorage
- [ ] Clicking SKU cell shows inline input
- [ ] Inline input auto-uppercases text
- [ ] Enter saves inline SKU change
- [ ] Escape cancels inline edit
- [ ] Blur saves inline SKU change
- [ ] Invalid SKU format shows alert
- [ ] Duplicate SKU shows error from backend
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-workflow/02-03-SUMMARY.md`
</output>
