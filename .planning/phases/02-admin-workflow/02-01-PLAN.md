---
phase: 02-admin-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/index.js
autonomous: true

must_haves:
  truths:
    - "POST /check-sku-duplicate returns { duplicate: false } for unused SKUs"
    - "POST /check-sku-duplicate returns { duplicate: true, conflictingProduct: { id, name } } for existing SKUs"
    - "POST /check-sku-duplicate excludes specified product when excludeProductId provided"
    - "Endpoint requires authentication (returns 401 for unauthenticated requests)"
  artifacts:
    - path: "backend/index.js"
      provides: "SKU duplicate check endpoint"
      contains: "/check-sku-duplicate"
  key_links:
    - from: "backend/index.js:/check-sku-duplicate"
      to: "Product.findOne"
      via: "MongoDB query"
      pattern: "Product\\.findOne.*sku"
---

<objective>
Create backend API endpoint for client-side SKU duplicate validation.

Purpose: Enables real-time duplicate detection in admin forms before submission, providing actionable error messages with conflicting product details.

Output: POST /check-sku-duplicate endpoint that checks SKU uniqueness and returns conflicting product info if duplicate found.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-01-SUMMARY.md

Key backend patterns from Phase 01:
- SKU validation already implemented in /addproduct and /updateproduct routes
- Normalization: `String(sku).trim().toUpperCase()`
- Format validation: `/^[A-Z0-9]+$/`, length 2-7 chars
- Error format: `{ success: false, error: "message" }`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SKU duplicate check endpoint</name>
  <files>backend/index.js</files>
  <action>
Add a new POST endpoint `/check-sku-duplicate` after the existing product routes (around line 2200, after /updateproduct).

The endpoint should:
1. Require authentication using the existing `fetchUser` middleware (same as /addproduct)
2. Accept JSON body: `{ sku: string, excludeProductId?: string }`
3. Normalize the SKU: `String(sku).trim().toUpperCase()`
4. Validate format (2-7 chars, alphanumeric only) - return early with `{ duplicate: false }` for invalid SKUs (let form validation handle errors)
5. Query Product collection for existing SKU, excluding the specified product if `excludeProductId` provided:
   ```javascript
   const query = { sku: normalizedSku };
   if (excludeProductId) {
     query.id = { $ne: Number(excludeProductId) };
   }
   const existingProduct = await Product.findOne(query).select('id name');
   ```
6. Return response:
   - If no duplicate: `{ duplicate: false }`
   - If duplicate found: `{ duplicate: true, conflictingProduct: { id: existingProduct.id, name: existingProduct.name } }`

Error handling:
- 401 for unauthenticated requests (handled by fetchUser middleware)
- 500 for database errors with `{ success: false, error: 'Failed to check SKU' }`
  </action>
  <verify>
Search backend/index.js for "check-sku-duplicate" to confirm endpoint exists.
Verify endpoint uses fetchUser middleware and queries Product collection.
  </verify>
  <done>
POST /check-sku-duplicate endpoint exists and returns appropriate duplicate status with conflicting product details.
  </done>
</task>

</tasks>

<verification>
1. Grep for `/check-sku-duplicate` in backend/index.js to confirm endpoint added
2. Verify endpoint includes authentication middleware (fetchUser)
3. Verify endpoint handles excludeProductId parameter for edit mode
4. Confirm response format matches spec: `{ duplicate: boolean, conflictingProduct?: { id, name } }`
</verification>

<success_criteria>
- [ ] POST /check-sku-duplicate endpoint exists in backend/index.js
- [ ] Endpoint requires authentication via fetchUser middleware
- [ ] Endpoint normalizes SKU (uppercase, trim) before query
- [ ] Endpoint excludes current product when excludeProductId provided
- [ ] Returns { duplicate: false } for available SKUs
- [ ] Returns { duplicate: true, conflictingProduct: { id, name } } for taken SKUs
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-workflow/02-01-SUMMARY.md`
</output>
