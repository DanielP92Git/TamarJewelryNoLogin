---
phase: 02-admin-workflow
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - admin/BisliView.js
autonomous: true

must_haves:
  truths:
    - "Admin sees SKU input field on Add Product form with red asterisk indicating required"
    - "Admin sees SKU input field on Edit Product form pre-filled with existing value"
    - "SKU input auto-uppercases as admin types"
    - "Admin sees validation error when SKU format is invalid"
    - "Admin sees duplicate error with conflicting product name and link when SKU already exists"
    - "Form submission blocked when SKU validation fails"
    - "Edit form allows saving unchanged SKU without triggering duplicate error"
  artifacts:
    - path: "admin/BisliView.js"
      provides: "SKU form fields and validation"
      contains: "validateSkuField"
  key_links:
    - from: "admin/BisliView.js:validateSkuField"
      to: "/check-sku-duplicate"
      via: "fetch API call"
      pattern: "fetch.*check-sku-duplicate"
    - from: "admin/BisliView.js:loadAddProductsPage"
      to: "sku-input"
      via: "DOM form field"
      pattern: "id=\"sku-input\""
    - from: "admin/BisliView.js:editProduct"
      to: "sku-input"
      via: "DOM form field"
      pattern: "id=\"sku-input\""
---

<objective>
Add SKU input fields to Add Product and Edit Product forms with inline validation.

Purpose: Enables admin to enter SKU when creating new products (required) and update SKU on existing products (optional), with real-time duplicate detection showing actionable error messages.

Output: SKU fields in both forms with blur-based validation, auto-uppercase input, and duplicate error messages containing links to conflicting products.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-workflow/02-01-SUMMARY.md (created by Plan 01)

Key decisions from CONTEXT.md:
- SKU field appears at bottom of Add/Edit Product forms (after other fields)
- Required field for Add Product form with red asterisk (*)
- Auto-uppercase as admin types with cursor position preservation
- Blur-based validation with duplicate check via API
- Duplicate error shows conflicting product name with clickable link
- Edit form shows warning before saving when changing existing product's SKU
- Scroll to error and focus SKU field when validation fails on submit

Existing form patterns from BisliView.js:
- loadAddProductsPage() at line ~2988 creates Add Product form
- editProduct() at line ~1535 creates Edit Product form
- Forms use classes: .field, .label, .input, .help
- Form handlers use async click handlers with validation before API calls
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SKU validation function</name>
  <files>admin/BisliView.js</files>
  <action>
Add a reusable SKU validation function near the top of BisliView.js (after the state and API_URL declarations, around line 30-50).

```javascript
// SKU validation function for forms
async function validateSkuField(skuValue, excludeProductId = null) {
  const errorDiv = document.getElementById('sku-error');
  if (!errorDiv) return true;

  // Clear previous error
  errorDiv.style.display = 'none';
  errorDiv.innerHTML = '';
  errorDiv.removeAttribute('role');

  const trimmedSku = (skuValue || '').trim();

  // Empty check - let form submission handle required validation
  if (!trimmedSku) {
    return true;
  }

  const normalized = trimmedSku.toUpperCase();

  // Format validation
  if (normalized.length < 2 || normalized.length > 7) {
    errorDiv.innerHTML = 'SKU must be between 2 and 7 characters';
    errorDiv.style.display = 'block';
    errorDiv.setAttribute('role', 'alert');
    return false;
  }

  if (!/^[A-Z0-9]+$/.test(normalized)) {
    errorDiv.innerHTML = 'SKU must contain only letters and numbers (A-Z, 0-9)';
    errorDiv.style.display = 'block';
    errorDiv.setAttribute('role', 'alert');
    return false;
  }

  // Duplicate check via API
  try {
    const response = await fetch(`${API_URL}/check-sku-duplicate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('auth-token')}`
      },
      body: JSON.stringify({
        sku: normalized,
        excludeProductId: excludeProductId
      })
    });

    if (!response.ok) {
      console.error('SKU duplicate check failed:', response.status);
      return true; // Allow submission - backend will validate
    }

    const result = await response.json();

    if (result.duplicate) {
      const productName = result.conflictingProduct?.name || 'another product';
      const productId = result.conflictingProduct?.id;

      errorDiv.innerHTML = `SKU <strong>${normalized}</strong> is already used by <a href="#" class="sku-error-link" data-product-id="${productId}">${productName}</a> <span style="color: #3b82f6;">[View Product]</span>`;
      errorDiv.style.display = 'block';
      errorDiv.setAttribute('role', 'alert');

      // Bind click handler to navigate to conflicting product
      const errorLink = errorDiv.querySelector('.sku-error-link');
      if (errorLink && productId) {
        errorLink.addEventListener('click', async (e) => {
          e.preventDefault();
          // Find product in state.products and open edit
          const conflictingProduct = state.products?.find(p => p.id === productId);
          if (conflictingProduct) {
            editProduct(conflictingProduct);
          } else {
            alert('Could not find product. Please refresh the product list.');
          }
        });
      }

      return false;
    }

    return true;
  } catch (error) {
    console.error('SKU duplicate check error:', error);
    return true; // Allow submission - backend will validate
  }
}
```

Also add CSS for SKU error styling by finding the existing style section or adding inline styles where needed.
  </action>
  <verify>
Search for "validateSkuField" in BisliView.js to confirm function exists.
Verify function calls /check-sku-duplicate endpoint.
  </verify>
  <done>
validateSkuField function exists and performs format validation + API duplicate check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SKU field to Add Product form</name>
  <files>admin/BisliView.js</files>
  <action>
In loadAddProductsPage() function (around line 2988-3125), add SKU field to the form.

1. Find the Pricing card closing `</div>` (around line 3075) and add a new card BEFORE it (after the "apply-global-discount" checkbox field):

```javascript
          </div>
        </div>

        <!-- SKU Card - Add this new card -->
        <div class="card">
          <div class="card__header">
            <h3 class="card__title">Product Identifier</h3>
          </div>
          <div class="card__body">
            <div class="field">
              <div class="label">SKU <span style="color: #ef4444;">*</span></div>
              <input
                class="input"
                type="text"
                name="sku"
                id="sku-input"
                placeholder="ABC123"
                maxlength="7"
                style="text-transform: uppercase;"
              />
              <div class="help">Stock Keeping Unit - 2-7 alphanumeric characters (required for new products)</div>
              <div id="sku-error" style="display:none; color: #ef4444; font-size: 13px; margin-top: 6px;"></div>
            </div>
          </div>
        </div>
```

2. After form is inserted (after `pageContent.insertAdjacentHTML`), add event handlers for the SKU input:

```javascript
  // SKU input handlers
  const skuInput = document.getElementById('sku-input');
  if (skuInput) {
    // Auto-uppercase while preserving cursor position
    skuInput.addEventListener('input', (e) => {
      const start = e.target.selectionStart;
      const end = e.target.selectionEnd;
      e.target.value = e.target.value.toUpperCase();
      e.target.setSelectionRange(start, end);
    });

    // Validate on blur
    skuInput.addEventListener('blur', async () => {
      await validateSkuField(skuInput.value.trim(), null);
    });
  }
```

3. In the runSubmit function within addProductHandler() (around line 3241), add SKU validation BEFORE the existing validation:

```javascript
    // SKU validation (required for new products)
    const skuInput = document.getElementById('sku-input');
    const skuValue = skuInput?.value?.trim() || '';

    if (!skuValue) {
      const errorDiv = document.getElementById('sku-error');
      if (errorDiv) {
        errorDiv.innerHTML = 'SKU is required for new products';
        errorDiv.style.display = 'block';
        errorDiv.setAttribute('role', 'alert');
      }
      skuInput?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      skuInput?.focus();
      return;
    }

    const isSkuValid = await validateSkuField(skuValue, null);
    if (!isSkuValid) {
      skuInput?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      skuInput?.focus();
      return;
    }
```

4. In the data object being sent to addProduct (around line 3324), add SKU:

```javascript
    const data = {
      name: prodName,
      description: prodDescription,
      category: prodCategory,
      quantity: Number(quantity) || 0,
      ils_price: Math.round(parseFloat(prodIlsPrice)),
      sku: skuValue.toUpperCase(), // Add this line
      // ... rest of fields
    };
```
  </action>
  <verify>
Search for 'id="sku-input"' in loadAddProductsPage to confirm field added.
Search for 'sku:' in runSubmit data object to confirm SKU included in submission.
  </verify>
  <done>
Add Product form includes SKU field with required indicator, auto-uppercase, blur validation, and SKU included in form submission data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add SKU field to Edit Product form</name>
  <files>admin/BisliView.js</files>
  <action>
In editProduct() function (around line 1535-1934), add SKU field to the form.

1. Find the Organization card (Category/Quantity grid, around line 1772) and add a new card after the Pricing card (around line 1795):

```javascript
          </div>
        </div>

        <!-- SKU Card - Add after Pricing card -->
        <div class="card">
          <div class="card__header">
            <h3 class="card__title">Product Identifier</h3>
          </div>
          <div class="card__body">
            <div class="field">
              <div class="label">SKU</div>
              <input
                class="input"
                type="text"
                name="sku"
                id="sku-input"
                value="${product.sku || ''}"
                placeholder="${product.sku ? '' : 'ABC123'}"
                maxlength="7"
                style="text-transform: uppercase;"
              />
              <div class="help">${product.sku ? 'Current SKU - editing will update the product identifier' : 'No SKU assigned - enter one to add a product identifier'}</div>
              <div id="sku-error" style="display:none; color: #ef4444; font-size: 13px; margin-top: 6px;"></div>
            </div>
          </div>
        </div>
```

2. Store original SKU for change detection (add after form insertion):

```javascript
  // Store original SKU for change detection
  const originalSku = product.sku || '';
```

3. Add SKU input handlers after form insertion (similar to Add Product):

```javascript
  // SKU input handlers for edit form
  const skuInput = document.getElementById('sku-input');
  if (skuInput) {
    // Auto-uppercase while preserving cursor position
    skuInput.addEventListener('input', (e) => {
      const start = e.target.selectionStart;
      const end = e.target.selectionEnd;
      e.target.value = e.target.value.toUpperCase();
      e.target.setSelectionRange(start, end);
    });

    // Validate on blur (exclude current product from duplicate check)
    skuInput.addEventListener('blur', async () => {
      await validateSkuField(skuInput.value.trim(), product.id);
    });
  }
```

4. In the edit form submit handler (find where Save Changes button handler is bound, around line 1968+), add SKU validation and change warning:

```javascript
    // SKU validation
    const skuInput = document.getElementById('sku-input');
    const newSkuValue = skuInput?.value?.trim().toUpperCase() || '';

    // Validate if SKU is provided
    if (newSkuValue) {
      const isSkuValid = await validateSkuField(newSkuValue, product.id);
      if (!isSkuValid) {
        skuInput?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        skuInput?.focus();
        return;
      }
    }

    // Warn if SKU is being changed (not just added to empty)
    if (originalSku && newSkuValue !== originalSku) {
      const confirmed = confirm(`You are changing the SKU from "${originalSku}" to "${newSkuValue}". This may affect inventory tracking. Continue?`);
      if (!confirmed) {
        return;
      }
    }
```

5. Include SKU in the update data being sent to /updateproduct (find where formData or update object is built):

```javascript
    // Add SKU to update data
    if (newSkuValue !== originalSku) {
      updateData.sku = newSkuValue || null; // null to remove SKU if emptied
    }
```

Note: The exact location depends on how the edit form currently submits - look for where it builds the request body for /updateproduct/:id.
  </action>
  <verify>
Search for 'id="sku-input"' in editProduct to confirm field added.
Verify originalSku is stored for change detection.
Verify SKU change warning uses confirm() dialog.
  </verify>
  <done>
Edit Product form includes SKU field pre-filled with existing value, blur validation with product exclusion, change warning for existing SKUs, and SKU update included in submission.
  </done>
</task>

</tasks>

<verification>
1. Search for `validateSkuField` function definition
2. Search for `id="sku-input"` in both loadAddProductsPage and editProduct functions
3. Verify Add Product form requires SKU (red asterisk indicator)
4. Verify Edit Product form pre-fills existing SKU value
5. Confirm SKU input has auto-uppercase handler with cursor position preservation
6. Confirm blur validation calls /check-sku-duplicate endpoint
7. Verify form submission includes SKU in request data
</verification>

<success_criteria>
- [ ] validateSkuField function exists and handles format + duplicate validation
- [ ] Add Product form has SKU field with required indicator (red asterisk)
- [ ] Edit Product form has SKU field pre-filled with product.sku value
- [ ] SKU input auto-uppercases text while preserving cursor position
- [ ] Blur validation shows format errors (length, alphanumeric)
- [ ] Blur validation shows duplicate errors with conflicting product link
- [ ] Add Product form submission includes sku field
- [ ] Edit Product form submission includes sku when changed
- [ ] Edit form shows confirmation when changing existing SKU
- [ ] Validation errors scroll to and focus SKU field
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-workflow/02-02-SUMMARY.md`
</output>
