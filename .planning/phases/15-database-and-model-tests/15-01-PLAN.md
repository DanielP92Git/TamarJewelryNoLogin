---
phase: 15-database-and-model-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/models/product.test.js
autonomous: true

must_haves:
  truths:
    - "Product model creates documents with valid data and auto-assigns displayOrder via pre-save hook"
    - "Product model rejects documents missing required fields (name, category, id)"
    - "Product model enforces SKU uniqueness for non-null values and allows multiple null SKUs (sparse index)"
    - "Product model validates SKU format (uppercase alphanumeric, 2-7 chars) and auto-transforms to uppercase"
    - "Product model validates displayOrder minimum value of 1"
    - "Product model finds products by category and sorts by displayOrder"
    - "Product model performs CRUD operations (create, read, update, delete) correctly"
  artifacts:
    - path: "backend/tests/models/product.test.js"
      provides: "Product model tests covering DATA-01 through DATA-09"
      min_lines: 150
  key_links:
    - from: "backend/tests/models/product.test.js"
      to: "backend/models/Product.js"
      via: "Direct Mongoose model import and CRUD operations"
      pattern: "require.*models/Product|import.*Product"
---

<objective>
Write comprehensive Product model tests covering validation, uniqueness constraints, CRUD operations, and sorting behavior.

Purpose: Verify the Product Mongoose model enforces required fields, SKU uniqueness with sparse index, displayOrder auto-assignment, and category-based sorting. Covers DATA-01 (create with valid data), DATA-02 (validate required fields), DATA-03 (SKU uniqueness), DATA-04 (price validation - test actual schema behavior), DATA-05 (category validation - test actual schema behavior), DATA-06 (update operations), DATA-07 (delete operations), DATA-08 (find by category), DATA-09 (sort by displayOrder).

Output: `backend/tests/models/product.test.js` test file
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-database-and-model-tests/15-CONTEXT.md
@.planning/phases/15-database-and-model-tests/15-RESEARCH.md

Key backend references:
@backend/models/Product.js
@backend/tests/setup.js
@backend/tests/helpers/factories.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Product model validation and uniqueness tests</name>
  <files>backend/tests/models/product.test.js</files>
  <action>
Create `backend/tests/models/product.test.js` with direct Mongoose model tests. Do NOT test through HTTP endpoints - import and test the Product model directly.

Import pattern:
```javascript
import { describe, it, expect, beforeEach } from 'vitest';
import mongoose from 'mongoose';
```

Import the Product model using dynamic import (it uses CommonJS):
```javascript
let Product;
beforeAll(async () => {
  Product = (await import('../../models/Product.js')).default;
});
```

**Test groups to implement:**

1. **Product Creation - Valid Data (DATA-01):**
   - `should create a product with all required fields` - Create with `{ id: 1001, name: 'Test Ring', category: 'rings', usd_price: 100, ils_price: 370, images: [{ desktop: 'ring-d.webp', mobile: 'ring-m.webp' }] }`. Verify all fields saved correctly, `_id` is defined, `available` defaults to `true`, `quantity` defaults to 0, `discount_percentage` defaults to 0.
   - `should auto-assign displayOrder via pre-save hook for new products` - Create a product in category 'necklaces' without specifying displayOrder. Verify `displayOrder` is set to 10 (first product). Create a second product in same category without displayOrder. Verify its displayOrder is 20 (10 + 10 gap).
   - `should auto-transform SKU to uppercase` - Create product with `sku: 'abc123'`. Verify saved sku is `'ABC123'`.
   - `should auto-trim SKU whitespace` - Create product with `sku: '  ABC  '`. Verify saved sku is `'ABC'`.
   - `should create product without optional fields (SKU, description, images)` - Create with only required fields (id, name, category). Verify product saved, sku is undefined/null.

2. **Product Validation - Required Fields (DATA-02):**
   - `should reject product without name` - Try `Product.create({ id: 1, category: 'rings' })`. Expect rejection (Mongoose ValidationError).
   - `should reject product without category` - Try `Product.create({ id: 1, name: 'Ring' })`. Expect rejection.
   - `should reject product without id` - Try `Product.create({ name: 'Ring', category: 'rings' })`. Expect rejection.

3. **SKU Uniqueness - Sparse Index (DATA-03):**
   - `should reject duplicate SKU` - Create product with sku 'ABC123', try creating second product with same sku. Expect duplicate key error (MongoDB error code 11000 or Mongoose error).
   - `should allow multiple products without SKU (sparse index)` - Create two products with no sku field. Verify both saved successfully.
   - `should allow multiple products with null SKU` - Create two products with `sku: null`. Verify both saved. Important: Use `await Product.create(...)` for each, verify count is 2.
   - `should reject duplicate SKU in race condition` - Use `Promise.allSettled()` with 3 concurrent creates of same SKU. Verify only 1 succeeded and final DB count for that SKU is 1.

4. **SKU Format Validation:**
   - `should reject SKU shorter than 2 characters` - Try sku 'A'. Expect validation error with minLength message.
   - `should reject SKU longer than 7 characters` - Try sku 'ABCDEFGH' (8 chars). Expect validation error with maxLength message.
   - `should reject SKU with special characters` - Try sku 'AB-CD'. Expect validation error (only alphanumeric allowed).
   - `should accept valid SKU at boundaries` - Try sku 'AB' (2 chars) and 'ABCDEFG' (7 chars). Both should save.

5. **Price Behavior (DATA-04):**
   Note: The Product schema has NO min/max price validators. Test actual behavior:
   - `should save product with valid prices` - Create with usd_price: 100, ils_price: 370. Verify saved correctly.
   - `should accept zero price` - Create with usd_price: 0. Verify saves (no min validator).
   - `should accept negative price (no validator in schema)` - Create with usd_price: -50. Verify it saves (documenting actual schema behavior - no price validation exists).

6. **Category Behavior (DATA-05):**
   Note: The Product schema has NO enum constraint on category. Test actual behavior:
   - `should save product with any category string` - Create with category: 'custom-category'. Verify saves.
   - `should reject product with empty string category` - If Mongoose treats empty string as missing required field, expect rejection. Otherwise document actual behavior.

7. **DisplayOrder Validation:**
   - `should reject displayOrder of 0 (min: 1)` - Create product with displayOrder: 0. Expect validation error.
   - `should reject negative displayOrder` - Create product with displayOrder: -5. Expect validation error.
   - `should accept displayOrder of 1 (boundary)` - Create with displayOrder: 1. Verify saves.

**Important implementation notes:**
- Use `.save()` method (not `.create()`) for pre-save hook testing so hooks fire properly.
- For uniqueness tests, use `try/catch` or `.rejects.toThrow()` - MongoDB duplicate key errors throw with code 11000.
- The global afterEach in setup.js clears all collections, so each test starts fresh.
- Use the `createProduct` factory from `factories.js` for convenience, with overrides for specific fields.
- The `id` field is a required Number (not MongoDB `_id`). It must be unique per product but has no unique index declared.
  </action>
  <verify>
Run: `cd backend && npx vitest run tests/models/product.test.js --reporter=verbose`

Expected: All tests pass. Minimum 20 tests covering:
- 5 creation/defaults tests (DATA-01)
- 3 required field rejection tests (DATA-02)
- 4 SKU uniqueness tests (DATA-03)
- 4 SKU format tests
- 3 price behavior tests (DATA-04)
- 2 category behavior tests (DATA-05)
- 3 displayOrder validation tests
  </verify>
  <done>Product validation and uniqueness tests pass with 20+ tests covering DATA-01 through DATA-05, including SKU sparse index, format validation, pre-save hook auto-assignment, and actual schema behavior documentation for fields without validators.</done>
</task>

<task type="auto">
  <name>Task 2: Add Product model CRUD and sorting tests</name>
  <files>backend/tests/models/product.test.js</files>
  <action>
Add CRUD operation and sorting test groups to the existing `backend/tests/models/product.test.js` file.

**Additional test groups to add:**

8. **Update Operations (DATA-06):**
   - `should update product name` - Create product, update name with `Product.findByIdAndUpdate()`, verify change persisted.
   - `should update product price` - Create product, update usd_price, verify change persisted.
   - `should update product with $set operator` - Use `Product.updateOne({ _id }, { $set: { description: 'Updated' } })`. Verify change.
   - `should not overwrite unspecified fields on update` - Update only name, verify other fields (price, category, sku) remain unchanged.

9. **Delete Operations (DATA-07):**
   - `should delete product by ID` - Create product, `Product.deleteOne({ _id })`, verify `findById` returns null.
   - `should delete product by custom id field` - Create product with id: 5001, `Product.deleteOne({ id: 5001 })`, verify deletion.
   - `should return deletedCount 0 for non-existent product` - `Product.deleteOne({ _id: new mongoose.Types.ObjectId() })`, verify result.deletedCount is 0.

10. **Find by Category (DATA-08):**
    - `should find products by category` - Create 3 products (2 in 'rings', 1 in 'necklaces'). `Product.find({ category: 'rings' })`. Verify length is 2.
    - `should return empty array for non-existent category` - `Product.find({ category: 'nonexistent' })`. Verify length is 0.
    - `should find products by category and availability` - Create 3 products in 'rings' (2 available, 1 not). `Product.find({ category: 'rings', available: true })`. Verify length is 2.

11. **Sort by DisplayOrder (DATA-09):**
    - `should sort products by displayOrder ascending` - Create 3 products with displayOrder 30, 10, 20. `Product.find().sort({ displayOrder: 1 })`. Verify order is 10, 20, 30.
    - `should sort products within category by displayOrder` - Create products across 2 categories with mixed displayOrder values. Find by category, sort by displayOrder, verify correct order within that category.
    - `should handle products with same displayOrder` - Create 2 products with same displayOrder. Verify both returned (no error), order is consistent (though not guaranteed which comes first).
    - `should sort with null displayOrder values` - Create products with null and non-null displayOrder. Verify null values sort separately (MongoDB behavior: nulls sort before non-null in ascending).

Run the complete test file after adding these tests.
  </action>
  <verify>
Run: `cd backend && npx vitest run tests/models/product.test.js --reporter=verbose`

Expected: All tests pass. Total should be 30+ tests covering:
- Previous 20+ tests (validation, uniqueness)
- 4 update tests (DATA-06)
- 3 delete tests (DATA-07)
- 3 find-by-category tests (DATA-08)
- 4 sort-by-displayOrder tests (DATA-09)

Also run full suite to check no regressions:
`cd backend && npx vitest run --reporter=verbose`
  </verify>
  <done>Product model test file has 30+ passing tests covering all DATA-01 through DATA-09 requirements. CRUD operations, category filtering, and displayOrder sorting verified. All existing tests remain passing.</done>
</task>

</tasks>

<verification>
1. Run full test suite: `cd backend && npx vitest run --reporter=verbose`
2. Confirm all existing tests still pass (no regressions from 296 test baseline)
3. Confirm product.test.js has 30+ passing tests
4. Verify Product model coverage: creation, validation, uniqueness, CRUD, sorting
5. Verify tests use in-memory MongoDB only (no production database access)
</verification>

<success_criteria>
- product.test.js exists in backend/tests/models/ directory
- 30+ tests pass covering DATA-01 through DATA-09
- Product creation with valid data succeeds with correct defaults
- Required field validation (name, category, id) rejects missing fields
- SKU uniqueness enforced for non-null values, multiple nulls allowed (sparse)
- SKU format validated (uppercase, alphanumeric, 2-7 chars, auto-transform)
- DisplayOrder pre-save hook auto-assigns incrementing values
- DisplayOrder minimum (1) enforced
- CRUD operations work correctly (create, findById, update, delete)
- Category filtering returns correct products
- DisplayOrder sorting returns products in correct order
- All existing 296 tests remain passing
</success_criteria>

<output>
After completion, create `.planning/phases/15-database-and-model-tests/15-01-SUMMARY.md`
</output>
