---
phase: 18-model-unit-tests
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - frontend/tests/model/localStorage.test.js
autonomous: true

must_haves:
  truths:
    - "Cart data persists to localStorage on every change"
    - "Cart data loads from localStorage on page reload"
    - "Cart survives browser restart (clear cart array, reload from localStorage)"
    - "Malformed localStorage data doesn't crash cart"
    - "Missing required fields are handled gracefully"
  artifacts:
    - path: "frontend/tests/model/localStorage.test.js"
      provides: "localStorage persistence and corruption handling tests"
      min_lines: 80
  key_links:
    - from: "frontend/tests/model/localStorage.test.js"
      to: "frontend/js/model.js"
      via: "import cart, handleLoadStorage, handleAddToCart"
      pattern: "import.*from.*model\\.js"
    - from: "frontend/tests/model/localStorage.test.js"
      to: "localStorage"
      via: "direct localStorage manipulation for corruption tests"
      pattern: "localStorage\\.setItem"
---

<objective>
Create localStorage persistence tests covering data survival, browser restart simulation, and corruption handling.

Purpose: Validate that cart data persists correctly to localStorage, survives page reloads and browser restarts, and handles corrupted/malformed data gracefully without crashing.

Output: Comprehensive localStorage.test.js with tests for MODEL-05 through MODEL-07 and MODEL-14.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-model-unit-tests/18-CONTEXT.md
@.planning/phases/18-model-unit-tests/18-RESEARCH.md
@.planning/phases/18-model-unit-tests/18-01-SUMMARY.md
@frontend/js/model.js
@frontend/tests/helpers/factories.js
@frontend/tests/helpers/mocks/dom-elements.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create localStorage persistence tests</name>
  <files>frontend/tests/model/localStorage.test.js</files>
  <action>
Create comprehensive localStorage persistence tests covering MODEL-05 through MODEL-07 and MODEL-14:

**Test structure:**

a) `describe('localStorage Persistence on Change')` (MODEL-05)
   - Should persist cart to localStorage after adding item
   - Should update localStorage after removing item
   - Should update localStorage after clearing cart
   - Verify localStorage.getItem('cart') matches cart array state

b) `describe('Loading from localStorage')` (MODEL-06)
   - Should load cart from localStorage when no auth-token
   - Should restore correct item properties (id, title, price, amount)
   - Should handle empty cart in localStorage
   - Should handle missing 'cart' key in localStorage

c) `describe('Browser Restart Simulation')` (MODEL-07)
   - Pattern from research:
   ```javascript
   it('should survive browser restart', async () => {
     // 1. Add item to cart
     const product = createProduct({ id: 1001 });
     const mockElement = createMockProductElement(product);
     handleAddToCart(mockElement);
     expect(cart).toHaveLength(1);

     // 2. Simulate browser restart: clear cart array, keep localStorage
     cart.length = 0;
     expect(cart).toHaveLength(0);

     // 3. Reload from localStorage
     await handleLoadStorage();

     // 4. Verify cart restored
     expect(cart).toHaveLength(1);
     expect(cart[0].id).toBe(1001);
   });
   ```
   - Test multiple items survive restart
   - Verify all properties restored correctly

d) `describe('localStorage Corruption Handling')` (MODEL-14)
   - Should handle malformed JSON gracefully (invalid syntax)
   - Should handle null value gracefully
   - Should handle empty string gracefully
   - Should handle non-array values gracefully (object instead of array)
   - Should handle array with null/undefined items
   - Should handle items with missing required fields (id, title, price)
   - Should handle type mismatches (price as string, quantity as float)

   Pattern from research:
   ```javascript
   it('should handle malformed JSON gracefully', async () => {
     localStorage.setItem('cart', 'not valid json{{{');

     await expect(handleLoadStorage()).resolves.not.toThrow();
     expect(cart).toHaveLength(0);  // Falls back to empty cart
   });
   ```

e) `describe('localStorage Quota Handling')` (optional, if time permits)
   - Test that quota exceeded error doesn't crash app
   - Mock localStorage.setItem to throw DOMException
   - Verify cart state still usable after quota error

**Setup pattern:**
```javascript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { cart, handleAddToCart, handleLoadStorage } from '../../js/model.js';
import { createProduct, resetFactoryCounter } from '../helpers/factories.js';
import { createMockProductElement } from '../helpers/mocks/dom-elements.js';

beforeEach(() => {
  cart.length = 0;
  localStorage.clear();
  resetFactoryCounter();
});
```

Target: At least 12 tests covering persistence, reload, restart simulation, and corruption scenarios.
  </action>
  <verify>Run `npm test -- --run tests/model/localStorage.test.js` from frontend directory - all tests pass</verify>
  <done>localStorage persistence tests validate survival across reloads and handle corruption gracefully (MODEL-05, MODEL-06, MODEL-07, MODEL-14)</done>
</task>

</tasks>

<verification>
1. localStorage.test.js exists at frontend/tests/model/localStorage.test.js
2. `npm test -- --run tests/model/localStorage.test.js` passes all tests
3. Browser restart simulation test pattern correctly implemented
4. All corruption scenarios tested (malformed JSON, null, empty string, invalid items)
5. Tests don't leak state between runs (cart cleared in beforeEach)
</verification>

<success_criteria>
- localStorage persistence tests pass for add/remove/clear operations
- Browser restart simulation verifies cart survives clear + reload
- Corruption handling tests cover malformed JSON, null, empty, invalid items
- No test crashes or unhandled exceptions
- Requirements MODEL-05, MODEL-06, MODEL-07, MODEL-14 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/18-model-unit-tests/18-02-SUMMARY.md`
</output>
