---
phase: 18-model-unit-tests
plan: 03
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - frontend/tests/model/api.test.js
autonomous: true

must_haves:
  truths:
    - "API calls are mocked with vi.fn()"
    - "Product fetch API calls return mocked data"
    - "Order creation API calls are properly mocked"
    - "API network failures are handled gracefully"
    - "API 4xx/5xx error responses are handled gracefully"
  artifacts:
    - path: "frontend/tests/model/api.test.js"
      provides: "API mocking and error handling tests"
      min_lines: 80
  key_links:
    - from: "frontend/tests/model/api.test.js"
      to: "frontend/js/model.js"
      via: "import functions that call fetch"
      pattern: "import.*from.*model\\.js"
    - from: "frontend/tests/model/api.test.js"
      to: "frontend/tests/helpers/mocks/fetch.js"
      via: "fetch mock utilities"
      pattern: "import.*from.*fetch\\.js"
---

<objective>
Create API mocking and error handling tests covering fetch mocking patterns, network failures, and HTTP error responses.

Purpose: Validate that API interactions work correctly with mocked responses and that the model handles network failures and error responses gracefully without crashing.

Output: Comprehensive api.test.js with tests for MODEL-08 through MODEL-10, MODEL-15, and MODEL-16.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-model-unit-tests/18-CONTEXT.md
@.planning/phases/18-model-unit-tests/18-RESEARCH.md
@.planning/phases/18-model-unit-tests/18-01-SUMMARY.md
@frontend/js/model.js
@frontend/tests/helpers/factories.js
@frontend/tests/helpers/mocks/fetch.js
@frontend/tests/helpers/mocks/dom-elements.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API mocking and error handling tests</name>
  <files>frontend/tests/model/api.test.js</files>
  <action>
Create comprehensive API mocking and error handling tests covering MODEL-08 through MODEL-10, MODEL-15, and MODEL-16:

**Test structure:**

a) `describe('API Mocking Setup')` (MODEL-08)
   - Verify fetch can be mocked with vi.fn()
   - Verify mock captures call arguments (endpoint, method, headers, body)
   - Verify mock can return different responses per call

b) `describe('Cart API - Logged-in User')` (MODEL-09, MODEL-10)
   All tests in this block need:
   ```javascript
   beforeEach(() => {
     localStorage.setItem('auth-token', 'mock-jwt-token');
     setupFetchMock();
   });
   afterEach(() => {
     teardownFetchMock();
   });
   ```

   - Should call /addtocart with correct endpoint, method, headers
   - Should include auth-token in request headers
   - Should include itemId in request body as JSON
   - Should call /removefromcart with correct endpoint and itemId
   - Should call /removeAll for cart clear
   - Should call /getcart for loading user cart

c) `describe('API Network Failures')` (MODEL-15)
   - Should handle TypeError('Failed to fetch') gracefully
   - Should not throw when network request fails
   - Should log error to console (spy on console.error)
   - Cart state should remain consistent after network failure

   Pattern:
   ```javascript
   it('should handle network error gracefully', async () => {
     localStorage.setItem('auth-token', 'mock-jwt-token');
     mockFetchNetworkError();

     const product = createProduct();
     const mockElement = createMockProductElement(product);

     // Should not throw
     expect(() => handleAddToCart(mockElement)).not.toThrow();
   });
   ```

d) `describe('API HTTP Error Responses')` (MODEL-16)
   - Should handle 400 Bad Request gracefully
   - Should handle 401 Unauthorized gracefully
   - Should handle 404 Not Found gracefully
   - Should handle 500 Internal Server Error gracefully
   - Should not throw on any HTTP error status
   - Cart state should remain usable after API error

   Pattern:
   ```javascript
   it('should handle 401 error gracefully', async () => {
     localStorage.setItem('auth-token', 'mock-jwt-token');
     mockFetchError(401, 'Unauthorized');

     const product = createProduct();
     const mockElement = createMockProductElement(product);

     expect(() => handleAddToCart(mockElement)).not.toThrow();
   });
   ```

e) `describe('Discount Settings API')` (bonus - tests getGlobalDiscount)
   - Should call /discount-settings endpoint
   - Should cache response for 5 minutes
   - Should return default values when API fails
   - Should handle malformed response gracefully

**Setup pattern:**
```javascript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { cart, handleAddToCart, removeFromUserCart, deleteAll, getGlobalDiscount } from '../../js/model.js';
import { createProduct, resetFactoryCounter } from '../helpers/factories.js';
import { createMockProductElement } from '../helpers/mocks/dom-elements.js';
import { setupFetchMock, teardownFetchMock, mockFetchSuccess, mockFetchError, mockFetchNetworkError } from '../helpers/mocks/fetch.js';

beforeEach(() => {
  cart.length = 0;
  localStorage.clear();
  resetFactoryCounter();
});
```

Target: At least 12 tests covering API mocking, network failures, and HTTP error responses.
  </action>
  <verify>Run `npm test -- --run tests/model/api.test.js` from frontend directory - all tests pass</verify>
  <done>API mocking and error handling tests validate proper mocking patterns and graceful error handling (MODEL-08, MODEL-09, MODEL-10, MODEL-15, MODEL-16)</done>
</task>

</tasks>

<verification>
1. api.test.js exists at frontend/tests/model/api.test.js
2. `npm test -- --run tests/model/api.test.js` passes all tests
3. Fetch mock properly captures API call arguments
4. Network error tests verify no uncaught exceptions
5. HTTP error tests cover 4xx and 5xx status codes
6. Tests properly restore original fetch in afterEach
</verification>

<success_criteria>
- API mocking tests verify correct endpoint/method/headers/body
- Network failure tests verify graceful handling without crashes
- HTTP error tests verify handling of 4xx and 5xx responses
- All tests clean up fetch mock properly
- Requirements MODEL-08, MODEL-09, MODEL-10, MODEL-15, MODEL-16 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/18-model-unit-tests/18-03-SUMMARY.md`
</output>
