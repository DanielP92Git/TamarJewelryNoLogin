---
phase: 18-model-unit-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tests/model/currency.test.js
autonomous: true

must_haves:
  truths:
    - "Currency conversion USD to ILS uses correct exchange rate"
    - "Currency conversion ILS to USD uses correct exchange rate"
    - "Currency conversion handles floating-point precision with toBeCloseTo()"
    - "Discount calculation produces correct results"
  artifacts:
    - path: "frontend/tests/model/currency.test.js"
      provides: "Currency conversion and discount calculation tests"
      min_lines: 40
  key_links:
    - from: "frontend/tests/model/currency.test.js"
      to: "frontend/js/model.js"
      via: "import calculateDiscountedPrice"
      pattern: "import.*calculateDiscountedPrice.*from.*model\\.js"
---

<objective>
Create currency conversion and discount calculation tests covering floating-point precision and edge cases.

Purpose: Validate that price calculations are accurate within floating-point tolerance and that discount calculations work correctly. Note: The model.js stores both USD and ILS prices but does NOT perform currency conversion - that's a View concern. Focus on testing calculateDiscountedPrice and verifying dual-price storage.

Output: Comprehensive currency.test.js with tests for MODEL-11 through MODEL-13.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-model-unit-tests/18-CONTEXT.md
@.planning/phases/18-model-unit-tests/18-RESEARCH.md
@frontend/js/model.js
@frontend/tests/helpers/factories.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create currency and discount calculation tests</name>
  <files>frontend/tests/model/currency.test.js</files>
  <action>
Create comprehensive currency and discount calculation tests covering MODEL-11 through MODEL-13:

**Important context from research:**
The model.js file stores both `usdPrice` and `ilsPrice` on cart items but does NOT perform currency conversion - that's handled by the View layer. The only calculation function in model.js is `calculateDiscountedPrice(originalPrice, discountPercent)`.

**Test structure:**

a) `describe('Dual Currency Storage')` (MODEL-11, MODEL-12)
   - Verify cart items store both usdPrice and ilsPrice
   - Verify both prices are preserved through add/load cycle
   - Test with various price combinations

   Pattern:
   ```javascript
   it('should store both USD and ILS prices on cart item', () => {
     const product = createProduct({ usd_price: 50, ils_price: 185 });
     const mockElement = createMockProductElement(product);

     handleAddToCart(mockElement);

     expect(cart[0].usdPrice).toBe(50);
     expect(cart[0].ilsPrice).toBe(185);
   });
   ```

b) `describe('calculateDiscountedPrice')` (MODEL-13 - precision testing)
   - Should calculate correct discounted price for various percentages
   - Should return original price when discount is 0/null/undefined
   - Should handle negative discount (return original)
   - Should handle 100% discount (return 0)
   - Should use Math.round for integer results (verify with toBeCloseTo)

   Pattern from research:
   ```javascript
   it('should calculate correct discounted price', () => {
     expect(calculateDiscountedPrice(100, 10)).toBe(90);   // 10% off
     expect(calculateDiscountedPrice(100, 25)).toBe(75);   // 25% off
     expect(calculateDiscountedPrice(200, 50)).toBe(100);  // 50% off
   });

   it('should handle floating-point precision', () => {
     // 33.33% of 100 = 66.67 -> rounded to 67
     expect(calculateDiscountedPrice(100, 33.33)).toBeCloseTo(67, 0);
   });

   it('should return original when no discount', () => {
     expect(calculateDiscountedPrice(100, 0)).toBe(100);
     expect(calculateDiscountedPrice(100, null)).toBe(100);
     expect(calculateDiscountedPrice(100, undefined)).toBe(100);
   });
   ```

c) `describe('Price Edge Cases')` (MODEL-13 edge cases)
   - Zero price with discount
   - Very large amounts (100,000+) with discount
   - Fractional percentages (2.5%, 7.5%)
   - Verify precision maintained with toBeCloseTo(value, 2)

   Pattern:
   ```javascript
   it('should handle zero price', () => {
     expect(calculateDiscountedPrice(0, 10)).toBe(0);
   });

   it('should handle very large amounts', () => {
     // 100,000 with 15% discount = 85,000
     expect(calculateDiscountedPrice(100000, 15)).toBe(85000);
   });

   it('should handle fractional percentages', () => {
     expect(calculateDiscountedPrice(100, 2.5)).toBeCloseTo(98, 0);
   });
   ```

**Setup pattern:**
```javascript
import { describe, it, expect, beforeEach } from 'vitest';
import { cart, handleAddToCart, calculateDiscountedPrice } from '../../js/model.js';
import { createProduct, resetFactoryCounter } from '../helpers/factories.js';
import { createMockProductElement } from '../helpers/mocks/dom-elements.js';

beforeEach(() => {
  cart.length = 0;
  localStorage.clear();
  resetFactoryCounter();
});
```

Note: This plan can run in Wave 1 (parallel with Plan 01) because the only helper it needs is createMockProductElement, which can be created in this plan if Plan 01 hasn't run yet. However, to avoid duplication, if Plan 01 runs first, import from there.

Target: At least 10 tests covering dual currency storage, discount calculations, and edge cases.
  </action>
  <verify>Run `npm test -- --run tests/model/currency.test.js` from frontend directory - all tests pass</verify>
  <done>Currency and discount tests validate dual-price storage and calculation precision (MODEL-11, MODEL-12, MODEL-13)</done>
</task>

</tasks>

<verification>
1. currency.test.js exists at frontend/tests/model/currency.test.js
2. `npm test -- --run tests/model/currency.test.js` passes all tests
3. toBeCloseTo() used for floating-point comparisons with 2 decimal precision
4. Edge cases tested (zero price, large amounts, fractional percentages)
5. Both USD and ILS prices verified as stored on cart items
</verification>

<success_criteria>
- Dual currency storage tests verify both usdPrice and ilsPrice stored
- Discount calculation tests cover various percentages and edge cases
- Floating-point precision handled with toBeCloseTo()
- Requirements MODEL-11, MODEL-12, MODEL-13 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/18-model-unit-tests/18-04-SUMMARY.md`
</output>
