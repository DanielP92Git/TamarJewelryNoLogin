---
phase: 17-test-infrastructure-utilities
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - frontend/tests/infrastructure.test.js
  - .github/workflows/test.yml
autonomous: true

must_haves:
  truths:
    - "Infrastructure tests validate Happy-DOM environment and Testing Library queries"
    - "Infrastructure tests validate factory functions produce unique data"
    - "CI/CD runs frontend tests successfully with Happy-DOM"
  artifacts:
    - path: "frontend/tests/infrastructure.test.js"
      provides: "Comprehensive infrastructure validation tests"
      contains: ["@testing-library/dom", "createProduct", "getByRole"]
    - path: ".github/workflows/test.yml"
      provides: "Frontend test job in CI pipeline"
      contains: "test-frontend"
  key_links:
    - from: "frontend/tests/infrastructure.test.js"
      to: "frontend/tests/helpers/dom.js"
      via: "import render, screen"
      pattern: "from.*helpers/dom"
    - from: "frontend/tests/infrastructure.test.js"
      to: "frontend/tests/helpers/factories.js"
      via: "import createProduct"
      pattern: "from.*helpers/factories"
---

<objective>
Validate test infrastructure and ensure CI/CD pipeline runs frontend tests

Purpose: Confirm all infrastructure components work together (Happy-DOM + Testing Library + factories) before phases 18-22 build upon them. Verify CI/CD pipeline runs frontend tests on push/PR events.

Output: Enhanced infrastructure.test.js demonstrating all utilities, verified CI workflow
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-test-infrastructure-utilities/17-RESEARCH.md

@frontend/tests/infrastructure.test.js
@frontend/tests/helpers/dom.js
@frontend/tests/helpers/factories.js
@.github/workflows/test.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand infrastructure.test.js with comprehensive validation</name>
  <files>frontend/tests/infrastructure.test.js</files>
  <action>
Rewrite frontend/tests/infrastructure.test.js to comprehensively validate all infrastructure components.

The test file should have these describe blocks:

1. **Happy-DOM Environment** (update existing tests)
   - "should have access to document and window"
   - "should have localStorage available and functional"
   - "should clean up localStorage between tests" (verify afterEach cleanup)
   - "should clear DOM between tests" (verify beforeEach cleanup)

2. **Testing Library Integration** (new)
   - "should query by role" - use getByRole
   - "should query by text" - use getByText
   - "should query by label text" - use getByLabelText
   - "should throw when element not found" - use queryByRole (returns null)

3. **Factory Functions** (new)
   - "should create unique products with sequential IDs"
   - "should reset counter for predictable sequences"
   - "should apply overrides to products"
   - "should create cart items from products"
   - "should batch create multiple products"

4. **User Interaction Simulation** (update existing)
   - "should simulate click events"
   - "should simulate input events"
   - "should use user-event for realistic interactions" (import userEvent from @testing-library/user-event)

5. **Async DOM Utilities** (new)
   - "should wait for element to appear with waitForDOM"
   - "should reject when element not found within timeout"

Import pattern:
```javascript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, renderHTML, clearDOM, waitForDOM, simulateClick, simulateInput } from './helpers/dom.js';
import { createProduct, createProducts, createCartItem, resetFactoryCounter } from './helpers/factories.js';
import userEvent from '@testing-library/user-event';
```

Each test should be self-contained and demonstrate the utility being tested.
  </action>
  <verify>
Run `npm test` from frontend directory - all tests should pass
  </verify>
  <done>
infrastructure.test.js validates all test utilities with comprehensive test cases
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify CI/CD workflow configuration</name>
  <files>.github/workflows/test.yml</files>
  <action>
Review .github/workflows/test.yml to ensure frontend tests are properly configured.

The existing workflow already has:
- test-frontend job
- Node 20 setup
- npm ci for frontend
- npm run test:coverage
- Coverage artifact upload

Verify these are correct. If any issues found, fix them:

1. Ensure working-directory is "frontend" (not "./frontend")
2. Ensure NODE_ENV=test is set
3. Ensure cache-dependency-path points to frontend/package-lock.json

The workflow should NOT need major changes since it was set up in v1.2.

If no changes needed, document verification in summary.
  </action>
  <verify>
The workflow file should have:
- "test-frontend" job name
- "working-directory: frontend"
- "npm run test:coverage"
- NODE_ENV: test in env
  </verify>
  <done>
CI/CD workflow correctly configured for frontend tests with Happy-DOM
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify coverage</name>
  <files>N/A (verification task)</files>
  <action>
Run the full test suite with coverage to verify everything works:

```bash
cd frontend && npm run test:coverage
```

Verify:
1. All tests pass (0 failures)
2. Coverage report generates (coverage/ directory created)
3. Coverage includes js/ directory files
4. No warnings about missing Happy-DOM APIs

If tests fail, diagnose and fix issues in the appropriate files.

Document the test results:
- Number of tests passed
- Coverage percentage (informational)
- Any warnings or issues resolved
  </action>
  <verify>
`npm run test:coverage` exits with code 0, coverage report exists in frontend/coverage/
  </verify>
  <done>
All infrastructure tests pass, coverage report generates successfully
  </done>
</task>

</tasks>

<verification>
Final verification checklist:

1. Happy-DOM environment works:
```bash
cd frontend && npm test -- --reporter=verbose
```
Output should show "Environment: happy-dom" or tests using Happy-DOM APIs

2. All tests pass:
```bash
cd frontend && npm test
```
Expected: All tests pass (target: 10+ tests covering all infrastructure)

3. Coverage generates:
```bash
cd frontend && npm run test:coverage
```
Expected: coverage/ directory with HTML report

4. CI/CD simulation (optional local verification):
```bash
cd frontend && NODE_ENV=test npm run test:coverage
```
Expected: Same results as CI would produce
</verification>

<success_criteria>
1. infrastructure.test.js has 10+ tests covering all utilities
2. All tests pass with Happy-DOM environment
3. Testing Library queries (getByRole, getByText) work
4. Factory functions create unique products
5. Coverage report generates successfully
6. CI/CD workflow is correctly configured
</success_criteria>

<output>
After completion, create `.planning/phases/17-test-infrastructure-utilities/17-03-SUMMARY.md`
</output>
