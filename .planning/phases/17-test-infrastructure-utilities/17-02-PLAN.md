---
phase: 17-test-infrastructure-utilities
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - frontend/package.json
  - frontend/tests/helpers/dom.js
  - frontend/tests/helpers/factories.js
autonomous: true

must_haves:
  truths:
    - "Semantic DOM queries are available via @testing-library/dom"
    - "Factory functions create unique test products with predictable sequences"
    - "Tests can use getByRole, getByText for resilient DOM queries"
  artifacts:
    - path: "frontend/tests/helpers/dom.js"
      provides: "Testing Library query integration"
      contains: "@testing-library/dom"
      exports: ["render", "screen"]
    - path: "frontend/tests/helpers/factories.js"
      provides: "Test data factories"
      exports: ["createProduct", "createCartItem", "resetFactoryCounter"]
    - path: "frontend/package.json"
      provides: "@testing-library/dom dependency"
      contains: "@testing-library/dom"
  key_links:
    - from: "frontend/tests/helpers/dom.js"
      to: "@testing-library/dom"
      via: "import statement"
      pattern: "from '@testing-library/dom'"
    - from: "frontend/tests/helpers/factories.js"
      to: "test files"
      via: "import in test files"
      pattern: "createProduct|createCartItem"
---

<objective>
Create reusable test utilities with semantic DOM queries and data factories

Purpose: Establish patterns that phases 18-22 will use for DOM testing and test data generation. Semantic queries (getByRole, getByText) are more resilient to markup changes than querySelector. Factory functions ensure unique test data without ID collisions.

Output: Enhanced dom.js with Testing Library integration, new factories.js with product/cart factories, infrastructure tests demonstrating usage
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-test-infrastructure-utilities/17-RESEARCH.md

@frontend/tests/helpers/dom.js
@frontend/tests/infrastructure.test.js
@backend/tests/helpers/factories.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add @testing-library/dom dependency</name>
  <files>frontend/package.json</files>
  <action>
Add @testing-library/dom@10.4.0 to frontend/package.json devDependencies.

Run `npm install` from frontend directory after updating package.json.

Note: @testing-library/user-event was already updated in Plan 01. This plan adds the core DOM query library.
  </action>
  <verify>
Run `npm ls @testing-library/dom` from frontend directory - should show @testing-library/dom@10.4.0
  </verify>
  <done>
@testing-library/dom 10.4.0 installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance dom.js with Testing Library integration</name>
  <files>frontend/tests/helpers/dom.js</files>
  <action>
Rewrite frontend/tests/helpers/dom.js to integrate @testing-library/dom while keeping existing utilities.

The file should:
1. Import from @testing-library/dom: getQueriesForElement, screen, within
2. Keep existing renderHTML, clearDOM, waitForDOM functions
3. Add new `render(html)` function that returns queries bound to document.body
4. Export a `screen` object for global queries (convenience)
5. Keep simulateClick and simulateInput (they're still useful for simple cases)
6. Remove mockLocalStorage (Happy-DOM provides real localStorage)

Pattern:
```javascript
import { getQueriesForElement, screen as tScreen } from '@testing-library/dom';

/**
 * Renders HTML and returns Testing Library queries
 * @param {string} html - HTML string to render
 * @returns {Object} Object with all query methods bound to document.body
 */
export function render(html) {
  document.body.innerHTML = html;
  return {
    ...getQueriesForElement(document.body),
    container: document.body
  };
}

// Re-export screen for convenience
export const screen = tScreen;
```

Keep backward compatibility: existing renderHTML should still work.
  </action>
  <verify>
The file should export: render, renderHTML, clearDOM, waitForDOM, simulateClick, simulateInput, screen
  </verify>
  <done>
dom.js provides both legacy functions and Testing Library queries
  </done>
</task>

<task type="auto">
  <name>Task 3: Create factories.js for test data generation</name>
  <files>frontend/tests/helpers/factories.js</files>
  <action>
Create frontend/tests/helpers/factories.js following the backend pattern but adapted for frontend (no mongoose, no bcrypt).

The file should provide:

```javascript
/**
 * Factory functions for creating unique frontend test data.
 * Use factories when you need fresh, unique data for each test.
 */

let counter = 0;

/**
 * Reset counter for predictable sequences.
 * Call in beforeEach for tests that depend on specific IDs.
 */
export function resetFactoryCounter() {
  counter = 0;
}

/**
 * Create a unique product matching frontend Product shape.
 * @param {Object} overrides - Properties to override defaults
 * @returns {Object} Product data
 */
export function createProduct(overrides = {}) {
  counter++;
  return {
    id: 1000 + counter,
    name: `Test Product ${counter}`,
    description: `Description for test product ${counter}`,
    usd_price: 50 + counter,
    ils_price: (50 + counter) * 3.7,
    category: 'necklaces',
    images: [
      {
        desktop: `products/test-product-${counter}-desktop.jpg`,
        mobile: `products/test-product-${counter}-mobile.jpg`
      }
    ],
    quantity: 10,
    sku: `T${counter.toString().padStart(3, '0')}`,
    displayOrder: counter * 10,
    available: true,
    ...overrides
  };
}

/**
 * Create multiple products in batch.
 * @param {number} count - Number of products to create
 * @param {Object} commonOverrides - Overrides applied to all products
 */
export function createProducts(count, commonOverrides = {}) {
  return Array.from({ length: count }, () => createProduct(commonOverrides));
}

/**
 * Create a cart item for localStorage cart format.
 * Frontend cart format: { productId: { quantity, price, name, ... } }
 * @param {Object} product - Product object
 * @param {number} quantity - Quantity in cart
 */
export function createCartItem(product, quantity = 1) {
  return {
    id: product.id,
    name: product.name,
    quantity,
    price: product.usd_price,
    image: product.images[0]?.desktop || ''
  };
}

/**
 * Create a full cart with multiple items.
 * @param {Array<{product: Object, quantity: number}>} items
 * @returns {Array} Cart array for localStorage
 */
export function createCart(items) {
  return items.map(({ product, quantity }) => createCartItem(product, quantity));
}

/**
 * Create mock exchange rate settings.
 * @param {number} rate - USD to ILS rate
 */
export function createExchangeRate(rate = 3.70) {
  return {
    exchangeRate: rate,
    exchangeRateUpdatedAt: new Date().toISOString()
  };
}
```

Note: Match the frontend cart structure (from model.js analysis) - may need adjustment based on actual cart format.
  </action>
  <verify>
Check factories.js exists and exports:
- createProduct, createProducts, createCartItem, createCart, createExchangeRate, resetFactoryCounter
  </verify>
  <done>
factories.js provides product and cart factories matching frontend data shapes
  </done>
</task>

</tasks>

<verification>
1. Run test suite to ensure existing tests still pass:
```bash
cd frontend && npm test
```

2. Create a quick verification test to confirm factories and queries work (optional - can be done in infrastructure.test.js update):
```javascript
import { render, screen } from './helpers/dom.js';
import { createProduct, resetFactoryCounter } from './helpers/factories.js';

it('should use semantic queries', () => {
  const { getByRole } = render('<button>Add to Cart</button>');
  expect(getByRole('button', { name: /add to cart/i })).toBeDefined();
});

it('should create unique products', () => {
  resetFactoryCounter();
  const p1 = createProduct();
  const p2 = createProduct();
  expect(p1.id).not.toBe(p2.id);
});
```
</verification>

<success_criteria>
1. @testing-library/dom is installed
2. dom.js exports render() with Testing Library queries
3. factories.js exports createProduct, createCartItem, resetFactoryCounter
4. All existing tests pass
5. Semantic queries (getByRole, getByText) work in tests
</success_criteria>

<output>
After completion, create `.planning/phases/17-test-infrastructure-utilities/17-02-SUMMARY.md`
</output>
