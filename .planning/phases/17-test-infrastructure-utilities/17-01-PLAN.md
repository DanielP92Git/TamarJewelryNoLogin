---
phase: 17-test-infrastructure-utilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/vitest.config.js
  - frontend/tests/setup.js
autonomous: true

must_haves:
  truths:
    - "Vitest runs with Happy-DOM environment instead of jsdom"
    - "localStorage is cleared between tests preventing state pollution"
    - "Tests pass with Happy-DOM environment"
  artifacts:
    - path: "frontend/vitest.config.js"
      provides: "Happy-DOM environment configuration"
      contains: "environment: 'happy-dom'"
    - path: "frontend/tests/setup.js"
      provides: "State cleanup hooks"
      contains: "localStorage.clear()"
    - path: "frontend/package.json"
      provides: "Happy-DOM dependency"
      contains: "happy-dom"
  key_links:
    - from: "frontend/vitest.config.js"
      to: "frontend/tests/setup.js"
      via: "setupFiles configuration"
      pattern: "setupFiles.*setup\\.js"
---

<objective>
Configure Vitest to use Happy-DOM instead of jsdom for 2-3x performance improvement

Purpose: Establish the browser environment foundation for all frontend tests (phases 18-22). Happy-DOM provides faster test execution while maintaining sufficient browser API coverage for DOM testing.

Output: Updated vitest.config.js with Happy-DOM, updated package.json with new dependencies, enhanced setup.js with robust state cleanup
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-test-infrastructure-utilities/17-RESEARCH.md

@frontend/vitest.config.js
@frontend/package.json
@frontend/tests/setup.js
@frontend/tests/infrastructure.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update package.json dependencies</name>
  <files>frontend/package.json</files>
  <action>
Update frontend/package.json to:
1. Remove jsdom from devDependencies (line ~53)
2. Add happy-dom@20.0.11 to devDependencies
3. Update @testing-library/jest-dom from ^5.17.0 to ^6.6.3 (move to devDependencies if in dependencies)
4. Keep @testing-library/user-event (upgrade from ^13.5.0 to ^14.5.2 for Happy-DOM compatibility)

The dependencies section should have @testing-library/jest-dom removed (it will go to devDependencies).
The devDependencies should include:
- "happy-dom": "^20.0.11" (replacing jsdom)
- "@testing-library/jest-dom": "^6.6.3"
- "@testing-library/user-event": "^14.5.2"

Do NOT add @testing-library/dom yet - that's Plan 02.

After modifying package.json, run `npm install` from the frontend directory to update package-lock.json.
  </action>
  <verify>
Run from frontend directory:
- `npm ls happy-dom` shows happy-dom@20.0.11
- `npm ls jsdom` shows "(empty)" or "not found"
- `npm ls @testing-library/jest-dom` shows @testing-library/jest-dom@6.6.3
  </verify>
  <done>
Happy-DOM 20.0.11 installed, jsdom removed, @testing-library packages updated to Happy-DOM-compatible versions
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Vitest configuration for Happy-DOM</name>
  <files>frontend/vitest.config.js</files>
  <action>
Update frontend/vitest.config.js to:
1. Change `environment: 'jsdom'` to `environment: 'happy-dom'`
2. Keep all other configuration the same (test patterns, coverage, timeouts)

The change is minimal - just the environment property value.
  </action>
  <verify>
Run `npx vitest run` from frontend directory - should show "Environment: happy-dom" in output or run successfully
  </verify>
  <done>
vitest.config.js uses happy-dom environment
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance setup.js for Happy-DOM compatibility</name>
  <files>frontend/tests/setup.js</files>
  <action>
Update frontend/tests/setup.js to:
1. Update the file header comment to mention Happy-DOM instead of jsdom
2. Keep the existing beforeEach and afterEach hooks (they already handle cleanup correctly)
3. Add vi.fn() wrapper for window.scrollTo mock (use `vi` from vitest instead of bare function)
4. Improve the window.location mock to use vi.fn() for better test introspection
5. Add comment explaining Happy-DOM's built-in localStorage (no mock needed)

The mock pattern should be:
```javascript
import { beforeEach, afterEach, vi } from 'vitest';

// window.scrollTo mock
window.scrollTo = vi.fn();

// window.location mock with vi.fn() wrappers
delete window.location;
window.location = {
  href: '',
  pathname: '/',
  search: '',
  hash: '',
  assign: vi.fn(),
  reload: vi.fn(),
  replace: vi.fn()
};
```

This allows tests to assert on navigation calls: `expect(window.location.assign).toHaveBeenCalledWith('/cart')`
  </action>
  <verify>
Run `npx vitest run` from frontend directory - existing infrastructure.test.js should pass
  </verify>
  <done>
setup.js uses vi.fn() for mocks, all existing tests pass with Happy-DOM
  </done>
</task>

</tasks>

<verification>
Run full test suite from frontend directory:
```bash
cd frontend && npm test
```

Expected output:
- All tests in tests/infrastructure.test.js pass
- No "jsdom" references in test output
- Happy-DOM environment used (visible in verbose output or config)

Run with coverage to verify coverage still works:
```bash
cd frontend && npm run test:coverage
```
</verification>

<success_criteria>
1. `npm test` passes in frontend directory
2. Happy-DOM 20.0.11 is installed (not jsdom)
3. vitest.config.js shows `environment: 'happy-dom'`
4. setup.js uses vi.fn() for window mocks
5. Coverage report generates successfully
</success_criteria>

<output>
After completion, create `.planning/phases/17-test-infrastructure-utilities/17-01-SUMMARY.md`
</output>
