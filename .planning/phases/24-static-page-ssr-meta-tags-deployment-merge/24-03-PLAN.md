---
phase: 24-static-page-ssr-meta-tags-deployment-merge
plan: 03
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - backend/views/pages/home.ejs
  - backend/routes/ssr.js
  - backend/index.js
autonomous: true

must_haves:
  truths:
    - "Visiting /en returns fully-rendered HTML with home page content including featured products from the database"
    - "Visiting /he returns Hebrew home page with RTL direction"
    - "Home page source contains Organization JSON-LD structured data with name, logo, contactPoint, and sameAs"
    - "Home page source shows unique title, meta description, canonical, OG tags, and hreflang"
    - "Product names and prices are visible in the HTML source (not injected by JavaScript)"
  artifacts:
    - path: "backend/views/pages/home.ejs"
      provides: "SSR home page template"
      contains: "application/ld+json"
    - path: "backend/routes/ssr.js"
      provides: "Home page route handler (added to existing module)"
      exports: ["renderHomePage"]
  key_links:
    - from: "backend/routes/ssr.js"
      to: "backend/models/Product"
      via: "Product.find() to fetch featured products"
      pattern: "Product\\.find"
    - from: "backend/views/pages/home.ejs"
      to: "Organization JSON-LD"
      via: "script type=application/ld+json"
      pattern: "application/ld\\+json"
    - from: "backend/index.js"
      to: "backend/routes/ssr.js"
      via: "app.get('/:lang(en|he)/', languageMiddleware, renderHomePage)"
      pattern: "renderHomePage"
---

<objective>
Create the SSR home page template with featured products from MongoDB, Organization JSON-LD structured data, and full SEO meta tags.

Purpose: The home page is the primary landing page for SEO. It needs server-rendered product data so search engines index actual products, and Organization structured data for Knowledge Graph eligibility.
Output: home.ejs template, renderHomePage route handler, route wired into Express
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-static-page-ssr-meta-tags-deployment-merge/24-RESEARCH.md
@.planning/phases/24-static-page-ssr-meta-tags-deployment-merge/24-01-SUMMARY.md
@frontend/index.html
@frontend/js/Views/homePageView.js
@frontend/js/View.js
@backend/models/Product.js
@backend/routes/ssr.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create home page EJS template with Organization JSON-LD</name>
  <files>backend/views/pages/home.ejs</files>
  <action>
Create `backend/views/pages/home.ejs` that renders the full home page matching the structure in frontend/index.html.

Template structure:
```
<!DOCTYPE html>
<html lang="<%= urlLang %>" dir="<%= dir %>">
<head>
  <%- include('../partials/meta-tags', { title, description, canonical, ogImage, lang, urlLang, alternateUrl, baseUrl, pageStyles }) %>

  <!-- Organization JSON-LD structured data (SCHEMA-04) -->
  <script type="application/ld+json">
  <%- JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Tamar Kfir Jewelry",
    "url": baseUrl,
    "logo": baseUrl + "/imgs/icons/favicon.png",
    "description": lang === 'eng' ? "Handmade jewelry crafted with love in Jerusalem" : "תכשיטים בעבודת יד מירושלים",
    "contactPoint": {
      "@type": "ContactPoint",
      "contactType": "Customer Service",
      "availableLanguage": ["English", "Hebrew"]
    },
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Jerusalem",
      "addressCountry": "IL"
    },
    "sameAs": [
      "https://www.instagram.com/tamar_kfir_jewelry/",
      "https://www.facebook.com/tamarkfirjewelry"
    ]
  }, null, 2) %>
  </script>

  <script type="module" defer src="/js/controller.js"></script>
  <!-- Microsoft Clarity -->
</head>
<body>
  <%- include('../partials/header', { lang, dir, urlLang }) %>
  <main>
    <!-- Hero/banner section matching existing frontend structure -->
    <!-- Featured products grid rendered server-side -->
  </main>
  <%- include('../partials/footer', { lang, urlLang }) %>
</body>
</html>
```

CRITICAL: Study frontend/index.html body structure and frontend/js/Views/homePageView.js to understand the exact HTML that the home page renders. The SSR template must produce the same DOM structure with the same CSS classes so existing stylesheets work.

Look at the home page JS to understand:
- What elements exist in the static HTML (hero section, product grid containers, etc.)
- What content the JS dynamically populates (product cards, category links, language-dependent text)
- For SSR: Render the product grid with actual product data from the `products` variable passed by the route handler

For the product grid, render each product as:
```ejs
<% products.forEach(product => { %>
  <article class="product-card" data-ssr="true">
    <img src="<%= product.mainImage || product.images[0] %>"
         alt="<%= product.name[lang] || product.name.eng %>"
         loading="lazy">
    <h3><%= product.name[lang] || product.name.eng %></h3>
    <p class="price"><%= product.price %> <%= currency %></p>
  </article>
<% }); %>
```

Adapt the exact class names and structure from what the existing frontend JS creates. The `data-ssr="true"` attribute signals to client-side JS that this content was server-rendered (Phase 25 will use this flag).

Home page CSS: standard-reset.css, desktop-menu.css, home-mobile.css (max-width: 799.9px), home-800plus.css (min-width: 800px), footer-desktop.css (min-width: 800px), footer-mobile.css (max-width: 799.9px), mobile-menu.css (max-width: 799.9px). Check actual filenames in frontend/css/.

For the Organization JSON-LD:
- Use <%- %> (unescaped) for the JSON.stringify output since it's trusted data we construct
- Verify social media URLs are correct (check the actual Instagram/Facebook handles from the project)
- Include contactPoint with email if available from project config, or omit email and just use contactType
  </action>
  <verify>Inspect the template for valid EJS syntax, correct JSON-LD structure, proper CSS class names matching frontend HTML.</verify>
  <done>Home page template renders full HTML with product grid, Organization JSON-LD, and all meta tags</done>
</task>

<task type="auto">
  <name>Task 2: Create home page route handler and wire into Express</name>
  <files>backend/routes/ssr.js, backend/index.js</files>
  <action>
Add `renderHomePage` to backend/routes/ssr.js:

1. Import the Product model: `const Product = require('../models/Product');`
2. The handler is async (needs DB query):
   ```javascript
   async function renderHomePage(req, res) {
     const lang = req.params.lang; // 'en' or 'he'
     const langKey = lang === 'he' ? 'heb' : 'eng';
     const dir = langKey === 'heb' ? 'rtl' : 'ltr';
     const meta = metaConfig.home[langKey];
     const baseUrl = process.env.BASE_URL || 'https://tamarkfir.online';

     // Fetch featured/visible products
     // Check the Product model schema to understand query fields
     // Likely: Product.find({ active: true }).sort({ displayOrder: 1 }).limit(20)
     let products = [];
     try {
       products = await Product.find({ active: true })
         .sort({ displayOrder: 1 })
         .lean();
     } catch (err) {
       console.error('SSR home: failed to load products', err);
       // Render page without products rather than crash
     }

     // Determine currency from cookie or default
     const currency = langKey === 'heb' ? 'ILS' : 'USD';

     res.render('pages/home', {
       lang: langKey,
       urlLang: lang,
       dir,
       title: meta.title,
       description: meta.description,
       canonical: `${baseUrl}/${lang}`,
       ogImage: `${baseUrl}/imgs/website-images/og-default.jpg`,
       baseUrl,
       alternateUrl: { en: `${baseUrl}/en`, he: `${baseUrl}/he` },
       pageStyles: [
         { href: '/css/standard-reset.css' },
         { href: '/css/desktop-menu.css' },
         { href: '/css/home-mobile.css', media: '(max-width: 799.9px)' },
         { href: '/css/home-800plus.css', media: '(min-width: 800px)' },
         { href: '/css/footer-desktop.css', media: '(min-width: 800px)' },
         { href: '/css/footer-mobile.css', media: '(max-width: 799.9px)' },
         { href: '/css/mobile-menu.css', media: '(max-width: 799.9px)' }
       ],
       products,
       currency
     });
   }
   ```

IMPORTANT: Check the actual Product model schema (backend/models/Product.js) to confirm:
- The field name for active/visible products (might be `active`, `visible`, `published`, etc.)
- The field name for images (mainImage, images, galleryImages)
- The field name for bilingual names (name.eng, name.heb or name.en, name.he)
- The field for display ordering (displayOrder, order, sortOrder)
- Adjust the query and template variable access accordingly.

Add renderHomePage to module.exports.

In backend/index.js, register the home page route:
```javascript
app.get('/:lang(en|he)', languageMiddleware, renderHomePage);
```

Place this AFTER the static page routes (about, contact, etc.) to avoid any URL conflicts. The `:lang(en|he)` without trailing content matches exactly /en and /he.

IMPORTANT: This route must be registered carefully. The root redirect handler already handles `/` -> `/en` or `/he`. This route handles the actual /en and /he pages. Check the existing code to ensure no conflict. The route pattern `/:lang(en|he)` (without slash) should work alongside `/:lang(en|he)/about` etc.
  </action>
  <verify>
Start the backend dev server and test:
- `curl -s http://localhost:4000/en | head -40` — should show home page HTML with meta tags and product data
- `curl -s http://localhost:4000/he | head -40` — should show Hebrew home page
- `curl -s http://localhost:4000/en | grep "application/ld+json"` — should find JSON-LD script tag
- `curl -s http://localhost:4000/en | grep "og:title"` — should find OG tags
- `curl -s http://localhost:4000/en | grep "hreflang"` — should find 3 hreflang links
- `curl -s http://localhost:4000/en | grep "canonical"` — should show canonical URL
- Run existing test suite: `cd backend && npx vitest run` — all tests pass
  </verify>
  <done>Home page renders at /en and /he with products from database, Organization JSON-LD, full meta tags, and no test regressions</done>
</task>

</tasks>

<verification>
- /en and /he return 200 with fully-rendered home page HTML
- Product names and prices visible in HTML source
- Organization JSON-LD present with @context, @type, name, url, logo, contactPoint, sameAs
- Unique title and meta description for home page in both languages
- Canonical, OG tags, Twitter Card tags, and 3 hreflang links present
- Hebrew version has dir="rtl" and Hebrew content
- Page gracefully handles empty product list (no crash if DB is empty)
- All existing tests pass
</verification>

<success_criteria>
Home page is fully SSR-rendered with database products, Organization structured data, and complete SEO metadata in both languages.
</success_criteria>

<output>
After completion, create `.planning/phases/24-static-page-ssr-meta-tags-deployment-merge/24-03-SUMMARY.md`
</output>
