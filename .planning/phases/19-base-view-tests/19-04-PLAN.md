---
phase: 19-base-view-tests
plan: 04
type: execute
wave: 2
depends_on:
  - 19-01
  - 19-02
files_modified:
  - frontend/tests/view/cleanup.test.js
autonomous: true

must_haves:
  truths:
    - "Flag click handlers do not accumulate on repeated language switches"
    - "Menu innerHTML replacement destroys old elements and their listeners"
    - "Element cloning pattern removes old event listeners before adding new ones"
    - "Currency event delegation on document level persists correctly (single listener)"
    - "No duplicate actions fire from a single user interaction after multiple language switches"
  artifacts:
    - path: "frontend/tests/view/cleanup.test.js"
      provides: "Event listener cleanup and memory leak prevention tests (VIEW-11)"
      min_lines: 80
  key_links:
    - from: "frontend/tests/view/cleanup.test.js"
      to: "frontend/js/View.js"
      via: "import View from '../../js/View.js'"
      pattern: "import.*View.*from.*View\\.js"
    - from: "frontend/tests/view/cleanup.test.js"
      to: "frontend/tests/helpers/dom.js"
      via: "render() for DOM setup, simulateClick() for event simulation"
      pattern: "import.*render.*simulateClick.*from.*dom"
---

<objective>
Create event listener cleanup and memory leak prevention tests covering VIEW-11.

Purpose: Validate that View.js does not accumulate event listeners on repeated language/currency switches. View.js uses three cleanup strategies: (1) innerHTML replacement to destroy old menu elements, (2) element cloning via cloneNode(true) + replaceChild to drop old listeners, and (3) document-level event delegation for currency that only initializes once. Tests verify observable behavior (no duplicate actions) rather than listener internals.

Output: frontend/tests/view/cleanup.test.js with tests proving that repeated language switches, flag clicks, and currency changes produce exactly one action per user interaction.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-base-view-tests/19-RESEARCH.md
@.planning/phases/19-base-view-tests/19-01-SUMMARY.md
@.planning/phases/19-base-view-tests/19-02-SUMMARY.md
@frontend/js/View.js
@frontend/tests/setup.js
@frontend/tests/helpers/dom.js
@frontend/vitest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create event listener cleanup tests</name>
  <files>frontend/tests/view/cleanup.test.js</files>
  <action>
Create event listener cleanup tests covering VIEW-11.

**CRITICAL NOTES:**
- Happy-DOM does NOT provide listener introspection APIs (getEventListeners is Chrome DevTools-only). Tests MUST verify observable behavior, not listener counts.
- View.js uses three cleanup strategies:
  1. `menu.innerHTML = this.handleMenuLanguage(lng)` (line 736) - destroys all menu children and their listeners
  2. `cloneNode(true) + replaceChild` (lines 161-163, 401-406, 493-495, 853-854) - creates a new element without the old event listeners
  3. `initCurrencyPersistence()` with `window.__currencyPersistenceInitialized` guard (lines 42-44) - ensures document-level listener added only once
- The key test strategy: perform an action multiple times, then verify it only fires once per click/change.

**Import pattern:**
```javascript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { render, simulateClick } from '../helpers/dom.js';
import View from '../../js/View.js';
```

**Required DOM fixture:**
```html
<header></header>
<div class="menu"></div>
<div data-purpose="header-utilities"></div>
<div class="footer"></div>
```

**Test structure:**

a) `describe('Menu innerHTML Replacement Cleanup')` - Old menu elements are destroyed on language switch
   - Create view, await setLanguage('eng', 0)
   - Query a menu link element (e.g., the Home link)
   - Store a reference to the old element
   - Switch language: await setLanguage('heb', 0)
   - Query for the old element -- it should NOT be in the document anymore
   - Verify: `document.contains(oldElement)` is false
   - Verify: new elements are present with Hebrew text
   - This proves innerHTML replacement destroys old DOM nodes (and their attached listeners)

b) `describe('Flag Click Handlers - No Accumulation')` - Repeated language switches don't duplicate flag handlers
   - Create view, switch languages multiple times:
     ```
     await view.setLanguage('eng', 0);
     await view.setLanguage('heb', 0);
     await view.setLanguage('eng', 0);
     await view.setLanguage('heb', 0);
     await view.setLanguage('eng', 0);
     ```
   - Spy on localStorage.setItem with `vi.spyOn(Storage.prototype, 'setItem')`
   - Clear the spy call count
   - Find a Hebrew flag icon in the desktop selector and click it (simulateClick)
   - Verify localStorage.setItem was called with ('language', 'heb') exactly ONCE
   - This proves flag click handlers don't accumulate -- each setLanguage() creates new elements with fresh handlers, destroying old ones via innerHTML replacement

c) `describe('Currency Event Delegation - Single Listener')` - Currency change fires event exactly once
   - Create view, switch languages multiple times
   - Add a vi.fn() listener for 'currency-changed' on window
   - Find a currency selector, change value to 'ils', dispatch change event
   - Verify the 'currency-changed' handler was called exactly ONCE
   - This proves the document-level event delegation pattern doesn't duplicate

d) `describe('Currency Selector - No Duplicate Actions')` - Changing currency after multiple language switches
   - Set localStorage currency to 'usd'
   - Create view, switch languages 3 times: eng -> heb -> eng
   - Change currency selector to 'ils' and dispatch change event
   - Verify localStorage.getItem('currency') === 'ils'
   - Verify only ONE 'currency-changed' event was dispatched
   - Change back to 'usd', verify only ONE more event
   - This proves the currency persistence system is robust across re-renders

e) `describe('Categories Tab - Cloning Cleanup')` - Categories tab listener cleanup via cloneNode
   - After setLanguage(), verify `.categories-tab` exists
   - Switch language again (which triggers cloneNode replacement of categories tab)
   - Verify new `.categories-tab` exists
   - The test verifies that the element is replaced (new node reference) while preserving structure
   - Note: Don't test actual hover/click behavior of categories here since it requires matchMedia mock

f) `describe('Mobile Menu SVG Handler - Cleanup on Re-render')` - Mobile menu toggle doesn't accumulate
   - setLanguage calls svgHandler() via setTimeout(0) (line 916-917)
   - After multiple language switches, verify that `.menubars-svg` if present works correctly
   - NOTE: svgHandler() may not find `.menubars-svg` in minimal test fixtures. If so, document this as "svgHandler safely handles missing elements" (line 508: `console.error('[View] Menu bars button not found')`)
   - Test that repeated setLanguage calls don't throw errors even without .menubars-svg

g) `describe('View Instance Reuse Safety')` - Same View instance handles multiple language cycles
   - Create ONE View instance
   - Cycle through: eng -> heb -> eng -> heb -> eng (5 switches)
   - After each switch, verify basic DOM integrity: menu has links, footer has content
   - Verify no errors thrown (the test simply not failing proves this)
   - This is an integration-level cleanup test ensuring repeated use doesn't degrade

**afterEach cleanup:**
```javascript
afterEach(() => {
  delete window.__currencyPersistenceInitialized;
  vi.restoreAllMocks(); // Restore any spied-on methods
});
```

**Important pattern for spy on localStorage.setItem:**
```javascript
const setItemSpy = vi.spyOn(Storage.prototype, 'setItem');
// ... perform actions ...
const langCalls = setItemSpy.mock.calls.filter(([key]) => key === 'language');
expect(langCalls).toHaveLength(1);
// MUST restore after test
setItemSpy.mockRestore();
```

**Important: Allow setTimeout to run**
View.js line 916 calls `setTimeout(() => { this.svgHandler(); ... }, 0)`. After `await view.setLanguage()`, the Promise resolves but the setTimeout hasn't fired yet. Use `await new Promise(r => setTimeout(r, 50))` or `await vi.advanceTimersByTimeAsync(0)` to flush pending timers if testing svgHandler behavior. For most cleanup tests, this isn't needed since we're testing observable DOM state after setLanguage's synchronous operations.

Target: At least 8 tests covering VIEW-11 through behavioral verification.
  </action>
  <verify>Run `npm test -- --run tests/view/cleanup.test.js` from frontend directory - all tests pass</verify>
  <done>Event listener cleanup tests validate VIEW-11 through observable behavioral verification</done>
</task>

</tasks>

<verification>
1. Test file exists at frontend/tests/view/cleanup.test.js
2. `npm test -- --run tests/view/cleanup.test.js` passes all tests
3. Tests verify old DOM elements are destroyed on innerHTML replacement
4. Tests verify flag click handlers don't accumulate across language switches
5. Tests verify currency event fires exactly once per change
6. Tests verify categories tab element is replaced (cloneNode pattern)
7. Tests verify View instance handles multiple language cycles without degradation
8. All existing tests still pass (run full suite to confirm)
</verification>

<success_criteria>
- Observable behavior tests prove no duplicate event firings
- DOM node replacement verified via document.contains() check
- Currency event delegation fires exactly once per change
- localStorage updates happen exactly once per flag click
- View instance survives 5+ language switches without errors
- At least 8 tests passing
- No regression in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/19-base-view-tests/19-04-SUMMARY.md`
</output>
