---
phase: 19-base-view-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tests/view/currency.test.js
autonomous: true

must_haves:
  truths:
    - "Currency selector renders with USD and ILS options in English"
    - "Currency selector renders with Hebrew labels (דולר/שקל) in Hebrew"
    - "Changing currency from USD to ILS updates localStorage"
    - "Changing currency from ILS to USD updates localStorage"
    - "Currency change dispatches 'currency-changed' CustomEvent with detail"
    - "Currency selector preserves saved value across language switches"
  artifacts:
    - path: "frontend/tests/view/currency.test.js"
      provides: "Currency selector rendering and switching tests (VIEW-05 through VIEW-08)"
      min_lines: 100
  key_links:
    - from: "frontend/tests/view/currency.test.js"
      to: "frontend/js/View.js"
      via: "import View from '../../js/View.js'"
      pattern: "import.*View.*from.*View\\.js"
    - from: "frontend/tests/view/currency.test.js"
      to: "frontend/tests/helpers/dom.js"
      via: "render() for DOM setup"
      pattern: "import.*render.*from.*dom"
---

<objective>
Create currency selector rendering and switching tests covering VIEW-05 through VIEW-08.

Purpose: Validate that the currency selector renders with correct options in both languages, that switching currency updates localStorage and dispatches a custom event, and that the currency preference survives language switches (proving the event delegation architecture works).

Output: frontend/tests/view/currency.test.js with tests for currency rendering, USD-to-ILS switching, ILS-to-USD switching, and event dispatch for price recalculation.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-base-view-tests/19-RESEARCH.md
@frontend/js/View.js
@frontend/js/locale.js
@frontend/tests/setup.js
@frontend/tests/helpers/dom.js
@frontend/vitest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create currency selector and switching tests</name>
  <files>frontend/tests/view/currency.test.js</files>
  <action>
Create comprehensive currency tests covering VIEW-05 through VIEW-08.

**CRITICAL NOTES:**
- View.js module-level code (lines 42-78) initializes currency persistence with event delegation. The `initCurrencyPersistence()` function uses a `window.__currencyPersistenceInitialized` flag to run only once. This flag must be deleted in afterEach to ensure clean state.
- The document-level 'change' event listener (lines 55-72) handles ALL currency selectors via event delegation (`target.matches('select.header-currency-selector[name="currency"]')`). This listener persists across tests.
- Currency selectors are rendered twice: once in desktop utilities (`[data-purpose="header-utilities"]`) and once in mobile menu (`.mobile-lang-selector`). The selector IDs are `currency-desktop` and `currency-mobile`.
- `getCurrencySelectorMarkup(lng, id)` (lines 950-977) generates the `<select>` HTML with options. English: "Currency"/"USD"/"ILS". Hebrew: "מטבע"/"דולר"/"שקל".
- `syncCurrencySelectors(currency)` (lines 28-40) synchronizes ALL currency selectors on the page to the same value.
- `updateCurrencySelectorText(currencySelect, lng)` (lines 979-1003) changes option labels when language changes without losing selected value.

**Import pattern:**
```javascript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { render } from '../helpers/dom.js';
import View from '../../js/View.js';
```

**Required DOM fixture:**
```html
<header></header>
<div class="menu"></div>
<div data-purpose="header-utilities"></div>
<div class="footer"></div>
```

**Test structure:**

a) `describe('Currency Selector Rendering (VIEW-05)')` - Renders with USD and ILS options
   - After `await view.setLanguage('eng', 0)`:
     - Verify `select.header-currency-selector[name="currency"]` elements exist (at least 1)
     - Verify options: option[0].value === 'default', option[0].text === 'Currency'
     - Verify options: option[1].value === 'usd', option[1].text === 'USD'
     - Verify options: option[2].value === 'ils', option[2].text === 'ILS'
   - After `await view.setLanguage('heb', 0)`:
     - Verify Hebrew labels: option[0].text === 'מטבע', option[1].text === 'דולר', option[2].text === 'שקל'
     - Verify selector has dir="rtl" attribute
   - Verify both desktop and mobile selectors exist (query by ID: 'currency-desktop', 'currency-mobile')
   - Verify saved currency is reflected as selected option (set localStorage 'currency' = 'ils' before rendering, verify selector.value === 'ils')

b) `describe('Switch USD to ILS (VIEW-06)')` - Currency selector switches from USD to ILS
   - Set localStorage currency to 'usd' beforeEach
   - After rendering with `await view.setLanguage('eng', 0)`:
     - Find the currency selector
     - Set `selector.value = 'ils'`
     - Dispatch `new Event('change', { bubbles: true })` on the selector
     - Verify `localStorage.getItem('currency')` === 'ils'

c) `describe('Switch ILS to USD (VIEW-07)')` - Currency selector switches from ILS to USD
   - Set localStorage currency to 'ils' beforeEach
   - After rendering with `await view.setLanguage('eng', 0)`:
     - Find the currency selector
     - Set `selector.value = 'usd'`
     - Dispatch `new Event('change', { bubbles: true })` on the selector
     - Verify `localStorage.getItem('currency')` === 'usd'

d) `describe('Currency Change Event (VIEW-08)')` - Currency switch triggers price recalculation signal
   - Add a `vi.fn()` listener for the 'currency-changed' custom event on window
   - After changing currency selector and dispatching 'change' event:
     - Verify the custom event handler was called
     - Verify the event detail contains `{ currency: 'ils' }` or `{ currency: 'usd' }`
   - Test that selecting 'default' option does NOT dispatch the event (lines 64-65: `if (!chosen) return;`)
   - Test that currency preference survives language switch: set ILS, switch from eng to heb, verify selector still shows ILS

**afterEach cleanup:**
```javascript
afterEach(() => {
  delete window.__currencyPersistenceInitialized;
  // Remove any custom event listeners added during tests
});
```

**Event listener cleanup pattern for currency-changed:**
```javascript
let currencyHandler;
beforeEach(() => {
  currencyHandler = vi.fn();
  window.addEventListener('currency-changed', currencyHandler);
});
afterEach(() => {
  window.removeEventListener('currency-changed', currencyHandler);
  delete window.__currencyPersistenceInitialized;
});
```

**Important: Dispatching change events correctly**
The event delegation listener on `document` (line 55) checks `e.target.matches('select.header-currency-selector[name="currency"]')`. The event MUST bubble from the actual `<select>` element. Use:
```javascript
const selector = document.querySelector('select.header-currency-selector[name="currency"]');
selector.value = 'ils';
selector.dispatchEvent(new Event('change', { bubbles: true }));
```

Target: At least 10 tests covering all four VIEW requirements.
  </action>
  <verify>Run `npm test -- --run tests/view/currency.test.js` from frontend directory - all tests pass</verify>
  <done>Currency selector rendering and switching tests validate VIEW-05, VIEW-06, VIEW-07, VIEW-08</done>
</task>

</tasks>

<verification>
1. Test file exists at frontend/tests/view/currency.test.js
2. `npm test -- --run tests/view/currency.test.js` passes all tests
3. Tests verify currency selector renders with correct options in English (VIEW-05)
4. Tests verify currency selector renders with Hebrew labels (VIEW-05)
5. Tests verify USD-to-ILS switching updates localStorage (VIEW-06)
6. Tests verify ILS-to-USD switching updates localStorage (VIEW-07)
7. Tests verify custom event dispatch on currency change (VIEW-08)
8. Tests verify currency preference survives language switches (VIEW-08)
9. All existing tests still pass
</verification>

<success_criteria>
- Currency selector renders with 3 options (default, usd, ils) in both languages
- Switching currency updates localStorage immediately
- Custom 'currency-changed' event dispatched with correct detail
- Currency preference preserved across language switches
- At least 10 tests passing
- No regression in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/19-base-view-tests/19-02-SUMMARY.md`
</output>
