---
phase: 19-base-view-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tests/view/language.test.js
autonomous: true

must_haves:
  truths:
    - "Language selector renders flag icons for English and Hebrew"
    - "Switching to Hebrew sets localStorage language to 'heb'"
    - "Switching to Hebrew sets document.documentElement.lang to 'he' and dir to 'rtl'"
    - "Switching to English sets localStorage language to 'eng'"
    - "Switching to English sets document.documentElement.lang to 'en' and dir to 'ltr'"
    - "RTL layout attribute is applied on Hebrew switch and removed on English switch"
    - "Menu content re-renders with correct language text after switch"
  artifacts:
    - path: "frontend/tests/view/language.test.js"
      provides: "Language selector and switching tests (VIEW-01 through VIEW-04)"
      min_lines: 120
  key_links:
    - from: "frontend/tests/view/language.test.js"
      to: "frontend/js/View.js"
      via: "import View from '../../js/View.js'"
      pattern: "import.*View.*from.*View\\.js"
    - from: "frontend/tests/view/language.test.js"
      to: "frontend/tests/helpers/dom.js"
      via: "render() and screen for DOM setup and queries"
      pattern: "import.*render.*from.*dom"
---

<objective>
Create language selector and switching tests covering VIEW-01 through VIEW-04.

Purpose: Validate that the language selector renders both English and Hebrew flag options, that switching languages updates localStorage, document attributes (lang/dir), and that RTL layout is correctly toggled. This is the first View layer test file and establishes the pattern for instantiating View in tests.

Output: frontend/tests/view/language.test.js with tests for language rendering, English-to-Hebrew switching, Hebrew-to-English switching, and RTL layout changes.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-base-view-tests/19-RESEARCH.md
@frontend/js/View.js
@frontend/js/locale.js
@frontend/tests/setup.js
@frontend/tests/helpers/dom.js
@frontend/tests/helpers/factories.js
@frontend/vitest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create the view test directory</name>
  <files>frontend/tests/view/</files>
  <action>
Create the `frontend/tests/view/` directory if it does not already exist. This directory will contain all View layer tests for Phase 19.
  </action>
  <verify>Directory frontend/tests/view/ exists</verify>
  <done>View test directory is available for test files</done>
</task>

<task type="auto">
  <name>Task 2: Create language selector and switching tests</name>
  <files>frontend/tests/view/language.test.js</files>
  <action>
Create comprehensive language tests covering VIEW-01 through VIEW-04.

**CRITICAL SETUP NOTES:**
- View.js has module-level code (lines 76-78) that initializes currency persistence on import. This is expected and safe -- it adds a document-level event listener that uses event delegation.
- View.js constructor (lines 82-98) queries DOM elements like `.menu`, `header`, `.footer`. These MUST exist before `new View()` is called.
- `setLanguage()` is async (line 695). ALWAYS await it.
- `changeToHeb()` and `changeToEng()` call `this.setLanguage()` internally but do NOT await it (lines 565, 588). The test must use setTimeout or await the promise indirectly.
- After `setLanguage()`, the `.menu` innerHTML is completely replaced (line 736). Query elements AFTER the call, not before.
- View.js imports SVG files and `* as model` from model.js. Vitest handles SVG imports as string paths by default. model.js has `require('dotenv').config()` but this works in the test environment (proven by Phase 18 tests).
- The `window.__currencyPersistenceInitialized` flag from View.js module-level init persists across tests. Add cleanup in afterEach to reset it.

**Import pattern:**
```javascript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { render, screen } from '../helpers/dom.js';
import View from '../../js/View.js';
```

**Required DOM fixture for all View tests:**
```html
<header></header>
<div class="menu"></div>
<div data-purpose="header-utilities"></div>
<div class="footer"></div>
```
This minimal structure satisfies the View constructor's querySelector calls.

**Test structure:**

a) `describe('Language Selector Rendering (VIEW-01)')` - Language selector renders with English and Hebrew options
   - After `await view.setLanguage('eng', 0)`, verify:
     - Flag icons exist: `.flag-icon.flag-eng` and `.flag-icon.flag-heb` elements are present in the DOM
     - Desktop language selector `.desktop-lang-selector` exists within `[data-purpose="header-utilities"]`
     - Mobile language selector `.mobile-lang-selector` exists within `.menu`
     - Both English and Hebrew flags are rendered in both mobile and desktop selectors
   - After `await view.setLanguage('heb', 0)`, verify similar structure exists

b) `describe('Switch to Hebrew (VIEW-02)')` - Language selector switches from English to Hebrew
   - Start with `await view.setLanguage('eng', 0)`
   - Call `view.changeToHeb()` then wait for DOM update with `await vi.advanceTimersByTimeAsync(50)` or `await new Promise(r => setTimeout(r, 50))`
   - Verify localStorage.getItem('language') === 'heb'
   - Verify Hebrew menu text appears (use screen.getByText for Hebrew strings like /בית/, /חנות/, /אודות/)
   - Verify `document.documentElement.lang` === 'he'

c) `describe('Switch to English (VIEW-03)')` - Language selector switches from Hebrew to English
   - Start with `await view.setLanguage('heb', 0)`
   - Call `view.changeToEng()` then wait for DOM update
   - Verify localStorage.getItem('language') === 'eng'
   - Verify English menu text appears (/Home/i, /Shop/i, /About/i)
   - Verify `document.documentElement.lang` === 'en'

d) `describe('RTL Layout Changes (VIEW-04)')` - Language switch triggers RTL layout changes
   - After switching to Hebrew: `document.documentElement.dir` === 'rtl'
   - After switching to English: `document.documentElement.dir` === 'ltr'
   - Verify Hebrew currency selector has `dir="rtl"` attribute
   - Verify English currency selector does NOT have `dir="rtl"`
   - Test round-trip: eng -> heb -> eng, verify dir flips correctly each time

**afterEach cleanup:**
```javascript
afterEach(() => {
  // Reset module-level currency persistence flag so it re-initializes cleanly
  delete window.__currencyPersistenceInitialized;
});
```

**Using setLanguage directly (preferred over changeToHeb/changeToEng for reliable testing):**
For VIEW-02/03/04, you can test BOTH paths:
1. The direct `await view.setLanguage('heb', 0)` path (reliable, synchronous)
2. The `changeToHeb()` / `changeToEng()` path (mimics user action but has setTimeout internally)

For the changeToHeb/changeToEng tests, use `await new Promise(r => setTimeout(r, 100))` to allow the internal setTimeout(0) in setLanguage to complete.

Target: At least 12 tests covering all four VIEW requirements.
  </action>
  <verify>Run `npm test -- --run tests/view/language.test.js` from frontend directory - all tests pass</verify>
  <done>Language selector rendering and switching tests validate VIEW-01, VIEW-02, VIEW-03, VIEW-04</done>
</task>

</tasks>

<verification>
1. Test file exists at frontend/tests/view/language.test.js
2. `npm test -- --run tests/view/language.test.js` passes all tests
3. Tests verify flag icons render for both languages (VIEW-01)
4. Tests verify English-to-Hebrew switching updates localStorage and menu content (VIEW-02)
5. Tests verify Hebrew-to-English switching updates localStorage and menu content (VIEW-03)
6. Tests verify RTL document attributes toggle correctly (VIEW-04)
7. All 97 existing tests still pass (run `npm test -- --run` to confirm no regressions)
</verification>

<success_criteria>
- Language selector rendering verified with flag icons in both mobile and desktop containers
- Language switching between eng/heb updates localStorage correctly
- Document attributes (lang, dir) update correctly for RTL/LTR
- Menu content re-renders with correct language text
- At least 12 tests passing
- No regression in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/19-base-view-tests/19-01-SUMMARY.md`
</output>
